\documentclass[reqno]{amsart}
\usepackage{url}
\usepackage{tikz}
\usetikzlibrary{decorations.pathreplacing, matrix, arrows,tikzmark}
\usepackage{enumerate}
%\usepackage{array}
\usepackage{accents}
\usepackage{tabu}
\usepackage{longtable}
%\usepackage{blkarray}
\usepackage{multirow}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{amscd}
\usepackage{amsbsy}
\usepackage{comment}
\usepackage[matrix,arrow]{xy}
\usepackage{arydshln}
%\usepackage[bookmarks,bookmarksnumbered,%
%    allbordercolors={0.8 0.8 0.8},%
%    linktocpage%
%    ]{hyperref}
%\usepackage{hyperref}
%\usepackage{showlabels}

\DeclareMathOperator{\Cl}{Cl}
\DeclareMathOperator{\Rad}{Rad}
\DeclareMathOperator{\Radp}{Rad_{\{2,5,7\}}}
\DeclareMathOperator{\Radpp}{Rad_{\{2,3,5,7\}}}
\DeclareMathOperator{\Norm}{Norm}
\DeclareMathOperator{\Disc}{Disc}
\DeclareMathOperator{\GL}{GL}
\DeclareMathOperator{\SL}{SL}
\DeclareMathOperator{\Sel}{Sel}
\DeclareMathOperator{\Ker}{Ker}
\DeclareMathOperator{\Img}{Image}
\DeclareMathOperator{\Res}{Res}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\Pic}{Pic}
\DeclareMathOperator{\red}{red}
\newcommand{\vv}{\mathbf{v}}
\DeclareMathOperator{\Div}{Div}
\DeclareMathOperator{\divisor}{div}
\DeclareMathOperator{\Alb}{Alb}
\DeclareMathOperator{\Gal}{Gal}
\DeclareMathOperator{\norm}{Norm}
\DeclareMathOperator{\trace}{Tr}
\DeclareMathOperator{\ord}{ord}
\DeclareMathOperator{\image}{im}
\DeclareMathOperator{\lcm}{lcm}
\DeclareMathOperator{\Reg}{Reg}
\DeclareMathOperator{\Aut}{Aut}
\newcommand{\crt}{\sqrt[3]{2}}
\newcommand{\bxi}{\boldsymbol{\xi}}
%\newcommand{\SHA}[1]{{\cyr X}(#1)}
%\newcommand{\p}{{\mathfrak P}}
%\newcommand{\A}{{\mathbb A}}
\newcommand{\mS}{\mathcal{S}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\Z}{\mathbb{Z}}
%\newcommand{\N}{{\mathbb N}}
\newcommand{\C}{{\mathbb C}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\F}{{\mathbb F}}
%\newcommand{\D}{{\mathbb D}}
\newcommand{\PP}{{\mathbb P}}
%\newcommand{\LL}{{\mathbb L}}
%\newcommand{\HH}{{G_{\LL}}}
\newcommand{\cS}{\mathcal{S}}
\newcommand{\cU}{\mathcal{U}}
\newcommand{\cA}{\mathcal{A}}
\newcommand{\cG}{\mathcal{G}}
\newcommand{\cB}{\mathcal{B}}
\newcommand{\cK}{\mathcal{K}}
\newcommand{\cL}{\mathcal{L}}
\newcommand{\fL}{\mathfrak{L}}
\newcommand{\cM}{\mathcal{M}}
\newcommand{\fM}{\mathfrak{M}}
\newcommand{\cN}{\mathcal{N}}
\newcommand{\cP}{\mathcal{P}}
\newcommand{\cQ}{\mathcal{Q}}
\newcommand{\fQ}{\mathfrak{Q}}
\newcommand{\cR}{\mathcal{R}}
\newcommand{\cT}{\mathcal{T}}
\newcommand{\cE}{\mathcal{E}}
\newcommand{\cJ}{{\mathcal J}}
\newcommand{\cC}{\mathcal C}
\newcommand{\cV}{\mathcal V}
\newcommand{\cW}{\mathcal W}
\newcommand{\OO}{{\mathcal O}}
\newcommand{\ga}{{\mathfrak{a}}}
\newcommand{\gb}{{\mathfrak{b}}}
\newcommand{\gc}{{\mathfrak{c}}}
\newcommand{\pic}{{\rm Pic}^0(Y)}
\newcommand{\sS}{\mathfrak{S}}
\newcommand{\fa}{\mathfrak{a}}
\newcommand{\fb}{\mathfrak{b}}
\newcommand{\fc}{\mathfrak{c}}
\newcommand{\fp}{\mathfrak{p}}
\newcommand{\fq}{\mathfrak{q}}
\newcommand{\fr}{\mathfrak{r}}
\newcommand{\fl}{\mathfrak{l}}
\newcommand{\mP}{\mathfrak{P}}
\newcommand{\xx}{\mathbf{x}}
\newcommand{\zz}{\mathbf{z}}
\newcommand{\yy}{\mathbf{y}}
\newcommand{\hh}{\mathbf{h}}
\newcommand{\ww}{\mathbf{w}}
\newcommand{\uu}{\mathbf{u}}
\newcommand{\bfl}{\mathbf{l}}
\newcommand{\bb}{\mathbf{b}}
\newcommand{\aaf}{\mathbf{a}}
\newcommand{\cc}{\mathbf{c}}
\newcommand{\mm}{\mathbf{m}}
\newcommand{\nn}{\mathbf{n}}
\newcommand{\rr}{\mathbf{r}}
\newcommand{\bs}{\mathbf{s}}
\newcommand{\fA}{\mathfrak{A}}
\newcommand{\fB}{\mathfrak{B}}
\DeclareMathOperator{\Jac}{Jac}
%\def\mod#1{{\ifbmode\text{\rm\ (mod~$#1$)}
%\else\discretionary{}{}{\hbox{ }}\rm(mod~$#1$)\fi}}


\newcommand\Tstrut{\rule{0pt}{6ex}}         % = `top' strut
\newcommand\Bstrut{\rule[-5ex]{0pt}{0pt}}   % = `bottom' strut

\newcommand\margnote[1]{\marginpar{\tiny\begin{minipage}{20mm}\begin{flushleft} #1\end{flushleft}\end{minipage}}}
\newcommand{\edit}[1]{\textcolor{red}{#1}}

%\renewcommand{\baselinestretch}{1.5}

\begin {document}

\newtheorem{thm}{Theorem}
\newtheorem{proc}{Procedure}
\newtheorem{alg}{Algorithm}
\newtheorem{lem}{Lemma}[section]
\newtheorem{prop}[lem]{Proposition}
\newtheorem{cor}[lem]{Corollary}
\newtheorem*{conj}{Conjecture}

\theoremstyle{definition}
\newtheorem{defn}[lem]{Definition}
\newtheorem{example}[lem]{Example}

\theoremstyle{remark}
\newtheorem{rem}[thm]{Remark}

\newtheorem{ack}{Acknowledgement}

\title[]{Efficient Resolution of Thue--Mahler Equations}

\author{Adela Gherga}
\email{adela.gherga@warwick.ac.uk}
\address{Mathematics Institute, University of Warwick, Coventry CV4 7AL, United Kingdom}
\author{Samir Siksek}
\email{S.Siksek@warwick.ac.uk}
\address{Mathematics Institute, University of Warwick, Coventry CV4 7AL, United Kingdom}
\thanks{
The authors are supported by the
EPSRC grant \emph{Moduli of Elliptic curves and Classical Diophantine Problems}
(EP/S031537/1).
}

\date{\today}

\keywords{Thue equation, Thue--Mahler equation, LLL,
linear form in logarithms}

\makeatletter
\@namedef{subjclassname@2020}{%
  \textup{2020} Mathematics Subject Classification}
\makeatother

\subjclass[2020]{Primary 11D59, Secondary 11D61}

\begin {abstract}
  Let $F$ be a homogenous irreducible form of degree at least $3$ with integer
  coefficients. A Thue-Mahler equation is a Diophantine equation of the form
  \[F(X,Y) = a\cdot p_1^{z_1}\cdots p_v^{z_v}, \qquad \gcd(X,Y)=1 \]
  where $a$ is an integer and $p_1, \dots, p_v$ are rational primes.
An algorithm of Tzanakis and de Weger explicitly computes the
set of solutions when the degree of $F$ and the set of primes
are both small. We give a new algorithm that exploits
lattice sieving techniques capable of resolving Thue--Mahler equations
of higher degree and with larger sets of primes.
% To explicitly solve these equations when the degree and set of primes is small, there exists a practical method of Tzanakis-de Weger using linear forms in logarithms. We give new lattice sieving techniques and a refined algorithm capable of resolving Thue-Mahler equations with high-degree and large prime sets.
\end {abstract}
\maketitle

%--------------------------------------------------------------------------------------------%
%--------------------------------------------------------------------------------------------%

\section{Introduction} \label{sec:intro}

Let
\begin{equation}\label{eqn:F}
  F(X,Y)=a_0 X^d+a_1 X^{d-1} Y+ \cdots + a_d Y^d
\end{equation}
be a homogeneous binary form of degree $d \ge 3$ with coefficients $a_i \in
\Z$. Suppose $F$ is irreducible. Let $a$ be a non-zero integer and let
$p_1,\dotsc,p_v$ be distinct primes such that $p_i \nmid a$. The purpose of
this paper is to give an efficient algorithm to solve the Thue--Mahler equation
\begin{equation}\label{eqn:preTM}
  F(X,Y)=a \cdot
  p_1^{z_1} \cdots p_v^{z_v}, \qquad
  X,~Y \in \Z, \;
  \gcd(X,Y)=1, %=\gcd(a_0,Y)=1,
\end{equation}
for unknown integers $X,Y$, and unknown
non-negative integers $z_1, \dots, z_v$. The set of solutions
is known to be finite by a famous result of Mahler \cite{Mahler}
which extends classical work of Thue \cite{Thue}.
Mahler's theorem is ineffective. The first effective bounds
on the size of the solutions are due to
Vinogradov and Sprind\v{z}uk \cite{VinogradovSprindzuk}
and to
Coates \cite{CoatesTM}.
Vastly improved effective bounds have since been given by
Bugeaud and Gy\H{o}ry \cite{BGTM}. Evertse \cite[Corollary 2]{EvertseTM}
showed that the number of solutions to \eqref{eqn:preTM} is at most $2 \times 7^{d^3(2v+3)}$.
For $d \ge 6$, this has been improved by Bombieri \cite[Main Theorem]{BombieriTM}
who showed that the number of solutions is at most $16 v^2 \cdot (4d)^{26v}$.

\bigskip

Besides being of independent interest, Thue--Mahler equations frequently arise
in a number of contexts:
\begin{itemize}
\item The problem of determining all elliptic curves over
$\Q$ with good reduction outside a given set of primes algorithmically
reduces to the problem of solving certain cubic Thue--Mahler equations (here
cubic means $d=3$).
The earliest example appears to be due to
Agrawal, Coates, Hunt, and van der
              Poorten \cite{AgrawalCoates} who used it to
determine all elliptic curves over $\Q$ of conductor $11$.
The recent paper of Bennett, Gherga and Rechnitzer \cite{BeGhRe} gives
a systematic and general treatment of this approach.
In fact, the link between cubic Thue--Mahler
equations and elliptic curves can be used in conjuction
with modularity of elliptic curves to give an algorithm
for solving cubic Thue--Mahler equations as in the
work of von K\"{a}nel and Matschke \cite[Section 5]{KanelMatschke}
and of Kim \cite{KimTM}.
\item Many Diophantine problems naturally reduce
to the resolution of Thue--Mahler equations. These include
the Lebesgue--Nagell equations (e.g.\ \cite{Cangul}, \cite{SoTz}),
and Goormaghtigh's equation (e.g.\ \cite{BeGhKr}). The most striking
of such applications is the reduction, due to Bennett and Dahmen \cite{BennettDahmen},
of asymptotic cubic superelliptic equations to cubic Thue--Mahler equations, via the modularity of
Galois representation attached to elliptic curves.
\end{itemize}
Before the current paper, the only general algorithm for solving
Thue--Mahler equations was the one due to Tzanakis and de Weger \cite{TW}.
A modern implementation of this algorithm, due Hambrook \cite{Hambrook},
has profitably been used to solve a number of low degree Thue--Mahler
equations, for example in \cite{Cangul}, \cite{SoTz}.


Before proceeding further we point out a standard
computational simplification
which is applied by Tzanakis and de Weger and which
we will apply too. Let $(X,Y)$ be a solution to \eqref{eqn:preTM}.
Let $b=\gcd(a_0,Y)$, where $a_0$ is the leading coefficient
of $F$ as in \eqref{eqn:F}. Write $Y=bY^\prime$ with $Y^\prime \in \Z$.
The possible values for $b$ are the divisors of $a_0$;
for each divisor $b$ we need to solve
$F(X,bY^\prime)=a \cdot p_1^{z_1} \cdots p_v^{z_v}$,
where we may assume $\gcd(X,Y^\prime)=\gcd(a_0,Y^\prime)=1$.
Thus, instead of \eqref{eqn:preTM}, we consider the equation
\begin{equation}\label{eqn:TM}
  F(X,Y)=a \cdot
  p_1^{z_1} \cdots p_v^{z_v}, \qquad
  X,~Y \in \Z, \;
  \gcd(X,Y)=\gcd(a_0,Y)=1.
\end{equation}

The approach of Tzanakis and de Weger breaks down into a number of steps.
\begin{enumerate}[(I)]
\item First \eqref{eqn:TM} is reduced to a number of ideal equations:
\begin{equation}\label{eqn:ideal}
(a_0 X- \theta Y)\OO_K=\fa \cdot \fp_1^{n_1}\cdots \fp_s^{n_s}.
\end{equation}
Here $\theta$ is a root of the monic polynomial $a_0^{d-1} F(X/a_0,1)$,
and $K=\Q(\theta)$. Moreover, $\fa$ is a fixed prime ideal of the ring
of integers $\OO_K$, and $\fp_1,\dotsc,\fp_s$ are fixed prime ideals of $\OO_K$.
The variables $X$, $Y$, $n_1,\dotsc,n_s$ represent the unknowns.
\item Next, each ideal equation \eqref{eqn:ideal} is reduced
to a number of equations of the form
\begin{equation}\label{eqn:unitequation}
a_0 X-\theta Y = \tau \cdot \delta_1^{b_1} \cdots \delta_r^{b_r}
\end{equation}
where $\tau$, $\delta_1,\cdots,\delta_r \in K^{\times}$ are fixed and $X$, $Y$, $b_1,\dotsc,b_r$
are unknowns.
\item The next step generates a very large upper bound
for the exponents $b_1,\dotsc,b_r$
using the theory of real, complex, and $p$-adic linear forms in
logarithms. This bound is then considerably reduced using the LLL algorithm
\cite{LLL} applied to approximation lattices associated to these linear forms,
and finally, all solutions below this reduced bound are found using the
algorithm of Fincke and Pohst \cite{FinckePohst}.
\end{enumerate}
To compute these approximation lattices alluded to in step (III), the algorithm of Tzanakis and de Weger
relies on extensive computations in the number field $K^\prime=\Q(\theta_1,\theta_2,\theta_3)$
where $\theta_1$, $\theta_2$, $\theta_3$ are distinct roots of $a_0^{d-1} F(X/a_0,1)$,
as well as $\fp$-adic completions of $K^\prime$.
The field $K^\prime$ typically has degree $d(d-1)(d-2)$,
making their algorithm impractical if the degree
$d$ is large. Even if the degree $d$ is small (say $d=3$), we have
found that the Tzanakis-de Weger algorithm runs into a combinatorial
explosion of cases in step (I) if the number of primes $v$ is large,
and in step (II) if the class number $h$ of $K$ is large.


%For reasons explained in due course
%that algorithm also runs into a combinatorial explosion of cases if the number of primes $v$ is large, or if the
%class number of the number field $\Q(\theta_1)$ is large.
%In particular, the
%algorithm reduces the problem of resolving \eqref{eqn:TM} to resolving a number
%of associated ideal equations, each of which is then reduced to a number of
%equations in the associated number field of $F$. The reduction process
%described in the previous paragraph is then applied to each such equation. As
%we shall see, depending on $F$, one may have as few as \edit{[small example]}
%equations to apply this process to, to as many as \edit{[example]}, the largest
%of which we have seen in the degree $3$ case so far.

In this paper, we present an algorithm that builds on many of the
powerful ideas in the paper of Tzanakis and de Weger but
avoids computations in number fields
other than the field $K=\Q(\theta)$ of degree $d$, and avoids all
computations in $p$-adic fields or their extensions. The algorithm includes
a number of refinements that circumvent the explosion of cases in steps (I) and (II).
For example, to each ideal equation \eqref{eqn:ideal} we associate at most one
equation \eqref{eqn:unitequation}; by contrast, the algorithm of Tzanakis
and de Weger, typically associates $h^{s-1}$ equations \eqref{eqn:unitequation}
to each ideal equation \eqref{eqn:ideal}, where $h$ is the class number of $K$.
%Moreover, we considerably
%improve upon the Prime Ideal Removing Lemma of Tzanakis and de Weger, the
%process which reduces the Thue--Mahler equation to a number of ideal equations.
%We further provide an improvement to the process by which we convert each such
%ideal equation into a number of equations in $K$.
Moreover, inspired by the Mordell--Weil sieve (e.g.\ \cite{BruinStollMWI}, \cite{BruinStollMWII},
\cite{IntegralHyp}), we introduce
a powerful \lq\lq Dirichlet sieve\rq\rq\ that vastly improves the determination of the solutions
to \eqref{eqn:unitequation} after the LLL step, even if the
remaining bound on the exponents $b_i$ is large.


\begin{comment}
There are very few examples in the literature of explicit resolution of
Thue--Mahler equations of degree greater than $3$. Although the method of
Tzanakis and de Weger has been known for $30$ years, the first instance of an
explicit resolution of a quintic equation was only given in \cite{SoTz} in
$2016$. Indeed, the worked example in \cite{TW} is a cubic; the available
software at the time being the limiting factor for resolving higher-degree
equations. In \cite{Cangul}, I.N. Cangul, M. Demirci, G. Soydan and N. Tzanakis
find all solutions of a quartic Thue--Mahler equation. In \cite{BennettDahmen},
M. Bennett and S. R. Dahmen implement the method of \cite{TW} to solve special
classes of cubic Thue--Mahler equations, arising from their study of
generalized superelliptic equations, and in \cite{KimTM}, D. Kim exploits the
modularity of elliptic curves over $\Q$ to resolve cubic Thue--Mahler
equations. To compute elliptic curves over $\Q$, M. Bennett, A. Gherga and A.
Rechnitzer \cite{BeGhRe} solve large families of degree $3$ Thue--Mahler
equations using the automated, self-contained Thue--Mahler solver presented in
the M.Sc. thesis of K. Hambrook \cite{Hambrook}. This implementation follows
closely the algorithm of Tzanakis and de Weger, but includes certain
improvements to decrease run-time. Finally, in their study of Goormaghtigh's
equation, M. Bennett, A. Gherga and R. Kreso \cite{BeGhKr} modify and sharpen
the algorithm of \cite{Hambrook} to resolve $719$ quintic Thue--Mahler
equations.
\end{comment}

We have implemented the algorithm described in this paper in the computer algebra
system \texttt{Magma} %\footnote{\texttt{Magma} V2.26-10}
\cite{Magma}; our implementation is available from \newline
{\small \url{https://github.com/adelagherga/ThueMahler/tree/master/Code/TMSolver}}





\bigskip

Below we
give five examples of Thue--Mahler equations solved using our
implementation. We will revisit these examples later on in the paper to
illustrate the differences between our algorithm and that of
Tzanakis and de Weger \cite{TW}.
We do point out that a number of recent papers also
make use of our implementation, or the ideas in the present
paper, to solve various Thue--Mahler equations
where the degree $d$, or the number of primes $v$ are large. For example in
\cite{BeGhKr}, \cite{BGPS}, \cite{BeSiLN}, \cite{BeSiNew}, the current algorithm
is used to solve Thue--Mahler equations of degrees $5$, $20$, $11$ and $7$
respectively.


\bigskip


With the exception of Example 1, our solutions will always be subject to the assumptions
\[
	\gcd(X,Y)=\gcd(a_0,Y)=1.
\]
They will be given
in the form $[X,Y,z_1,z_2,\dotsc,z_v]$.

%\edit{(Compare the examples below to the TdW algorithm -- need to run the algorithm and get timinigs, etc.)}

%--------------------------------------------------------------------------------------------%
\subsection*{Example 1}
We consider the problem of computing all elliptic curves $E/\Q$
with trivial $2$-torsion and conductor
\[
	771456 \; = \; 2^7 \cdot 3 \cdot 7^2 \cdot 41.
\]
Applying Theorem 1 of \cite{BeGhRe}  yields $13$ cubic Thue--Mahler
equations of the form
\[
a_0 X^3+a_1 X^2 Y+a_2 XY^2+a_3 Y^3=
3^{z_1} \cdot  7^{z_2}\cdot 41^{z_3},
        \qquad \gcd(X,Y)=1,
\]
whose resolution algorithmically yields the desired set
of elliptic curves. The coefficients for these
$13$ forms are as follows:
\[\begin{array}{c|c}
  (a_0,a_1,a_2,a_3) & (a_0,a_1,a_2,a_3) \\ \hline
  (1,7,2,-2) & (2,1,0,3) \\
  (1,4,3,6) & (3,4,4,4) \\
  (4,4,6,3) & (2,5,0,6) \\
  (1,7,4,12) & (3,3,-1,7) \\
  (3,7,14,14) & (1,3,17,43) \\
  (8,12,13,8) & (4,1,12,-6) \\
  (3,9,5,19) &
\end{array}\]
Our implementation solved all $13$ of these Thue--Mahler equations and
computed the corresponding elliptic curves in a total of $2.6$ minutes
on a single core. Full computational details, as well as a list of all corresponding elliptic curves can be found at \newline
{\small \url{https://github.com/adelagherga/ThueMahler/tree/master/GhSiData/Example1}}

For illustration, we consider one of these $13$ Thue--Mahler equation:
\[
	4X^3+ X^2 Y + 12X Y^2 - 6Y^3= 3^{z_1} \cdot  7^{z_2}\cdot 41^{z_3},
	\qquad \gcd(X,Y)=1.
\]
Our implementation solved this in 21 seconds.
The solutions are
\begin{gather*}
  [ -3, -7, 1, 0, 1 ],\quad
  [ -1, -5, 2, 2, 0 ],\quad
  [ 1, -1, 1, 1, 0 ], \\
  [ 3, 1, 1, 2, 0 ], \quad
  [ 5, 11, 0, 2, 0 ],\quad
  [ 9, 17, 1, 2, 1 ],\quad
  [ 19, 23, 5, 3, 0 ].
\end{gather*}
Of the seven solutions, only
$(X,Y) = (1,-1)$ gives rise to elliptic curves of conductor $771456$: \[E_1:
y^2 = x^3 - x^2 +  13655x + 2351833,\]
\[E_2: y^2 = x^3 - x^2 +  3414x - 295686.\]




%--------------------------------------------------------------------------------------------%

\subsection*{Example 2}
We consider the Thue--Mahler equation
% \begin{equation}\label{eqn:TMBad2}
\[7 X^3 + X^2 Y + 29 X Y^2 - 25 Y^3 \; = \; 2^{z_1}\cdot 3^{z_2} \cdot 7^{z_3}
\cdot 37^{z_4} \cdot 53^{z_5} \, .\]
%\end{equation}
Our implementation solved this in 19 seconds.
The solutions are
%With the Fincke and Pohst
%this maxed the memory after two weeks.
\[
  [ 1, 1, 2, 1, 0, 0, 0 ], \qquad
  [ 19, -23, 2, 4, 0, 1, 1 ].
\]


%--------------------------------------------------------------------------------------------%


\subsection*{Example 3}
Consider
\begin{equation} \label{eqn:FST}
F(X,Y) = 3 X^5 + 65 X^4 Y - 290 X^3 Y^2 - 2110 X^2 Y^3 + 975 X Y^4 + 3149 Y^5.
\end{equation}
In \cite{SoTz}, Soydan and Tzanakis use the method of
Tzanakis and de Weger \cite{TW} to solve the equation
\[
F(X,Y)\; = \;
-2^5 \cdot 3^4 \cdot 5^{z_1} \cdot 11^{z_2},
\]
finding no solutions (subject to the usual condition $\gcd(X,Y)=\gcd(3,Y) = 1$).
As a consequence of Lemma~\ref{lem:adequate} and Algorithm~\ref{alg1} of this paper -- an improved variant of the Prime Ideal Removing Lemma of \cite{TW} -- this Thue--Mahler equation yielded no ideal equations to solve, and hence no solutions. Our program solved this in 0.1 seconds, terminating after the first setup stage of the algorithm, whereas the Hambrook implementation \cite{Hambrook} of
the method of Tzanakis and de Weger required roughly 72 days,
and a less automated variant of Soydan and Tzanakis took
around $2$ hours with human intervention. Moreover, as a result of where our program terminated, we may also conclude that
\[F(X,Y) = \pm \; 3^4 \cdot m\]
has no solutions for any integer $m$ coprime to $3$, subject to the condition that $\gcd(X,Y) = \gcd(3,Y) = 1$.

Finally, using the method of this paper, we solved the more general Thue--Mahler equation
\[
F(X,Y)\; = \;
-2^{z_1} \cdot 3^{z_2} \cdot 5^{z_3} \cdot 7^{z_4} \cdot 11^{z_5} \cdot
13^{z_6} \cdot 17^{z_7}.
\]
Our program took around 6 minutes to solve this. The solutions are
\begin{gather*}
  [ -27, 1, 8, 0, 0, 1, 1, 1, 1 ], \qquad
  [ -7, -1, 5, 0, 2, 0, 0, 0, 1 ],\\
  [ -3, 1, 8, 0, 2, 0, 0, 0, 0 ],\qquad
  [ -1, -1, 8, 0, 0, 1, 0, 0, 0 ],\\
  [ 1, -1, 5, 0, 0, 0, 0, 1, 0 ],\qquad
  [ 5, 1, 8, 0, 0, 0, 2, 0, 0 ],\\
  [ 17, -4, 0, 0, 2, 2, 0, 2, 0 ] \, .
\end{gather*}


%--------------------------------------------------------------------------------------------%

\subsection*{Example 4}
For a non-zero integer $m$, let $P(m)$
denote the maximum prime divisor of $m$ (where
we take $P(1)=P(-1)=0$).
In this example, we solve the equation
\[
	P(X^4-2Y^4) \le 100, \qquad \gcd(X,Y)=1.
\]
Let $F(X,Y)=X^4-2Y^4$.
We therefore would like to solve \eqref{eqn:TM} with $a= \pm 1$
and with $p_1,\dotsc,p_v$
being the set of primes $\le 100$ (of which there are $25$).
However, it is clear that if $-2$ is not a fourth power
modulo $p$, then $p \nmid (X^4-2Y^4)$. Thus we reduce
to the much smaller set of primes $p \le 100$
for which $-2$ is a fourth power. This is the set
\[
\{2, 7, 23, 31, 47, 71, 73, 79, 89\}.
\]
Thus the Thue--Mahler equation we shall consider is
\[
X^4-2Y^4 \; = \; \pm 2^{z_1} \cdot 7^{z_2} \cdot 23^{z_3}
\cdot 31^{z_4} \cdot 47^{z_5} \cdot 71^{z_6} \cdot 73^{z_7} \cdot
79^{z_8} \cdot 89^{z_9}, \qquad \gcd(X,Y)=1.
\]
Our implementation took
roughly 3.5 days to solve this Thue--Mahler equation.
There are $49$ solutions (up to changing the signs of $X$, $Y$):
\begin{gather*}
 [ 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0 ],\quad
    [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],\displaybreak[0] \\
    [ 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],\quad
    [ 1, 2, 0, 0, 0, 1, 0, 0, 0, 0, 0 ],\displaybreak[0] \\
    [ 1, 3, 0, 1, 1, 0, 0, 0, 0, 0, 0 ],\quad
    [ 1, 4, 0, 1, 0, 0, 0, 0, 1, 0, 0 ],\displaybreak[0] \\
    [ 1, 11, 0, 1, 0, 0, 1, 0, 0, 0, 1 ],\quad
    [ 2, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0 ],\displaybreak[0] \\
    [ 2, 3, 1, 0, 0, 0, 0, 0, 1, 0, 0 ],\quad
    [ 2, 27, 1, 1, 0, 2, 0, 0, 0, 1, 0 ],\displaybreak[0] \\
    [ 3, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0 ],\quad
    [ 3, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0 ],\displaybreak[0] \\
    [ 3, 14, 0, 0, 1, 0, 1, 1, 0, 0, 0 ],\quad
    [ 4, 3, 1, 0, 0, 0, 1, 0, 0, 0, 0 ],\displaybreak[0] \\
    [ 4, 5, 1, 1, 0, 0, 0, 1, 0, 0, 0 ],\quad
    [ 5, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1 ],\displaybreak[0] \\
    [ 5, 8, 0, 1, 1, 0, 1, 0, 0, 0, 0 ],\quad
    [ 6, 5, 1, 0, 1, 0, 0, 0, 0, 0, 0 ],\displaybreak[0] \\
    [ 6, 19, 1, 0, 0, 1, 1, 0, 0, 0, 1 ],\quad
    [ 8, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1 ],\displaybreak[0] \\
    [ 10, 23, 1, 2, 0, 0, 0, 1, 0, 1, 0 ],\quad
    [ 11, 9, 0, 2, 0, 1, 0, 0, 0, 0, 0 ],\displaybreak[0] \\
    [ 11, 20, 0, 0, 0, 0, 1, 0, 1, 0, 1 ],\quad
    [ 15, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0 ],\displaybreak[0] \\
    [ 15, 13, 0, 0, 0, 0, 0, 0, 1, 0, 1 ],\quad
    [ 16, 21, 1, 0, 1, 0, 0, 0, 0, 1, 1 ],\displaybreak[0] \\
    [ 17, 5, 0, 2, 1, 0, 0, 0, 1, 0, 0 ],\quad
    [ 19, 20, 0, 4, 0, 0, 0, 0, 0, 1, 0 ],\displaybreak[0] \\
    [ 21, 11, 0, 0, 0, 1, 0, 0, 2, 0, 0 ],\quad
    [ 22, 49, 1, 0, 1, 1, 0, 0, 0, 0, 2 ],\displaybreak[0] \\
    [ 33, 13, 0, 1, 0, 0, 2, 0, 1, 0, 0 ],\quad
    [ 37, 19, 0, 0, 1, 2, 0, 0, 1, 0, 0 ],\displaybreak[0] \\
    [ 40, 13, 1, 1, 0, 1, 0, 0, 1, 1, 0 ],\quad
    [ 52, 51, 1, 2, 1, 1, 0, 0, 0, 0, 1 ],\displaybreak[0] \\
    [ 53, 44, 0, 1, 1, 1, 0, 0, 0, 1, 0 ],\quad
    [ 59, 56, 0, 0, 0, 1, 1, 1, 1, 0, 0 ],\displaybreak[0] \\
    [ 61, 48, 0, 1, 0, 0, 0, 1, 1, 0, 1 ],\quad
    [ 66, 101, 1, 0, 2, 1, 0, 0, 1, 1, 0 ],\displaybreak[0] \\
    [ 68, 43, 1, 1, 1, 2, 1, 0, 0, 0, 0 ],\quad
    [ 95, 58, 0, 1, 0, 1, 1, 0, 1, 1, 0 ],\displaybreak[0] \\
    [ 118, 101, 1, 2, 1, 0, 0, 1, 0, 0, 1 ],\quad
    [ 142, 57, 1, 1, 3, 1, 0, 0, 1, 0, 0 ],\displaybreak[0] \\
    [ 162, 137, 1, 2, 0, 0, 2, 0, 1, 0, 0 ],\quad
    [ 181, 124, 0, 0, 1, 0, 1, 0, 0, 2, 1 ],\displaybreak[0] \\
    [ 221, 295, 0, 0, 2, 0, 1, 0, 1, 1, 1 ],\quad
    [ 281, 199, 0, 1, 1, 0, 1, 1, 1, 1, 0 ],\displaybreak[0] \\
    [ 286, 283, 1, 3, 1, 0, 0, 0, 3, 0, 0 ],\quad
    [ 389, 96, 0, 4, 0, 1, 1, 0, 1, 0, 1 ],\displaybreak[0] \\
    [ 420, 437, 1, 0, 0, 1, 3, 0, 1, 0, 1 ].
\end{gather*}

%--------------------------------------------------------------------------------------------%

\subsection*{Example 5}
Our last example is
\begin{multline*}
5 X^{11} + X^{10} Y + 4 X^9 Y^2 + X^8 Y^3 + 6 X^7 Y^4 + X^6 Y^5 + 6 X^5 Y^6 +
    6 X^3 Y^8 + 4 X Y^{10} - 2 Y^{11}\\
=
2^{z_1} \cdot 3^{z_2} \cdot 5^{z_3} \cdot 7^{z_4} \cdot 11^{z_5} \, .
\end{multline*}
Our program solved this in around 4.7 hours. However this time was almost entirely taken up with the computation of the class group and the units. Once the class group and unit computations were complete, it took only 2.3 minutes to provably determine the solutions. These are
\begin{gather*}
    [ 0, -1, 1, 0, 0, 0, 0 ], \qquad
    [ 1, -1, 1, 1, 1, 0, 0 ],\\
    [ 1, 1, 5, 0, 0, 0, 0 ],\qquad
    [ 1, 2, 0, 3, 0, 1, 1 ]\, .
\end{gather*}

%--------------------------------------------------------------------------------------------%

\subsection{Notation and Organization of the paper}
As before $F \in \Z[X,Y]$ will be a homogeneous irreducible
binary form of degree $d \ge 3$ with coefficients $a_0,\dotsc,a_d$ as in  \eqref{eqn:F}.
Let $a$ be a non-zero integer, and $p_1,\dotsc,p_v$ be distinct primes.
Let
\[
f(x)=a_0^{d-1}\cdot F(x/a_0,1)=x^d+a_{1} x^{d-1}+a_0 a_{2} x^{d-2}+\cdots
+a_0^{d-1} a_d.
\]
This is an irreducible monic polynomial with coefficients in $\Z$.
Let $\theta$ be a root
of $f$ and let $K=\Q(\theta)$. Note that $K$ is a number field
of degree $d$.
Write $\OO_K$ for the ring of integers of $K$.
We can rewrite our Thue--Mahler equation
\eqref{eqn:TM} as
\begin{equation}\label{eqn:TM2}
\Norm(a_0 X- \theta Y)= a_0^{d-1} \cdot a \cdot p_1^{z_1} \cdots p_v^{z_v}.
\end{equation}
Note that we do not assume that $(a_0,p_i) = 1$.

\bigskip

The paper is organized as follows.
\begin{enumerate}[(a)]
\item In Section~\ref{sec:ppart} we
consider the decomposition of the ideal $(a_0X - \theta Y)\OO_K$
as a product of prime ideals. In particular, we introduce an
algorithm to compare and restrict the possible valuations of all prime ideals
above each of $p_1, \dots, p_v$.
\item We summarize the results of applying this
algorithm in Section~\ref{sec:eq-in-ideals}, wherein we reduce solving
\eqref{eqn:TM2} to solving a family of ideal equations of the form
\eqref{eqn:ideal}.
\item In Section~\ref{sec:making-ideals-princ}, we show
that such ideal equations are either impossible due to a class group
obstruction, or reduce to a single
equation of the form
\eqref{eqn:unitequation}.
The remainder of the paper is devoted to solving equations of the form
\eqref{eqn:unitequation} where the unknowns are coprime integers
$X$, $Y$ and non-negative integers $b_1,\dotsc,b_r$.
\item In Section~\ref{sec:lower-bounds}, we recall key
theorems from the theory of lower bounds for linear forms in complex and $p$-adic logarithms
due to Matveev and to Yu.
\item In Section~\ref{sec:sunit}, with the help of these theorems,
we obtain a very large upper bound on
the exponents $b_1,\dotsc,b_r$ in \eqref{eqn:unitequation}.
\item \label{fp} In Section~\ref{sec:controlling-vals} we show how an application
of close vector algorithms allows us to obtain
a substantially improved bound on the $\fp$-adic valution of $a_0X-\theta Y$
for any prime $\fp$. This step avoids the $\fp$-adic logarithms of earlier
approaches.
\item \label{rfrl} Section~\ref{sec:LFRL}
uses the real embeddings of $K$ applied to \eqref{eqn:unitequation}
to obtain $d-2$ approximate relations involving the exponents
$b_i$. In Section~\ref{sec:red}, we setup an
\lq approximation lattice\rq\ using these $d-2$
approximate relations. We explain how
close vector algorithms can be used
to substantially reduce our bound
for the exponents $b_1,\dotsc,b_r$ in \eqref{eqn:unitequation}.
Earlier approaches used just one
of the $d-2$ relations to construct the approximation
lattice, but we explain why using just one
approximate relation can fail in certain situations.
\item Steps (\ref{fp}) and (\ref{rfrl}) are applied
repeatedly until no further
improvement in the bounds are possible.
In Section~\ref{sec:sieve}
we introduce an analogue
of the Mordell--Weil sieve,
which we call the \lq\lq Dirichlet sieve\rq\rq\,
which is capable of efficiently sieving
for the solutions up to the remaining bounds,
thereby finaly resolving the Thue-Mahler equation \eqref{eqn:TM}.
\end{enumerate}

%--------------------------------------------------------------------------------------------%

\section{The $p$-part of $(a_0 X- \theta Y) \OO_K$}\label{sec:ppart}

If $\cc$ is a fractional ideal of $\OO_K$, and $p$ is
a rational prime, we define the \textbf{$p$-part of $\cc$} to be the fractional ideal
\[
\prod_{\fp \mid p} \fp^{\ord_\fp(\cc)}.
\]
%Let $p_i$ be as in \eqref{eqn:TM}, \eqref{eqn:TM2}.
%We want to study, for each $p=p_i$,
For each rational prime $p\in \{p_1, \dots, p_v\}$ of \eqref{eqn:TM2}, we want to study the $p$-part of ${(a_0 X- \theta Y) \OO_K}$
coming from the prime ideals above $p$.
The so-called Prime Ideal Removal Lemma in Tzanakis and de Weger
compares the possible valuations of ${(a_0 X-\theta Y)\OO_K}$ at two
prime ideals $\fp_1$, $\fp_2 \mid p$ to help cut down the possibilities
for the the $p$-part of $(a_0 X- \theta Y) \OO_K$.
However if $\fp_1 \mid (a_0 X-\theta Y)\OO_K$
then this restricts the values of $X$ and $Y$ modulo $p$.
Indeed, any choice of $X$ and $Y$ modulo $p$ affects the valuations
of $(a_0 X- \theta Y)\OO_K$ at all primes $\fp \mid p$. So we study all
valuations at the same time, not just two of them. This enables us to give a much smaller list of possibilities for the $p$-part of $(a_0 X- \theta Y) \OO_K$ than in Tzanakis and de Weger, as we will see in Section~\ref{sec:making-ideals-princ}.

\begin{defn}\label{defn:sat}
Let $p$ be a rational prime. Let $L_p$ be a subset of the ideals
$\fb$ supported at the prime ideals
above $p$. Let $M_p$ be a subset of the set of pairs $(\fb,\fp)$ where $\fb$ is supported at the prime
ideals above $p$, and $\fp \mid p$ is a prime ideal
satisfying $e(\fp|p)=f(\fp|p)=1$, where $e(\fp|p)$ and $f(\fp|p)$ are, respectively, the ramification index and inertial degree of $\fp$ over $p$. We call the pair $L_p$, $M_p$ \textbf{satisfactory}
if for every solution $(X,Y)$
 to \eqref{eqn:TM},
\begin{enumerate}
\item[(i)] either there is some $\fb  \in L_p$
such that the $p$-part of $(a_0 X-\theta Y)\OO_K$
is equal to $\fb$,
%\begin{equation}\label{eqn:case1}
%\fb \mid (a_0 X- \theta Y) \OO_K, \qquad \text{$(a_0 X-\theta Y)\OO_K/\fb$ is
%coprime to $p \OO_K$};
%\end{equation}
\item[(ii)] or there is a pair $(\fb,\fp) \in M_p$
and a non-negative integer $l$ such that the $p$-part of
$(a_0 X-\theta Y)\OO_K$ is equal to $\fb \fp^{l}$.
%\begin{equation}\label{eqn:case2}
%(\fb \cdot \fp^v) \mid (a_0 X- \theta Y) \OO_K,
%\qquad \text{$(a_0 X-\theta Y)\OO_K/(\fb \cdot \fp^v)$ is
%coprime to $p \OO_K$}.
%\end{equation}
\end{enumerate}
\end{defn}
At this point the definition
is perhaps mysterious. Lemma~\ref{lem:dimyst}
and the following remark give an explanation for
the definition and for the existence of finite
satisfactory sets $L_p$, $M_p$.
We will give an algorithm to produce
(hopefully small) satisfactory sets $L_p$ and $M_p$.
Before that we embark on a simplification.
The expression $a_0 X-\theta Y$ is a linear form
in two variables $X$, $Y$. It is easier to scale
so that we are dealing with a linear expression
in just one variable.

For a rational prime $p$, let
\[
\Z_{(p)}=\{U \in \Q \; : \; \ord_p(U) \ge 0\}.
\]
\begin{defn}\label{defn:adeq}
Let $p$ be a rational prime.
Let $\alpha \in K$ and $\beta \in K^{\times}$.
Let $L$ be a subset of the ideals $\fb$ supported on
the prime ideals of $\OO_K$ above $p$. Let $M$ be a subset of the set of pairs
$(\fb,\fp)$ where $\fb$ is supported on the prime ideals
above $p$, and where $\fp$ is a prime ideal above $p$ satisfying
$e(\fp|p)=f(\fp|p)=1$. We call $L$, $M$ \textbf{adequate
for $(\alpha,\beta)$} if for every $U \in \Z_{(p)}$,
\begin{enumerate}
\item[(i)] either there is some $\fb  \in L$
such that the $p$-part of
$\beta \cdot (U+\alpha) \OO_K$ equals $\fb$,
\item[(ii)] or there is a pair $(\fb,\fp) \in M$
and a non-negative integer $l$ such that
the $p$-part  of  $\beta \cdot (U+\alpha) \OO_K$
equals $\fb \fp^l$.
\end{enumerate}
\end{defn}

\begin{lem}\label{lem:adequate}
Let $L$, $M$ be adequate for $(-\theta/a_0,a_0)$ and let $L_p=L \cup \{1\cdot\mathcal{O}_K\}$ and $M_p=M$. Then the pair $L_p$, $M_p$ is satisfactory.
\end{lem}
\begin{proof}
  Recall that $\gcd(X,Y)=\gcd(a_0,Y)=1$.

  If $p \mid Y$ then $\ord_{\fp}(Y) > 0$ for any $\fp$ above $p$, and thus
\[
	\ord_{\fp}(a_0X-\theta Y) =0.
	%= \min\left(\ord_{\fp}(a_0X), \ord_{\fp}(\theta Y)\right) = 0.
\]

  If $p \nmid Y$, we write
    \[
      U=\frac{X}{Y}, \qquad \alpha=\frac{-\theta}{a_0}, \qquad
      \beta=a_0.
    \]
    Then $U \in \Z_{(p)}$ and $\ord_{\fp}(a_0 X - \theta Y) = \ord_\fp(\beta \cdot (U+\alpha))$ for all prime ideals $\fp$ above $p$. Thus the $p$-part of $\beta \cdot (U+\alpha)$ is equal to the $p$-part of $\ord_{\fp}(a_0 X - \theta Y)$.

  The lemma follows.
\end{proof}

We now demystify Definitions~\ref{defn:sat}
and~\ref{defn:adeq}.
\begin{lem}\label{lem:dimyst}
Let $p$ be a rational prime.
Choose $\gamma \in K$ such that $\gamma \neq \theta$ is another generator of $K$. Then there is a bound $B$ depending only on $p$ and $\gamma$ such that
the following hold:
\begin{enumerate}
\item[(a)] For any $U \in \Z_{(p)}$ and any pair
of distinct prime ideals $\fp_1$, $\fp_2$ lying over $p$, either
\[
\ord_{\fp_1}(U+\gamma) \le B, \qquad \text{or} \qquad
\ord_{\fp_2}(U+\gamma) \le B.
\]
\item[(b)] For any $U \in \Z_{(p)}$ and any prime ideal $\fp$ over $p$ with $e(\fp|p) \ne 1$ or ${f(\fp|p) \ne 1}$,
\[
\ord_\fp(U+\gamma) \le B.
\]
\end{enumerate}
\end{lem}
\begin{proof}
Let $\fp$ be a prime ideal above $p$, and suppose that $\ord_\fp(U+\gamma)$
is unbounded for $U \in \Z_{(p)}$. Thus
there is an infinite sequence
$\{U_i\} \subset \Z_{(p)}$
such that
\[
\lim_{i \rightarrow \infty} \ord_{\fp}(U_i+\gamma)
%\; = \;
%\lim_{i \rightarrow \infty} \ord_{\fp_2}(U_i+\alpha)
\; = \; \infty.
\]
However, $\Z_{(p)} \subset \Z_p$, where the latter is
compact. Thus $\{U_i\}$ contains
an infinite subsequence
$\{U_{n_i}\}$ converging to, say, $U \in \Z_p$.
Write $\phi_{\fp} \; : \; K \hookrightarrow \C_p$ for the embedding
of $K$ corresponding to the prime ideal $\fp$.
It follows that ${\phi_{\fp}(\gamma)=-U \in \Z_p}$. Recall the assumption that
$K=\Q(\gamma)$. Thus $K_\fp$, the toplogical closure
of $\phi_\fp(K)$ in $\C_p$, is in fact $\Q_p$. Thus $e(\fp|p)=f(\fp|p)=1$.
This proves (b).

For (a), suppose that there is a pair of distinct primes
$\fp_1$, $\fp_2$ above $p$ and an infinite sequence
$\{U_i\} \subset \Z_{(p)}$
such that
\begin{equation}\label{eqn:limit}
\lim_{i \rightarrow \infty} \ord_{\fp_1}(U_i+\gamma)
\; = \;
\lim_{i \rightarrow \infty} \ord_{\fp_2}(U_i+\gamma)
\; = \; \infty.
\end{equation}
Again, let
$\{U_{n_i}\}$ be an infinite subsequence of $\{U_i\}$
converging to, say, $U \in \Z_p$. Then
$\phi_{\fp_1}(\gamma)=-U=\phi_{\fp_2}(\gamma)$. As $K=\Q(\gamma)$,
the embeddings $\phi_{\fp_1}$, $\phi_{\fp_2}$ are equal,
contradicting
$\fp_1 \ne \fp_2$.
\end{proof}

\noindent \textbf{Remark.} We apply Lemma~\ref{lem:dimyst} with $\gamma = \alpha$ as in Lemma~\ref{lem:adequate} in order to explain Definitions~\ref{defn:sat} and~\ref{defn:adeq}. The valuation of $\beta \cdot (U+\alpha)$ can be arbitrarily large only
for those $\fp$ above $p$ that satisfy $e(\fp|p)=f(\fp|p)=1$, and if it is sufficiently large for one such $\fp$ then it is bounded for all others. Thus there must exist finite adequate sets $L$, $M$. We now turn to the task of giving an algorithm to determine such adequate sets $L$, $M$.

% \bigskip

\begin{lem}\label{lem:strucstab}
Let $\alpha \in K$ and $\beta \in K^{\times}$. Let $p$ be a rational
prime and let $\fp$ be a prime ideal of $\OO_K$ above $p$.
Suppose $U \in \Z_{(p)}$ and
\begin{equation}\label{eqn:valhu}
\ord_\fp(\beta \cdot (U+\alpha)) > \ord_\fp(\beta)+
\min\{0,\ord_\fp(\alpha)\}.
\end{equation}
Then the following hold:
\begin{enumerate}
\item[(i)] $\ord_{\fp}(\alpha) \ge 0$.
\item[(ii)] The image of $\alpha$ in $\F_{\fp}:=\OO_K/\fp$
belongs to the prime subfield $\F_p$. In particular, there is a unique $u \in \{0, \dots, p-1\}$ such that $u \equiv -\alpha \pmod{\fp}$.
\item[(iii)] With $u$ as in (ii), $U=p U^\prime+u$
where $U^\prime \in \Z_{(p)}$.
\end{enumerate}
\end{lem}
\begin{proof}
  Since $U \in \Z_{(p)}$, we have $\ord_\fp(U) \ge 0$ and thus ${\ord_\fp(U+\alpha)=\ord_\fp(\alpha)}$ if $\ord_{\fp}(\alpha)<0$. In this case, $\ord_\fp(\beta \cdot (U+\alpha))=\ord_\fp(\alpha)+\ord_\fp(\beta)$, contradicting \eqref{eqn:valhu}. Thus $\ord_\fp(\alpha) \ge 0$,
proving (i).

Write $\overline{\alpha}$ for the image of $\alpha$ in $\F_{\fp}$,
and suppose this does not belong to the prime subfield $\F_p$.
In particular $\ord_\fp(\alpha)=0$. However, the image $\overline{U}$
of $U$ in $\F_{\fp}$ does belong to $\F_p$. Thus $U \not \equiv -\alpha
\pmod{\fp}$, or equivalently
$\ord_\fp(U+\alpha)=0$. Therefore,
$\ord_\fp(\beta \cdot (U+\alpha))=\ord_\fp(\beta)$, contradicting \eqref{eqn:valhu}. We deduce that $\overline{\alpha} \in \F_p$,
and thus (ii) holds.

Now, let $u$ be as in (ii). By \eqref{eqn:valhu}, we have $\ord_\fp(U+\alpha)>0$, and thus $\overline{U}=-\overline{\alpha}=\overline{u}$.
But $\overline{U}$, $\overline{u} \in \F_p$. Therefore, $\ord_p(U-u)>0$,
and so $U=pU^\prime+u$ for some $U^\prime \in \Z_{(p)}$.
\end{proof}

\begin{alg}\label{alg1}
Given $p$ a rational prime, $\alpha \in K$ satisfying
$K=\Q(\alpha)$, and $\beta \in K^{\times}$,
to compute $L$, $M$ adequate for $(\alpha,\beta)$:
\begin{enumerate}
\item[Step (a)] Let
%\[
%\cG=\{ \fp \mid p \; : \;
%\ord_\fp(\alpha)<0 \quad \text{or} \quad
%\text{the image of $\alpha$ in $\F_\fp$ does not belong to $\F_p$}\},
%\]
\[
\cB=\{\fp \mid p \; : \;
\ord_\fp(\alpha) \ge 0 \text{ and }
\text{the image of $\alpha$ in $\F_\fp$ belongs to $\F_p$}\},
\]
and
\[
\fb=\prod_{\fp \mid p} \fp^{\ord_\fp(\beta)+\min\{0,\ord_\fp(\alpha)\}}.
\]
\item[Step (b)]
If $\cB=\emptyset$ then return $L=\{\fb\}$, $M=\emptyset$ and terminate
the algorithm.
\item[Step (c)]
If $\cB$ consists of a single prime ideal $\fp^\prime$ satisfying
$e(\fp^\prime|p)=f(\fp^\prime|p)=1$ then return
$L=\emptyset$, $M=\{(\fb,\fp^\prime)\}$ and terminate the algorithm.
\item[Step (d)]
Let
\[
 \cU=\{ 0 \le u \le p-1 \; : \; \text{there is some $\fp \in \cB$
 such that $\alpha \equiv -u \pmod{\fp}$}\}.
\]
Loop through the elements $u \in \cU$. For each $u$,
use Algorithm~\ref{alg1} to compute adequate $L_u$, $M_u$
for the pair $((u+\alpha)/p,p\beta)$.
\begin{enumerate}
\item[Step (d1)] If $\cU=\{0,1,2,\dotsc,p-1\}$ then return
\begin{equation}\label{eqn:return}
L=\bigcup_{u \in \cU} L_u, \qquad M=\bigcup_{u \in \cU} M_u,
\end{equation}
and terminate the algorithm.
\item[Step (d2)] Else, return
\begin{equation}\label{eqn:returnII}
L=\{\fb\} \cup \bigcup_{u \in \cU} L_u, \qquad M=\bigcup_{u \in \cU} M_u,
\end{equation}
and terminate the algorithm.
\end{enumerate}
\end{enumerate}
\end{alg}

\noindent \textbf{Remarks.}
\begin{itemize}
\item Algorithm~\ref{alg1} is recursive.
If the hypotheses of (b) and (c) fail
then the algorithm replaces the linear form $\beta \cdot (U+\alpha)$
with a number of  linear forms
\[
p \beta \cdot (U^\prime+ (u+\alpha)/p)=\beta \cdot (pU^\prime+u+\alpha).
\]
In essence we are replacing $\Z_{(p)}$ with a number of the
cosets of $p \Z_{(p)}$. The algorithm is then applied to
each of these  linear forms individually.
\item Note that the number of prime ideals $\fp$ above $p$ is bounded by the degree $[K:\Q]$. In particular, $\# \cU \le [K:\Q]$. Therefore the number of branches
at each iteration of the algorithm is bounded independently
of $p$.
\end{itemize}
\begin{prop}
Suppose $\beta \in K^{\times}$, $\alpha \in K$ and moreover, $K=\Q(\alpha)$.
Then Algorithm~\ref{alg1} terminates in finite time
and produces adequate $L$, $M$ for $(\alpha,\beta)$.
\end{prop}
\begin{proof}
Let $\cB$ and $\fb$ be as in Step (a).
Observe that, for any $\fp$ above $p$,
\[
\ord_\fp(\beta \cdot (U+\alpha)) \ge
\ord_\fp(\beta)+\min\{0,\ord_\fp(\alpha)\}=\ord_{\fp}(\fb).
\]
It follows that $\fb$ divides the $p$-part of
$\beta \cdot (U+\alpha)$.
Lemma~\ref{lem:strucstab} tells us that
\begin{equation}\label{eqn:equality}
\ord_\fp(\beta \cdot (U+\alpha))=
\ord_\fp(\beta)+\min\{0,\ord_\fp(\alpha)\}=\ord_{\fp}(\fb)
\end{equation}
for all prime ideals $\fp$ lying above $p$, except possibly for $\fp \in \cB$.
If $\cB=\emptyset$ (i.e.\ the hypothesis of (b)
is satisfied), then the $p$-part
of $\beta \cdot (U+\alpha)$ is $\fb$, and hence the pair
$L=\{\fb\}$, $M=\emptyset$ is
adequate for $(\alpha,\beta)$.
If $\cB=\{\fp^\prime\}$ where $e(\fp^\prime|p)=f(\fp^\prime|p)=1$
(i.e.\ the hypothesis of step (c) is satisfied) then
the $p$-part of $\beta \cdot (U+\alpha)$ has the form
$\fb \cdot {\fp^\prime}^{l}$ for some $l \ge 0$. Hence
$L=\emptyset$, $M=\{(\fb,\fp^\prime)\}$ are adequate for
$(\alpha,\beta)$.

Suppose the hypotheses of Step (b) and Step (c) fail.
Let $\cU$ be as in Step (d).
If $U \equiv u \pmod{p}$ for some $u \in \cU$,
then $U=p U^\prime+u$ for some $U^\prime \in \Z_{(p)}$.
Thus $\beta \cdot (U+\alpha)=p \beta \cdot (U^\prime+(u+\alpha)/p)$,
and so naturally the $p$-parts of $\beta \cdot (U+\alpha)$
and $p \beta \cdot (U^\prime+(u+\alpha)/p)$ agree.
In (d1), $\cU$ represents all of the congruence classes
modulo $p$,
and this justifies \eqref{eqn:return}.
In (d2), $\cU$ represents some of the congruence
classes. If $u \notin \cU$,
then by Lemma~\ref{lem:strucstab},
the equality \eqref{eqn:equality} holds for all prime ideals $\fp$ above $p$,
and hence $\fb$ is the $p$-part of $\beta \cdot (U+\alpha)$.
This justifies \eqref{eqn:returnII}.

Next we show that the algorithm terminates
in finitely many steps. Suppose otherwise.
Then there will be an infinite sequence of
$u_i \in \{0,1,\dotsc,p-1\}$ and pairs
$(\alpha_i,\beta_i)$ with
\[
\alpha_0=\alpha, \qquad \beta_0=\beta, \qquad
\alpha_{i+1}=\frac{u_i+\alpha_i}{p}, \qquad \beta_{i+1}=p \beta_i.
\]
Let us denote by $\cB_i$ the set $\cB$ for the pair $(\alpha_i,\beta_i)$.
It is easy to see from the definition that $\cB_{i+1} \subseteq \cB_i$.
Suppose $\fp$ belongs to infinitely many of the $\cB_i$. Then,
infinitely often, $\ord_\fp(\alpha_i) \ge 0$. However,
\[
\alpha=\alpha_0=-u_0-u_1 p -u_2 p^2 - \cdots - u_{i-1} p^{i-1}+p^i \alpha_i.
\]
Let $\mu=-u_0-u_1 p -\cdots  \in \Z_p$. Let $\phi_\fp : K \hookrightarrow \C_p$
be the embedding corresponding to $\fp$. Then $\phi_\fp(\alpha)=\mu$.
Since $K=\Q(\alpha)$, the embedding $\phi_\fp$ is determined
by the image of $\alpha$. Since $\phi_\fp \ne \phi_{\fp^\prime}$
whenever $\fp \ne \fp^\prime$, we see that $\cB_i$
consists of at most one prime for $i$ sufficiently large.
Moreover, for such a prime, $\phi_\fp(K)=\Q_p$ and so
must satisfy $e(\fp|p)=f(\fp|p)=1$. Thus for sufficiently large $i$
the algorithm must terminate at Step (b) or Step (c),
giving a contradiction.
\end{proof}

Following Lemma~\ref{lem:adequate}, we thus let $L_p =L \cup \{1\cdot\mathcal{O}_K\}$ and $M_p=M$, where we compute $L$ and $M$ using Algorithm~\ref{alg1} with $\alpha = -\theta/a_0$ and $\beta = a_0$.
%By Lemma~\ref{lem:adequate}, the correctness of the following
%algorithm is obvious.
%\begin{alg}\label{alg2}
%To compute $L_p$ and $M_p$. Let $L$, $M$ be adequate for the pair $(-\theta/a_0,a_0)$ computed using Algorithm~\ref{alg1}. Return $L_p=L \cup \{(1)\mathcal{O}_K\}$ and $M_p=M$,
%and terminate the algorithm.
%\end{alg}

\begin{comment}
In these algorithms we consider two \lq affine patches\rq:
$p \nmid Y$ and $p \mid Y$. As motivation for the method
we first state and prove two lemmas.
\begin{lem}\label{lem:firstpatch}
Let $(X,Y)$ be a solution \eqref{eqn:TM}, with $p \nmid Y$.
Let $x:=a_0 X/Y$. Let $t$ be a positive integer, and suppose
$x \equiv u \pmod{p^t}$
(where $u \in \{0,1,2,\dotsc,p^{t}-1\}$).
Let $\fq \mid p$. Then
\[
\ord_\fq(a_0 X-Y \theta)\ge \min\{\ord_\fq(u-\theta),\; t \cdot e(\fq/p)\}.
\]
Moreover,
 if $\ord_\fq(u-\theta)< t \cdot e(\fq/p)$,
then
\[
\ord_\fq(a_0 X-Y \theta)=\ord_\fq(u-\theta).
\]
\end{lem}
\begin{proof}
Suppose $p \nmid Y$.
Thus $\fq \nmid Y$.
Thus $\ord_\fq(a_0 X-\theta Y)
=\ord_\fq(x-\theta)$. Now
\[
x-\theta=u-\theta+x-u.
\]
But
\[
\ord_\fq(x-u) \ge \ord_\fq(p^t)=t \cdot e(\fq/p)
\]
by assumption,
completing the proof of Lemma~\ref{lem:firstpatch}.
\end{proof}
\begin{lem}\label{lem:secondpatch}
Let $(X,Y)$ be a solution \eqref{eqn:TM}, with $p \mid Y$ (and thus
$p \nmid X$).
Let $y:=Y/X$. Let $t$ be a positive integer, and suppose
$y \equiv u \pmod{p^t}$
(where $u \in \{0,1,2,\dotsc,p^{t}-1\}$).
Let $\fq \mid p$. Then
\[
\ord_\fq(a_0 X-Y \theta)\ge \min\{\ord_\fq(a_0-\theta u),\; t \cdot e(\fq/p)\}.
\]
Moreover, if
 $\ord_\fq(a_0-\theta u)< t \cdot e(\fq/p)$
then
\[
\ord_\fq(a_0 X-Y \theta)=\ord_\fq(a_0-\theta u).
\]
\end{lem}
\begin{proof}
The proof is similar to that of Lemma~\ref{lem:firstpatch}.
\end{proof}

The following algorithm computes the parts of
$L_p$ and $M_p$ that come from the first patch $p \nmid Y$.
We denote these respectively by $\cL_p$ and $\cM_p$.
\begin{alg}\label{alg1}
To compute
$\cL_p$ and $\cM_p$.

\begin{enumerate}
\item[Step (a)] Let
\[
\cL_p \leftarrow \emptyset, \qquad \cM_p \leftarrow \emptyset,
\]
\[
t \leftarrow \ord_p(a_0)+1, \qquad
\cU \leftarrow \{a_0 w : w \in \{0,1,\dots,p-1\} \}.
\]
\item[Step (b)] Let
\[
 \cU^\prime \leftarrow \emptyset.
\]
Loop through the elements $u \in \cU$.
Let
\[
\cP_u=\{\fq \mid p \; : \;
\ord_\fq(u-\theta) \ge t \cdot e(\fq/p)\},
\]
and
\[
\fb_u=\prod_{\fq \mid p} \fq^{\min\{\ord_\fq(u-\theta), t \cdot e(\fq/p)\}}
=(u-\theta) \OO_K+p^t \OO_K.
\]
\begin{enumerate}
\item[(i)] If $\cP_u=\emptyset$
then
\[
\cL_p \leftarrow \cL_p \cup \{\fb_u\}.
\]
\item[(ii)] Else if $\cP_u=\{\fp\}$ with
$e(\fp/p)=f(\fp/p)=1$,
and there is at least one $\Z_p$-root $\alpha$ of
$f$ satisfying $\alpha \equiv u \pmod{p^t}$,
then
\[
\cM_p \leftarrow \cM_p \cup \{ (\fb_u,\fp)\}.
\]
\item[(iii)] Else
\[
\cU^\prime \leftarrow \cU^\prime \cup \{ u+p^{t}w : w \in \{0,\dotsc,p-1\} \}.
\]
\end{enumerate}
\item[Step (c)] If $\cU^\prime \ne \emptyset$ then let
\[
t \leftarrow t+1, \qquad
\cU \leftarrow \cU^\prime,
\]
and return to Step (b). Else output $\cL_p$, $\cM_p$.
\end{enumerate}
%\noindent \textbf{Output:} $\cL_p$, $\cM_p$.
\end{alg}

\begin{lem}
Algorithm~\ref{alg1} terminates.
\end{lem}
\begin{proof}
Suppose otherwise.
Write $t_0=\ord_{p}(a_0)+1$, and $t_i=t_0+i$ for $i=1,2,3,\dots$.
Then there is an infinite sequence
of congruence classes $u_i \pmod{t_i}$
such that $u_{i+1} \equiv u_i \pmod{p^{t_i}}$,
and such that the $u_i$ fail
the hypotheses of both (i) and (ii). In particular,
$\cP_{u_i}$ is non-empty. By the pigeon-hole principle,
some
$\fp$ appears in infinitely many of the $\cP_{u_i}$.
Thus $\ord_{\fp}(u_i-\theta) \ge t_i\cdot e(\fp/p)$
infinitely often. However,
the sequence $\{u_i\}$ converges to some $\alpha \in \Z_p$.
Thus $\alpha=\theta$ in $\OO_\fp$. This forces $e(\fp/p)=f(\fp/p)=1$,
and $\alpha$ to be a $\Z_p$-root of $f$.
In particular, $\fp$ corresponds to the factor $(x-\alpha)$
in the $p$-adic factorisation of $f(x)$.
There can be at most one such $\fp$, and so $\cP_{u_i}=\{\fp\}$.
In particular, the hypotheses of (ii) are satisfied
and we have a contradiction.
\end{proof}

\begin{lem}\label{lem:alg1correct}
Let $p$ be one of the $p_i$,  and
let $\cL_p$, $\cM_p$
be as given by Algorithm~\ref{alg1}.
Let $(X,Y)$ be a solution to \eqref{eqn:TM} with $p \nmid Y$.
Then
\begin{itemize}
\item either there is some $\fb \in \cL_p$ such that
\eqref{eqn:case1} is satisfied;
\item or there is some $(\fb,\fp) \in \cM_p$, with $e(\fp/p)=f(\fp/p)=1$,
and integer $v \ge 0$ such that
\eqref{eqn:case2} is satisfied.
\end{itemize}
\end{lem}
\begin{proof}
Write $x:=a_0 X/Y$. Let
\[
t_0=\ord_p(a_0)+1, \qquad
\cU_0=\{a_0 w \; :\;  w \in \{0,1,\dotsc,p-1\}\}.
\]
These are the initial values for $t$ and $\cU$
in the algorithm.
Then $x \equiv u_0 \pmod{p^{t_0}}$ for some
$u_0 \in \cU_0$. Write $\cU_i$ for the value
of $\cU$ after $i$ iterations of the algorithm,
and let $t_i=t_0+i$.
As the algorithm terminates, $\cU_i=\emptyset$
for sufficiently large $i$. In particular, there
is some $i$ such that $x \equiv u_i \pmod{p^{t_i}}$
where $u_i \in \cU_i$, but there is no element
in $\cU_{i+1}$ congruent to $x$ modulo $p^{t_{i+1}}$.
Thus $u_i$ must satisfy the hypotheses of either (i)
or (ii). Write $u=u_i$, $t=t_i$
so that $x \equiv u \pmod{p^t}$.
By Lemma~\ref{lem:firstpatch}, we have $\fb_u \mid (a_0 X-\theta Y) \OO_K$.
Moreover, by that lemma and the definition
of $\cP_u$, if $\fq \notin \cP_u$ then
$(a_0 X-\theta Y)\OO_K/\fb_u$ is not divisible by $\fq$.
Suppose first that the hypothesis of (i) is satisfied:
$\cP_u=\emptyset$. The algorithm adds $\fb_u$ to the set
$\cL_p$, and by the above we know that \eqref{eqn:case1}
is satified, proving the lemma in this case.

Suppose next that the hypothesis of (ii) is satisfied:
$\cP_u=\{\fp\}$ where $e(\fp/p)=f(\fp/p)=1$,
and there is a unique $\Z_p$ root $\alpha$ of $f$
satisfying $\alpha \equiv u \pmod{p^t}$.
The algorithm add $(\fb_u,\fp)$ to the set $\cM_p$,
and by the above $(a_0 X- \theta Y)\OO_K/\fb_u$
is an integral ideal, not divisible by any prime
$\fq \mid p$, $\fq \ne \fp$. Thus there is some
positive $v \ge 0$ such that \eqref{eqn:case2}
is satisfied, proving the lemma in this case.
\end{proof}

\begin{alg}\label{alg2}
To compute
$L_p$ and $M_p$.

%\noindent \textbf{Input:}

%\noindent Repeat steps (a), (b) below until $\cU=\emptyset$.
\begin{enumerate}
%\noindent Initialize:
\item[Step (a)] Let
\[
L_p \leftarrow \cL_p, \qquad M_p \leftarrow \cM_p,
\]
where $\cL_p$, $\cM_p$ are computed by Algorithm~\ref{alg1}.
\item[Step (b)] If $p \mid a_0$ then terminate the algorithm,
and output $L_p$, $M_p$. Else
let
\[
t \leftarrow 2, \qquad
\cU \leftarrow \{pw \; : \; w \in \{0,1,\dots,p-1\} \}.
\]
\item[Step (c)] Let
\[
 \cU^\prime \leftarrow \emptyset.
\]
Loop through the elements $u \in \cU$.
Let
\[
\cP_u=\{\fq \mid p \; : \;
\ord_\fq(a_0-u\theta ) \ge t \cdot e(\fq/p)\},
\]
and
\[
\fb_u=\prod_{\fq \mid p} \fq^{\min\{\ord_\fq(a_0-u\theta ), t \cdot e(\fq/p)\}}
=(a_0-u\theta) \OO_K+p^t \OO_K.
\]
\begin{enumerate}
\item[(i)] If $\cP_u=\emptyset$
then
\[
L_p \leftarrow L_p \cup \{\fb_u\}.
\]
\item[(iii)] Else
\[
\cU^\prime \leftarrow \cU^\prime \cup \{ u+p^{t}w : w \in \{0,\dotsc,p-1\} \}.
\]
\end{enumerate}
\item[Step (d)] If $\cU^\prime \ne \emptyset$ then let
\[
t \leftarrow t+1, \qquad
\cU \leftarrow \cU^\prime,
\]
and return to Step (c). Else output $L_p$, $M_p$.
\end{enumerate}
%\noindent \textbf{Output:} $\cL_p$, $\cM_p$.
\end{alg}

\begin{lem}
Algorithm~\ref{alg2} terminates.
\end{lem}
\begin{proof}
Suppose that the algorithm does not terminate.
From Step (b) we know that $p \nmid a_0$ in this case.
Let $t_0=2$
and $t_i=t_0+i$. Then there is an infinite sequence $\{u_i\}$
such that $u_{i+1} \equiv u_i \pmod{t_i}$ and so that
$\cP_{u_i} \ne \emptyset$. Moreover, $p \mid u_0$.
Let $\alpha$ be the limit of $\{u_i\}$ in $\Z_p$.
By the pigeon-hole principle there is some $\fp \mid p$
appearing in infinitely many $\cP_{u_i}$,
and so $\ord_\fp(a_0 -u_i \theta) \ge t_i \cdot e(\fp/p)$.
Thus
$a_0-\alpha \theta=0$ in $K_\fp$. But as $p \mid u_0$, we
have $\ord_p(\alpha) \ge 1$. However, $p \nmid a_0$ and so $\ord_\fp(\theta)<0$.
This contradicts the fact that $\theta$ is an algebraic
integer. Therefore the algorithm does terminate.
\end{proof}
\begin{prop}\label{prop:pirlfinal}
The pair $L_p$, $M_p$ produced by Algorithm~\ref{alg2}
is satisfactory.
\end{prop}
\begin{proof}
Now let $(X,Y)$ be a solution to \eqref{eqn:TM}.
In view of Lemma~\ref{lem:alg1correct}
we may suppose $p \mid Y$.
Recall that one of the restrictions we imposed on the solution
$(X,Y)$ is $(a_0,Y)=1$. Thus $p \nmid a_0$ which is why we exist
the algorithm at Step (b) if $p \mid a_0$.
Let $y=Y/X$.
Thus $\ord_\fq(a_0 X-Y\theta)=\ord_\fq(a_0 -y \theta)$.
The rest of the proof is similar to the proof of Lemma~\ref{lem:alg1correct}.
\end{proof}
\end{comment}

\medskip

\noindent \textbf{Refinements.}
Let $L_p$, $M_p$ be a satisfactory pair (for example,
produced by Algorithm~\ref{alg1}). We explain
here some obvious refinements that will reduce or simplify
these sets, whilst maintaining the satisfactory property.
\begin{itemize}
\item If some pair $(\fb,\fp)$ is in $M_p$ then
we may replace this with the pair $(\fb^\prime,\fp)$ where
\[
\fb^\prime=\frac{\fb}{\fp^{\ord_\fp(\fb)}} \, .
\]
\item If some $\fb$ is contained in $L_p$, and some $(\fb^\prime,\fp)$
is contained in $M_p$ with $\fb^\prime \mid \fb$ and $\fb/\fb^\prime=\fp^w$
for some $w \ge 0$, then we may delete $\fb$ from $L_p$.
\item Suppose $p \mid a_0$.
Observe that if
 $\fb \in L_p$ is the $p$-part of $(a_0 X- \theta Y) \OO_K$ then
 $\ord_p(\Norm(a_0 X- \theta Y))=\ord_p(\Norm(\fb))$.
However, it is clear that $\ord_p(\Norm(a_0 X-\theta Y)) \ge (d-1) \ord_p(a_0)$. Thus, we may delete $\fb$ from $L_p$ if $\ord_p(\Norm(\fb))< (d-1) \ord_p(a_0)$.
\end{itemize}

%-------------------------------------------------------------------------------------------%
%-------------------------------------------------------------------------------------------%

\section{An Equation in Ideals} \label{sec:eq-in-ideals}

For every $p \in P:=\{p_1,\dotsc,p_v\}$ we let $L_p$, $M_p$ be a corresponding satisfactory pair. From Definition \ref{defn:sat}, we see that there is some partition  $P=P_1 \cup P_2$ such that for every $p \in P_1$, the $p$-part of $(a_0 X- \theta Y) \OO_K$ equals $\fb \fp^{l}$ for some $(\fb,\fp) \in M_p$ and $l \ge 0$, and for every $p \in P_2$, it equals some $\mathfrak{b} \in L_p$. Let $P=P_1 \cup P_2$ be a partition of $P$ and write
\[
P_1=\{q_1,\dotsc,q_{s}\}, \qquad P_2=\{q_{s+1},\dotsc,q_v\}.
\]
Let $\mathcal{Z}_{P_1,P_2}$ be the set of all pairs $(\fa,S)$
such that
there are $(\fb_i,\fp_i) \in M_{q_i}$ for $1 \le i \le s$,
and $\fb_j \in L_{q_j}$ for $s+1 \le j \le v$
satisfying
\[
\fa= \fb_0\cdot\fb_1 \fb_2 \cdots \fb_s \cdot \fb_{s+1} \cdots \fb_v, \qquad
S=\{\fp_1,\dotsc,\fp_s\},
\]
where $\fb_0$ denotes an ideal of $\OO_K$ of norm
  \[R = \bigg|\frac{a\cdot a_0^{d-1}}{\gcd(\Norm(\fb_1 \cdots\fb_v),a\cdot a_0^{d-1})}\bigg|.\]

Let
\[
\mathcal{Z} \; := \; \bigcup_{P_1 \subseteq P}
\mathcal{Z}_{P_1,P-P_1}.
\]
\begin{prop}\label{prop:Sprop}
Let $(X,Y)$ be a solution to
\eqref{eqn:TM}. Then there is some $(\fa,S) \in \mathcal{Z}$
such that
\begin{equation}\label{eqn:TMfactored}
(a_0 X- \theta Y)\OO_K=\fa \cdot \fp_1^{n_1}\cdots \fp_s^{n_s}
\end{equation}
where
$S=\{\fp_1,\dotsc,\fp_s\}$, and $n_1,\dotsc,n_s$
are non-negative integer. Moreover, the set $S$ has the following
properties:
\begin{enumerate}
\item[(a)] $e(\fp_i|q_i)=f(\fp_i|q_i)=1$ for $1 \le i \le s$.
\item[(b)] Let $1 \le i \le s$. Let $p$ be the unique rational
prime below $\fp_i$. Then $\fp_j \nmid p$ for all $1 \le j \le s$
with $j \ne i$.
\end{enumerate}
\end{prop}

To solve \eqref{eqn:TM}, we will solve \eqref{eqn:TMfactored}
for every possible choice of $(\fa,S) \in \mathcal{Z}$.

\medskip

\noindent\textbf{Remark.} Observe that for any $(\fa,S) \in \mathcal{Z}$, there may be several possibilities for $\fb_0$. Let $\mathcal{R}$ denote the set of all ideals $\fb_0$ having norm $R$ for some $(\fa,S) \in \mathcal{Z}$. Here, we provide a simple refinement to cut down the number of ideals in $\mathcal{R}$. In particular, we apply Algorithm~\ref{alg1} and Lemma~\ref{lem:adequate} to each rational prime $p$ dividing $R$, generating the corresponding sets $M_p$ and $L_p$. For each $\fb_0 \in \mathcal{R}$, if the $p$-part of $\fb_0$ cannot be made up of any of the elements of $M_p$ or $L_p$, we may remove $\fb_0$ from $\mathcal{R}$. Moreover, if this process yields $\mathcal{R} = \emptyset$, we may remove $(\fa,S)$ from $\mathcal{Z}$.

\begin{comment}
\section{Implementation}

In the file \texttt{SamirProgs.m} you'll find my implementation of this stuff.
The command \texttt{prep2} produces the lists of possibilities for
$\alpha$, $\gamma_1,\dotsc,\gamma_u$, the matrix $A$, and the vector $\rr$.
For the example given in \texttt{New6PirlTMlog.txt}:
\[
F=[7,1,29,-25], \qquad
F(X,Y)=2^{z_1} 3^{z_2} 7^{z_3} 37^{z_4} 53^{z_5},
\]
I obtain $38$ possibilities (i.e. there will be $38$ $S$-unit
equations to solve).
\end{comment}

%-------------------------------------------------------------------------------------------%

%\subsection*{Example 3 continued}
%We revisit Example $3$ to provide more details on our resolution of
%\[F(X,Y) = -2^5 \cdot 3^4 \cdot 5^{z_1} \cdot 11^{z_2}.\]
%\edit{(should do this when my internet isn't crashing every other minute..)}

\subsection*{Example 3 continued}
We revisit Example 3 to provide more details on our resolution of
\[F(X,Y) = -2^5 \cdot 3^4 \cdot 5^{z_1} \cdot 11^{z_2},\]
where $F$ is given in \eqref{eqn:FST}.
We first note the decomposition into prime ideals of $5$ and $11$ in $\OO_K$:
\[
5 \cdot \OO_K \, =\, \fp_{5,1}^5, \qquad
	11 \cdot \OO_K \,=\, \fp_{11,1}^2\cdot \fp_{11,2}^2\cdot \fp_{11,3}
\]
where
\begin{align*}
\fp_{5,1} & = \Big\langle 5,\ \frac{1}{23760}(\theta^4 + 8\theta^3 + 1410\theta^2 + 46512\theta + 33669)\Big\rangle, \\
\fp_{11,1} &= \Big\langle 11,\ \frac{1}{990}(\theta^3 + 227\theta^2 + 5583\theta + 14859)\Big\rangle, \\
\fp_{11,2} &= \Big\langle 11,\ \frac{1}{15840}(\theta^4 + 20\theta^3 + 10734\theta^2 + 126708\theta + 172377)\Big\rangle,\\
\fp_{11,3} & = \Big\langle 11,\ \frac{1}{24}(\theta^2 + 14\theta + 117)\Big\rangle,
\end{align*}
are all degree $1$ prime ideals (specified using the standard $2$-element representation).
Applying Algorithm~\ref{alg1} and Lemma~\ref{lem:adequate} to each of these rational primes, we thus obtain the following possibilities for satisfactory pairs $M_p$, $L_p$:
\begin{align*}
	M_{11} & = \{(1\cdot \OO_K,\ \fp_{11,3})\} \quad \text{ and } \quad L_{11} = \{\fp_{11,1}\cdot \fp_{11,2}\},\\
  M_5 & = \emptyset \quad \text{ and } \quad L_5 = \{ 1 \cdot \OO_K\} \quad \text{ or } \quad L_5 = \{\fp_{5,1}^2\}.
\end{align*}
Now, we have $4$ possible ideal equations of the form $(a_0 X- \theta Y)\OO_K$,
\begin{equation}\label{eqn:fb0}
(a_0 X- \theta Y)\OO_K
= \begin{cases}
\fb_0 \cdot \fp_{11,1}\cdot \fp_{11,2}, & \text{where } S = \emptyset,\\
\fb_0 \cdot \fp_{5,1}^2 \cdot \fp_{11,1}\cdot \fp_{11,2}, & \text{where } S = \emptyset,\\
\fb_0 \cdot \fp_{11,3}^{n_1}, & \text{where } S = \{\fp_{11,3}\}\\
\fb_0 \cdot \fp_{5,1}^2 \cdot\fp_{11,3}^{n_1}, & \text{where } S = \{\fp_{11,3}\}.
\end{cases}
\end{equation}
In each case, $\fb_0$ is an ideal of $\OO_K$ of norm $R = 2^5\cdot 3^8$. To compute this ideal, we first note that
\[2\cdot \OO_K \, = \, \fp_{2,1}^5, \qquad   3 \cdot \OO_K \, =\, \fp_{3,1}\fp_{3,2},\]
where
\[
\fp_{2,1} \,=\,
\Big\langle 2, \frac{1}{7920}(\theta^3 + 557\theta^2 + 4263\theta + 6939)\Big\rangle, \quad
\fp_{3,1} \, =\,  \Big\langle 3, \frac{1}{2}(\theta + 11)\Big\rangle, \quad \fp_{3,2} \, =\, \langle 3, \theta + 3\rangle;
\]
the ideals $\fp_{2,1}$ and $\fp_{3,1}$ have degree $1$, and the ideal $\fp_{3,2}$ has degree $4$.
Applying Algorithm~\ref{alg1} to $p = 2$ and $p = 3$, we obtain
\begin{align*}
  M_3 & = \emptyset \quad \text{ and } \quad L_3 = \{\fp_{3,2}\},\\
  M_2 & = \emptyset \quad \text{ and } \quad L_2 = \{ 1\cdot \OO_K\} \quad \text{ or } \quad L_2 = \{\fp_{2,1}^5\} \quad \text{ or } \quad L_2 = \{\fp_{2,1}^8\}.
\end{align*}
The $p$-part of $\fb_0$ is composed of these sets $M_p$, $L_p$. In particular, the only possible $2$-part of $\fb_0$ is $\fp_{2,1}^5$ as $\ord_2(\Norm(\fp_{2,1}^5)) = 5 = \ord_2(R)$. However, since
\[\ord_3(\Norm(\fp_{3,2})) = 4 \neq 8 = \ord_3(R),\]
the $3$-part of $\fb_0$ cannot be made up of any elements of $M_3$ or $L_3$. In other words, there are no ideals $\fb_0$
having norm $R = 2^5\cdot 3^8$ satisfying \eqref{eqn:fb0}.
Thus none of the $4$ ideal equations listed in \eqref{eqn:fb0} are possible.
We may thus conclude that the Thue--Mahler equation
\[
	F(X,Y) = -2^5 \cdot 3^4 \cdot 5^{z_1} \cdot 11^{z_2}, \qquad \gcd(X,Y)=\gcd(3,Y)=1
\]
has no solutions.
Moreover, we may also conclude that there are no ideals $\fb_0$ having norm $3^8$ and therefore the Thue--Mahler form
$F(X,Y) = \pm 3^4 \cdot m$ has no solutions for any $m$ coprime to $3$.

%-------------------------------------------------------------------------------------------%
%-------------------------------------------------------------------------------------------%

\section{Making the Ideals Principal}
\label{sec:making-ideals-princ}

From now on we fix $(\fa,S) \in \mathcal{Z}$ and
we focus on a solution of \eqref{eqn:TMfactored}.
The method of Tzanakis and de Weger \cite{TW} reduces
\eqref{eqn:TMfactored}
to at most $(m/2) \cdot h^s$ $S$-unit equations, where $m$
is the number of roots of unity and $h$ is the class number of $K$. Our method,
explained below, gives at most only $m/2$ $S$-unit equations.

Given an ideal $\fb$ of $\OO_K$, we denote its class in
the class group $\Cl(K)$ by $[\fb]$.
\begin{lem}
Let
\[
\phi : \Z^s \rightarrow \Cl(K), \qquad (m_1,\dotsc,m_s)
\mapsto [\fp_1]^{m_1}\cdots [\fp_s]^{m_s}.
\]
\begin{enumerate}
\item[(a)] If $[\fa]^{-1}$ is not in the image of $\phi$ then
\eqref{eqn:TMfactored} has no solutions.
\item[(b)] Suppose $[\fa]^{-1}=\phi(\rr)$,
where $\rr=(r_1,\dotsc,r_s)$. Let $\zeta$
be a generator of the roots of unity in $K$,
and suppose it has order $m$.
Let $\delta_1,\dotsc,\delta_r$ be a basis
for the group of $S$-units $\OO_S^\times$
modulo the torsion subgroup $\langle \zeta \rangle$.
Let $\alpha$ be a generator of the principal
ideal $\fa \cdot \fp_1^{r_1} \cdots \fp_s^{r_s}$.
Let $(X,Y)$ satisfy \eqref{eqn:TMfactored}.
Then, after possibly replacing $(X,Y)$ by $(-X,-Y)$,
we have
\begin{equation}\label{eqn:taudeltaorig}
a_0 X- \theta Y \; = \; \tau \cdot \delta_1^{b_1} \cdots \delta_r^{b_r}
\end{equation}
where $\tau=\zeta^{a} \cdot \alpha$ with $0 \le a \le \frac{m}{2}-1$,
and $b_1,\dotsc,b_r \in \Z$.
\end{enumerate}
\end{lem}
\begin{proof}
Note that if \eqref{eqn:TMfactored} has a solution
$\nn=(n_1,\dotsc,n_s)$ then
\[
\phi(\nn)=[\fa]^{-1}.
\]
This proves $(a)$.
For $(b)$, suppose $[\fa]^{-1}=\phi(r_1,\dotsc,r_s)$. Thus $\fa \cdot \fp_1^{r_1} \cdots \fp_s^{r_s}$ is principal
and we let $\alpha$ be a generator. Then the fractional ideal
$((a_0X-\theta Y)/\alpha) \OO_K$ is supported on $S=\{\fp_1,\dotsc,\fp_s\}$.
Hence $(a_0X-\theta Y)/\alpha \in \OO_S^\times$.
Now $\zeta,\delta_1,\dotsc,\delta_r$ is a basis for the $S$-unit
group. Thus \eqref{eqn:taudeltaorig} holds
for some $0\le a \le m-1$, and $b_1,\dotsc,b_r \in \Z$.
However $\zeta^{m/2}=-1$. Thus we can suppose
$0 \le a \le m/2-1$ by replacing $(X,Y)$ by $(-X,-Y)$
if necessary.
\end{proof}

\begin{comment}
We can compute the image and kernel of this map in \texttt{Magma}.
Note that if \eqref{eqn:TMfactored} has a solution
$\nn=(n_1,\dotsc,n_s)$ then, by \eqref{eqn:TMfactored},
\[
\phi(\nn)=[\fa]^{-1}.
\]
In particular, if $[\fa]^{-1}$ does not belong to the image of $\phi$
then \eqref{eqn:TMfactored} has no solutions. We therefore
suppose that $[\fa]^{-1}$ belongs to the image, and compute
a preimage $\rr=(r_1,\dotsc,r_u)$ using \texttt{Magma}.
Then $\nn-\rr$ belongs to the kernel
of $\phi$. The kernel is a subgroup of $\Z^u$ of rank $u$.
Let $\aaf_1,\dotsc,\aaf_u$ be a basis for the kernel.
Let
\[
\nn-\rr=m_1 \aaf_1+\cdots+m_u \aaf_u
\]
where the $m_i \in \Z$. Let $A$ be the matrix with columns
$\aaf_1,\dotsc,\aaf_u$. Then $\nn=\mm A+\rr$ where $\mm=(m_1,\dotsc,m_u)$.
%The important thing for us is that $A$ is invertible. In fact its
%determinant is (up to sign) equal to $\#\img(\phi)$ and so
%divides the class number. As $A$ is invertible, there are
%positive constants $C_1$, $C_2$ such that
%\[
% H(\nn) \le C_1 H(\mm), \qquad H(\mm) \le C_2 H(\nn).
%\]
For $\aaf=(a_1,\dotsc,a_u) \in \Z^u$ we adopt the notation
\[
\underaccent{\tilde}{\fp}^\aaf :=\fp_1^{a_1}\cdot \fp_2^{a_2}\cdot \cdots \cdot\fp_u^{a_u}.
\]
Let
\[
\fc_1=\underaccent{\tilde}{\fp}^{\aaf_1},\dotsc,\fc_u=\underaccent{\tilde}{\fp}^{\aaf_u}.
\]
Then we can rewrite \eqref{eqn:TMfactored} as
\[
(a_0 X-\theta Y) \OO_K=
\fa \cdot \underaccent{\tilde}{\fp}^{\nn}
=
\fa \cdot \underaccent{\tilde}{\fp}^{\rr+m_1 \aaf_1+ \cdots+m_u \aaf_u}
=
(\fa \cdot \underaccent{\tilde}{\fp}^\rr) \cdot \fc_1^{m_1}\cdots \fc_u^{m_u}.
\]
Now
\[
[\fa \cdot \underaccent{\tilde}{\fp}^\rr]
=[\fa] \cdot [\fp_1]^{r_1}\cdots [\fp_u]^{r_u}=
[\fa]\cdot \phi(r_1,\dotsc,r_u)=[1]
\]
as $\phi(r_1,\dotsc,r_u)=[\fa]^{-1}$ by construction. Thus
\begin{equation}\label{eqn:alphafactor}
\fa \cdot \underaccent{\tilde}{\fp}^\rr=\alpha \cdot \OO_K
\end{equation}
for some $\alpha \in K^*$ (note that some of the $r_i$
might be negative so we don't expect $\alpha$ to
be an algebraic integer
in general).
We also find that
\[
[\fc_j]=[\underaccent{\tilde}{\fp}^{\aaf_j}]=\phi(\aaf_j)=[1]
\]
as the $\aaf_j$ are a basis for the kernel fo $\phi$. Thus
there are $\gamma_j \in K^*$ such that $\fc_j=\gamma_j \OO_K$.
Thus we have rewritten \eqref{eqn:TMfactored} as
\begin{equation}\label{eqn:TMprincipal}
(a_0 X- Y\theta) \OO_K=\alpha \cdot \gamma_1^{m_1} \cdots \gamma_u^{m_u} \OO_K.
\end{equation}
Note that the number of cases has not increased. If $[\aaf]^{-1}$
is not in the image of $\phi$ then we have a contradiction.
If $[\aaf]^{-1}$ is in the image of $\phi$ then
we obtain one corresponding equation \eqref{eqn:TMprincipal}.

\bigskip

Now let $\epsilon_1,\dotsc,\epsilon_v$ be system of fundamental
units. Then
\[
a_0 X- Y\theta=\tau \cdot \epsilon_1^{\ell_1} \cdots \epsilon_v^{\ell_v}
\cdot  \gamma_1^{m_1} \cdots \gamma_u^{m_u}
\]
where $\ell_1,\dotsc,\ell_v \in \Z$, and $\tau=\zeta \cdot \alpha$
where $\zeta$ is some root of unity in $K$.
The number of possibilities for
$\tau$ is $1/2$ of the number of roots of unity in $K$
(as we can absorb $\pm 1$ in the $X$, $Y$). From this
we can write down an $S$-unit equation by taking three conjugates
of the equation and using the Siegel identity.
\end{comment}

\begin{lem}\label{lem:tauden}
The denominator of the fractional ideal $\tau \OO_K$
is supported on the set of prime ideals ${S=\{\fp_1,\dotsc,\fp_s\}}$.
\end{lem}
\begin{proof}
This follows immediately from \eqref{eqn:taudeltaorig}
since $\delta_1,\dotsc,\delta_r$ are $S$-units.
\end{proof}

We have reduced the task of solving our original
Thue--Mahler equation \eqref{eqn:TM} to solving
equations of the form
\begin{equation}\label{eqn:TMdelta}
a_0 X- \theta Y=\tau \cdot \delta_1^{b_1} \cdots \delta_r^{b_r},
\end{equation}
subject to the conditions
\begin{equation}\label{eqn:restrictions}
X,~Y \in \Z, \quad \gcd(X,Y)=1, \quad \gcd(a_0,Y)=1, \quad
b_i \in \Z.
\end{equation}
We will tackle each of these equations separately.
In \cite{TW}, the authors work in the field
generated by three conjugates of $\theta$
and its completions. This is fine theoretically
but difficult computationally. We will work
with that extension theoretically simply to obtain
a bound for
\begin{equation}\label{eqn:B}
B:=\max(\lvert b_1\rvert,\dotsc,\lvert b_r\rvert,1).
\end{equation}
(The reason for including 1 in this set will be made clear in Section~\ref{sec:sunit}.)
To reduce the bound, we must do some computations and
these will only take place in $K$, $\R$, $\C$,
but not in extensions of $K$, and certainly not in
extensions of $\Q_p$.

To obtain our initial bound for $B$ we shall mostly
follow ideas found in \cite{BG}, \cite{IntegralHyp},
\cite{Homero}. However, we have a key advantage
that will allow us to obtain sharper bounds:
namely we assume knowledge of the $S$-unit basis
$\delta_1,\dotsc,\delta_r$ rather than working
with estimates for the size of a basis.

%-------------------------------------------------------------------------------------------%

\begin{comment}
\subsection*{Examples continued \edit{(recompute examples)}}
Table~\ref{table1} gives some data for Examples 1--5.
We would like to stress the main difference between our approach and that of Tzanakis and de Weger \cite{TW} \edit{at this stage of the algorithm}.
When dealing with \eqref{eqn:TMfactored}, they write each exponent $n_i$ as $n_i=k_i h_i + m_i$, where \edit{$h_i$ is the order of $\fp$ in the class group of $\OO_K$ and} $0 \le m_i \le h_i-1$. Now $\fp_i^{h_i}$ is principal and we may write it as
$\beta_i \cdot \OO_K$. It follows from \eqref{eqn:TMfactored}
that $\fa \cdot \fp_1^{m_1} \cdots \cdot \fp_s^{m_s}$ is principal.
\edit{Clearly $h_i|h$ and} there are \edit{at most} $h^s$ possibilities for this ideal. \edit{In the worst case, we expect around
$h^{s-1}$ ideals }to be principal, and so of the form $\tau \OO_K$.
\edit{Generally,} Tzanakis and de Weger obtain around $h^{s-1}$ equations of the form
\[
(a_0 X-\theta Y) \cdot \OO_K \; = \; \tau \cdot \beta_1^{k_1} \cdots \cdot \beta_s^{k_s} \cdot \OO_K,
\]
although they test $h^s$ ideals to see if they are principal.
This results in a huge explosion of cases when $h$ is non-trivial, \edit{where it is often the case that $h_i = h$.}
For instance, in our Example 2, the class number is $33$.
There are $16$ possibilities for $(\fa,S)$ in $\mathcal{Z}$.
\edit{(We should include the order of the ideals.)}
The $16$ possible values for $s=\#S$ are
\[
0,~ 0,~ 1,~ 1,~ 1,~ 1,~ 1,~ 1,~ 2,~ 2,~ 2,~ 2,~ 2,~ 2,~ 3,~ 3.
\]
Following the method of Tzanakis and de Weger we needed to
check $78608$ ideals if they are principal, and this approach
leads to
$2382$ equations of the form~\eqref{eqn:TMdelta}.
With our approach, \edit{as we need only test $m/2$ ideal equations with $m = $, we expect at most $16$ $S$-unit equations. Indeed, in doing so,} we obtain merely $14$ equations of the
form~\eqref{eqn:TMdelta}.

\begin{table}[h]
\begin{tabular}{|c|c|c|c|}
\hline
& $\#\mathcal{Z}$ & number of $(\tau,\delta_1,\dotsc,\delta_r)$ & rank frequencies\\
\hline\hline
Example 1 & $16$ & $16$ & $(1, 2)$, $(2, 6)$, $(3, 6)$, $(4, 2)$\\
\hline
Example 2 & $16$ & $14$ & $ (2, 6)$, $(3, 6)$, $(4, 2)$\\
\hline
Example 3 & $12$ & $12$ & $(7, 6)$, $(8, 6)$\\
\hline
Example 4 & $2048$ & $2048$ & $(10,2048)$\\
\hline
Example 5 & $4$ & $4$ & $(9,2)$, $(10,2)$\\
\hline\hline
\end{tabular}
\vspace{0.5em}
\caption{This table gives the sizes of the set
$\mathcal{Z}$, the number of resulting $(\tau,\delta_1,\dotsc,\delta_r)$
for Examples 1--5. The last column is a list of pairs
$(r,t)$ meaning there are $t$ cases where the $S$-unit
rank is $r$.}\label{table1}
\end{table}
\end{comment}

\subsection*{Examples continued}
Table~\ref{table1} gives some data for Examples 1--5.
At this stage of the algorithm, we would like to stress the main difference between our approach and that of Tzanakis and de Weger \cite{TW}. When dealing with
\[(a_0 X- \theta Y)\OO_K=\fa \cdot \fp_1^{n_1}\cdots \fp_s^{n_s},\]
they write each exponent $n_i$ as $n_i=k_i h_i + m_i$, where $h_i$ is the order of $\fp_i$ in the class group of $\OO_K$ and $0 \le m_i \le h_i-1$. Now $\fp_i^{h_i}$ is principal and we may write it as
$(\beta_i) \OO_K$. It follows from \eqref{eqn:TMfactored}
that $\fa \cdot \fp_1^{m_1} \cdots \cdot \fp_s^{m_s}$ is principal. Clearly $h_i|h$ and there are at most $h^s$ possibilities for this ideal. In the worst case, we expect around
$h^{s-1}$ ideals to be principal, and so of the form $(\tau) \OO_K$.
%Generally, Tzanakis and de Weger obtain around $h^{s-1}$ equations of the form
%\[
%(a_0 X-\theta Y)\OO_K \; = \; (\tau \cdot \beta_1^{k_1} \cdots \cdot \beta_s^{k_s}) \OO_K,
%\]
%although they test $h^s$ ideals to see if they are principal.
This results in a huge explosion of cases when $h$ is non-trivial, as it is often the case that $h_i = h$.
For instance, in our Example 2, the class number is $33$.
There are $16$ possibilities for $(\fa,S)$ in $\mathcal{Z}$.
The $16$ possible values for $s=\#S$ are
\[
0,~ 0,~ 1,~ 1,~ 1,~ 1,~ 1,~ 1,~ 2,~ 2,~ 2,~ 2,~ 2,~ 2,~ 3,~ 3,
\]
where all possible ideals in $S$ have order $33$ in $\OO_K$. Following the method of Tzanakis and de Weger, we would need to
check $78608$ ideals if they are principal, and this approach
leads to
$2382$ equations of the form~\eqref{eqn:TMdelta}.
With our approach, as we need only to deal with
$16$ ideal equations, we expect to deal with at most $16$ equations of the form \eqref{eqn:TMdelta}.
Indeed, in doing so, we obtain merely $14$ equations of the
form~\eqref{eqn:TMdelta}.

\begin{table}[h]
\begin{tabular}{|c|c|c|c|}
\hline
& $\#\mathcal{Z}$ & number of $(\tau,\delta_1,\dotsc,\delta_r)$ & rank frequencies\\
\hline\hline
Example 1 & $16$ & $16$ & $(1, 2)$, $(2, 6)$, $(3, 6)$, $(4, 2)$\\
\hline
Example 2 & $16$ & $14$ & $ (2, 6)$, $(3, 6)$, $(4, 2)$\\
\hline
Example 3 & $12$ & $12$ & $(7, 6)$, $(8, 6)$\\
\hline
Example 4 & $4096$ & $4096$ & $(10,4096)$\\
\hline
Example 5 & $2$ & $2$ & $(9,1)$, $(10,1)$\\
\hline\hline
\end{tabular}
\vspace{0.5em}
\caption{This table gives the sizes of the set
$\mathcal{Z}$, the number of resulting $(\tau,\delta_1,\dotsc,\delta_r)$
for Examples 1--5. The last column is a list of pairs
$(r,t)$ meaning there are $t$ cases where the $S$-unit
rank is $r$.}\label{table1}
\end{table}


%-------------------------------------------------------------------------------------------%
%-------------------------------------------------------------------------------------------%

\section{Lower Bounds for Linear Forms in Logarithms}\label{sec:lower-bounds}

In this section, we state theorems of Matveev \cite{Matveev} and of Yu \cite{Yu} for lower bounds for linear forms in complex and $p$-adic logarithms. In the next section, we will use these results to obtain bounds for $b_1, \dots, b_r$. We begin by establishing some notation, as well as some key results which we will need for the lower bound.

\begin{tabular}{ccl}
$L$ & \qquad & a number field.\\
$D$ & & the degree $[L:\Q]$.\\
$M_L$ & \qquad & the set of all places of $L$.\\
$M_L^\infty$ & & the subset of infinite places.\\
$M_L^{0}$ & & the subset of finite places.\\
$\nu$ & & a place of $L$.\\
$D_\nu$ & & the local degree $[L_\nu : \Q_\nu]$.\\
$\lvert \cdot \rvert_\nu$ & & the usual normalized absolute value
associated to $\nu$. \\
&& If $\nu$ is infinite and associated to
a real or complex embedding $\sigma$ of $L$, \\
&& then $\lvert \alpha \rvert_\nu=\lvert \sigma(\alpha) \rvert$.\\
&& If $\nu$ is finite and above the rational prime $p$,
then $\lvert p \rvert_\nu=p^{-1}$.\\
$\lVert \cdot \rVert_\nu$ && $=\lvert \cdot \rvert_\nu^{D_\nu}$.\\
$h(\cdot)$ && the absolute logarithmic height, defined in
\eqref{eqn:heightdef}.
\end{tabular}

Let $L$ be a number field of degree $D$ over $\Q$.
We shall write $M_L$ for the set of all places
of $L$,
and $M_L^\infty$, $M_L^{0}$ for the subset of infinite and finite places, respectively.
For $\nu \in M_L$,
we let $\lvert \cdot \rvert_\nu$ denote the
usual normalized absolute value corresponding to $\nu$.
If $\nu$ is finite
and $p$ is the rational prime below $\nu$,
then $\lvert p \rvert_\nu=p^{-1}$.
We denote
by $D_\nu$ the local degree $[L_\nu:\Q_\nu]$,
and define
\begin{equation}\label{eqn:normdef}
\lVert \alpha \rVert_\nu=\lvert \alpha \rvert_\nu^{D_\nu}.
\end{equation}
The product formula may be stated as
\begin{equation}\label{eqn:productformula}
\prod_{\nu \in M_L} \lVert \alpha \rVert_\nu=1
\end{equation}
for all $\alpha \in L^\times$.
In particular, if $\nu$
is infinite, corresponding to a real or complex
embedding $\sigma$ of $L$, then
\begin{equation}\label{eqn:arch}
\lvert \alpha \rvert_\nu=\lvert \sigma(\alpha) \rvert,
\qquad
\text{and}
\qquad
\lVert \alpha \rVert_\nu=
\begin{cases}
\lvert \sigma(\alpha) \rvert & \text{if $\sigma$ is real,}\\
\lvert \sigma(\alpha) \rvert^2 & \text{if $\sigma$ is complex.}
\end{cases}
\end{equation}
If $\nu$ is finite, and $\mP$ is the prime ideal corresponding to
$\nu$, then for $\alpha \in L^\times$ we have
\begin{equation}\label{eqn:normval}
\lVert \alpha \rVert_\nu=\Norm(\mP)^{-\ord_\mP(\alpha)};
\end{equation}
this easily follows from $D_\nu=e(\mP|p)f(\mP|p)$, where
$e(\mP|p)$ and $f(\mP|p)$ are respectively the
ramification index and the inertial degree of $\mP$.

For $\alpha \in L$, we define the absolute logarithmic height
$h(\alpha)$ by
\begin{equation}\label{eqn:heightdef}
h(\alpha)=
\frac{1}{[L:\Q]} \sum_{\nu \in M_L}
D_\nu \log \max\{1, \lvert \alpha \rvert_\nu\}
=
\frac{1}{[L:\Q]} \sum_{\nu \in M_L}
\log \max\{1, \lVert \alpha \rVert_\nu\}.
\end{equation}
\begin{lem}\label{lem:conjheight}
The absolute logarithmic height of an algebraic number $\alpha$ is independent
of the number field $L$ containing $\alpha$.
Moreover, if $\alpha$ and $\beta$ are Galois conjugates, then
$h(\alpha)=h(\beta)$.
\end{lem}
For proofs of the following two lemmata,
see \cite[Lemma 4.1]{IntegralHyp}
and \cite[Lemma 3.2]{Homero}.
\begin{lem}\label{lem:heightsum}
For $\alpha_1,\dotsc,\alpha_n \in L$ we have
\[
h(\alpha_1\cdots \alpha_n) \le h(\alpha_1)+\cdots+h(\alpha_n),
\quad
h(\alpha_1+\cdots+\alpha_n) \le \log{n}+h(\alpha_1)+\cdots+h(\alpha_n).
\]
For any $\alpha \in L^\times$, we have $h(\alpha)=h(\alpha^{-1})$.
Moreover, for any place $\nu \in M_L$,
\begin{equation}\label{eqn:logheightbd}
\log{\lVert \alpha \rVert_\nu} \le [L:\Q] \cdot h(\alpha).
\end{equation}
\end{lem}
%\begin{proof}
%For the first part of the lemma see \cite[Lemma 4.1]{IntegralHyp}.
%The second part follows immediately from the definition
%of height.
%\end{proof}

\begin{lem}\label{lem:minimal}
Let $L$ be a number field of degree $D$. Let $\sS$
be a finite set of finite places of $L$. Let $\varepsilon \in \OO_\sS^\times$.
Let $\eta \in M_L$ be a place of $L$ chosen so that
$\lVert \varepsilon \rVert_\eta$ is minimal. Then
$\lVert \varepsilon \rVert_\eta \le 1$ and
\[
h(\varepsilon) \le \frac{(\#M_L^\infty+\#\sS)}{D} \cdot \log(\lVert \varepsilon^{-1} \rVert_\eta).
\]
\end{lem}

%-------------------------------------------------------------------------------------------%

\subsection{Lower bounds for linear forms in $\mP$-adic logarithms}
Let $L$ be a number field of degree $D$. Let $\mP$ be a prime
ideal of $\OO_L$ and let $p$ be a rational prime below $\mP$.
Let $\nu \in M_L^0$ correspond to $\mP$.
Let
$\alpha_1, \dotsc,\alpha_n \in L^\times$. Write
$e=\exp(1)$.

\begin{comment} ORIGINAL VERSION
and
\[
C_1(D,n,\mP)=(16 eD)^{2n+2} \cdot n^{5/2} \cdot \log(2nD) \cdot
\log(2D) \cdot e(\mP/p)^n \cdot \frac{p^{f(\mP/p)}}{\left(f(\mP/p) \cdot \log{p}\right)^2}.
\]
We shall make use of the following theorem of Yu \cite[page 190]{Yu}.
\begin{thm}[K.\ Yu] \label{thm:Yu}
Let $b_1,\dotsc,b_n$ be rational integers and let
\[
B=\max( \lvert b_1 \rvert,\dotsc,\lvert b_n \rvert),
\]
and suppose $B \ge 3$.
Let
\[
\Lambda=\alpha_1^{b_1} \cdots \alpha_n^{b_n}-1,
\]
and suppose $\Lambda \ne 0$.
Then
\[
\ord_\mP(\Lambda) <  C_1(n,d,\mP) \cdot h_1 h_2 \cdots h_n \cdot \log{B}.
\]
\end{thm}
\end{comment}
Let
\begin{equation}
\begin{aligned}
h_j \; & := \; \max\left\{ h(\alpha_j), \, \frac{1}{16 e^2 D^2 }\right\}, \qquad
j=1,\dotsc,n \, ; \\
c_1(n,D) \; & := \; (16 eD)^{2n+2} \cdot n^{5/2} \cdot \log(2nD) \cdot
\log(2D) \, ;\\
c_2(n,\mP) \; & := \; e(\mP|p)^{n} \cdot \frac{p^{f(\mP|p)}}{f(\mP|p) \cdot \log{p}} \, ;\\
c_3(n,D,\mP,\alpha_1,\dotsc,\alpha_n) \; & := \; c_1(n,D) \cdot c_2(n,\mP) \cdot
h_1 \cdots h_n \, .
\end{aligned}
\end{equation}
We shall make use of the following theorem of Yu \cite{Yu}.
\begin{thm}[K.\ Yu] \label{thm:Yu}
Let $b_1,\dotsc,b_n$ be rational integers and let
\[
B=\max( \lvert b_1 \rvert,\dotsc,\lvert b_n \rvert),
\]
and suppose $B \ge 3$.
Let
\[
\Lambda=\alpha_1^{b_1} \cdots \alpha_n^{b_n}-1,
\]
and suppose $\Lambda \ne 0$.
Then
\[
\log{\lVert \Lambda^{-1}\rVert_\nu} \; < \; c_3(n,D,\mP,\alpha_1,\dotsc,\alpha_n) \cdot  \log{B}.
\]
\end{thm}
\begin{proof}
Let
\[
c_4(n,D,\mP) \; := \; (16 eD)^{2n+2} \cdot n^{3/2} \cdot \log(2nD) \cdot
\log(2D) \cdot e(\mP|p)^n \cdot \frac{p^{f(\mP|p)}}{\left(f(\mP|p) \cdot \log{p}\right)^2}.
\]
As stated in \cite[page 190]{Yu},
a consequence of the Yu's Main Theorem is
\[
\ord_\mP(\Lambda) \; <  \; n \cdot c_4(n,D,\mP) \cdot h_1 \cdots h_n \cdot \log{B}.
\]
By \eqref{eqn:normval} we have
\[
\log{\lVert \Lambda^{-1} \rVert_\nu}
\; =\; \log{(\Norm(\mP))} \cdot \ord_\mP(\Lambda)
\; = \; f(\mP|p) \cdot \log{p} \cdot \ord_\mP(\Lambda).
\]
The theorem follows.
\end{proof}

%-------------------------------------------------------------------------------------------%

\subsection{Lower bounds for linear forms in real or complex logarithms}
We continue with the above notation.
Let
\begin{equation}\label{eqn:hjprime}
h_j^\prime= \sqrt{h(\alpha_j)^2+\frac{\pi^2}{D^2}}, \qquad j=1,\dotsc,n.
\end{equation}
The following theorem is a version of Matveev's bound for
linear forms in logarithms \cite{Matveev}.
\begin{thm}[Matveev]\label{thm:Matveev}
%Let $\sigma$ be a real or complex embedding of $L$
%and let $\lvert \cdot \rvert_\nu$ be the corresponding
%absolute value.
Let $\nu$ be an infinite place of $L$.
Suppose
 $\Lambda \ne 0$.
Let
\[
c_5(n,D,\alpha_1,\dotsc,\alpha_n)=
6 \cdot 30^{n+4} \cdot (n+1)^{5.5} \cdot
D^{n+2} \cdot \log(eD) \cdot h_1^\prime \cdots h_n^\prime.
\]
Then
\[
\log{\lVert \Lambda^{-1} \rVert_{\nu}} \; \le \;
  c_5(n,D,\alpha_1,\dotsc,\alpha_n) \cdot (\log(en)+\log{B}).
\]
\end{thm}
\begin{proof}
This in fact follows from a version of Matveev's theorem derived
in \cite{BMS1}. Let $\sigma$ be a real or complex
embedding of $L$ corresponding to $\nu$.
Let
\[
h_j^{\prime\prime}=\max\left\{D h(\alpha_j), \; \lvert \log(\sigma(\alpha_j)) \rvert, \; 0.16\right\},
\]
where $\log(\sigma(\alpha_j))$ is the principal determination of
the logarithm
(i.e.\ the imaginary part of
$\log$ lies in $(-\pi,\pi]$). Let
\[
c_6(n,D)=3 \cdot 30^{n+4} \cdot (n+1)^{5.5} \cdot
D^{2} \cdot \log(eD).
\]
Then Theorem 9.4 of \cite{BMS1} asserts that
\[
\log{\lvert \Lambda \rvert_\nu}
\ge -c_6(n,D) \cdot h_1^{\prime\prime} \cdots h_n^{\prime\prime} \cdot (\log(en)+\log{B}).
\]
Since $\lVert \Lambda \rVert=\lvert \Lambda \rvert^{D_\nu}$,
where $D_\nu$ is either $1$ or $2$, we have
\[
\log{\lVert \Lambda^{-1} \rVert} \le 2 \cdot c_6(n,D) \cdot h_1^{\prime\prime} \cdots h_n^{\prime\prime} \cdot (\log(en)+\log{B}).
\]
Thus it is sufficient to show that
$h_j^{\prime\prime} \le D h_j^\prime$. However,
\[
\log(\sigma(\alpha_j))=\log \lvert \sigma(\alpha_j) \rvert+i \theta
\]
where $-\pi<\theta\le \pi$. But by \eqref{eqn:normdef}
and \eqref{eqn:logheightbd},
\[
\log \lvert \sigma(\alpha_j) \rvert=\frac{1}{D_\nu}
\log \lVert \alpha_j \rVert_\nu \le \log \lVert \alpha_j \rVert_\nu
\le D \cdot h(\alpha_j).
\]
Thus
\[
\lvert \log(\sigma(\alpha_j)) \rvert \; \le \;
\sqrt{D^2 \cdot h(\alpha_j)^2+\pi^2}\; =\; D \cdot h_j^\prime.
\]
It is now clear that $h_j^{\prime\prime} \le D \cdot h_j^\prime$.
\end{proof}

%-------------------------------------------------------------------------------------------%
%-------------------------------------------------------------------------------------------%

\section{The $S$-Unit Equation}\label{sec:sunit}

We now return to the task of studying
the solutions of \eqref{eqn:TMdelta} satisfying
\eqref{eqn:restrictions}. Here, we use the theorems of Matveev and Yu (recalled in the previous section)
to establish bounds for $b_1, \dots, b_r$,
following the ideas of \cite{BG},\cite{IntegralHyp} and \cite{Homero}, and taking
care to keep our constants completely explicit and as small as possible.

We begin by establishing the following notation:

\begin{tabular}{rcl}
$\theta$, $K$ & \qquad & as defined in Section~\ref{sec:intro}.\\
$d$ & & the degree $[K:\Q] \ge 3$.\\
$S$ & & a set $\{\fp_1,\dotsc,\fp_s\}$ of prime ideals of $K$
satisfying \\
& & conditions (a), (b) of Proposition~\ref{prop:Sprop}.\\
$s$ & & the cardinality $\#S$ of the set $S$.\\
$\delta_1,\dotsc,\delta_r$ & & a basis for the $S$-unit group
$\OO_S^\times$ modulo torsion,\\
& & also appearing in \eqref{eqn:TMdelta}.\\
$\tau$ & & a non-zero element of $K$, appearing in \eqref{eqn:TMdelta}.\\
$X$, $Y$, $b_1,\dotsc,b_r$ & & a solution to \eqref{eqn:TMdelta}
satisfying \eqref{eqn:restrictions}.\\
$\varepsilon$ & & $=\delta_1^{b_1} \cdots \delta_r^{b_r}$. Thus
                  \eqref{eqn:TMdelta} can be rewritten as \\
& & $a_0 X-\theta Y= \tau \cdot \varepsilon$.\\
$\mu$ & & $=\tau \cdot \varepsilon=a_0 X- \theta Y$.\\
$B$  & & $=\max(\lvert b_1 \rvert, \dotsc,\lvert b_r\rvert,1)$.\\
$\theta_1$, $\theta_2$, $\theta_3$ & & three conjugates of $\theta$
chosen below, with $\theta=\theta_1$.\\
$L$ & & the extension $\Q(\theta_1,\theta_2,\theta_3) \supseteq K$.\\
$D$ & & the degree $[L:\Q]$.\\
$\sigma_i$ & & the embedding $K \hookrightarrow L$, $\theta \mapsto \theta_i$.\\
$\mu^{(i)}$, $\varepsilon^{(i)}$, $\tau^{(i)}$, $\delta_j^{(i)}$
& & the images of $\mu$, $\varepsilon$, $\tau$, $\delta_j$ under the
embedding $\sigma_i$.\\
$\xi_1$, $\xi_2$, $\xi_3$ & & defined in \eqref{eqn:xi}.\\
\end{tabular}

%We write $\bb=(b_1,\dotsc,b_r) \in \Z^r$.
%Here $\delta_1,\dotsc,\delta_r$ are a basis for the
%$S$-units $\OO_S^\times$ (modulo torsion) where
%$S$ is a set of prime ideals $\fp$ of $\OO_K$
%all satisfying $e(\fp/p)=f(\fp/p)=1$.
%Here $r=r_0+\#S$ where $r_0=\#M_K^\infty-1$ is the unit rank of $\OO_K$.

We want to write down an $S$-unit equation starting
with \eqref{eqn:TMdelta}. For this we will need to work
with three conjugates of $\theta$. Let $d=[K:\Q]$,
and let $\theta_1,\dotsc,\theta_d$ be the conjugates
of $\theta$ in some splitting field $M \supseteq K$.
We shall not need $M$ explicitly, but we assume that
we are able to compute the Galois group $G$ of $M/\Q$
as a transitive permutation group on the conjugates $\theta_i$.
From this we are able to list
all subgroups (up to conjugacy), and for each subgroup
determine if it fixes at least three conjugates of $\theta$.
Let $H$ be a subgroup of $G$ fixing at least three conjugates
of $\theta$ with index $[G:H]$ as small as possible.
Let $L=M^H$ be the fixed field of $H$. Then $L=\Q(\theta_1,\theta_2,\theta_3)$
for some three conjugates of $\theta$ (after a possible reordering
of conjugates) and it has the property that its degree
is minimal amongst all extensions generated by three conjugates.
Write
\[
D:=[G:H]=[L:\Q].
\]
Again we shall not need the field $L$ explicitly,
but only its degree $D$, which we can deduce from the Galois group.
We identify $\theta=\theta_1$, and so can think of $K \subseteq L$.

%Then there are three conjugates $\theta_1$, $\theta_2$, $\theta_3$
%of $\theta$, such
%
%
%Let $\sS$ be the primes
%in the support of $\delta_1,\dotsc,\delta_r$. Recall that every
%$\fp \in \sS$ satisfies $f(\fp/p)=e(\fp/p)=1$
%where $p \in S$ the rational prime below $\fp$. Moreover,
%for every $p$ there is at most one $\fp \in \sS$ above it.
Write
$\mu=a_0 X-\theta Y$.
Let $\varepsilon=\delta_1^{b_1} \cdots \delta_r^{b_r}$.
Then $\mu=\tau \cdot \varepsilon$.
Let $\mu^{(i)}$, $\varepsilon^{(i)}$, $\tau^{(i)}$,
$\delta_j^{(i)}$ be the images of $\mu$, $\varepsilon$, $\tau$,
$\delta_j$ under the embeddings $\sigma_i : K \hookrightarrow L$,
$\theta \mapsto \theta_i$. We observe the following Siegel identity:
\[
(\theta_3-\theta_2) \mu_1+(\theta_1-\theta_3) \mu_2 + (\theta_2-\theta_1) \mu_3=0.
\]
Let
\begin{equation}\label{eqn:xi}
\xi_1=(\theta_3-\theta_2) \cdot \tau_1,
\qquad
\xi_2=(\theta_1-\theta_3) \cdot \tau_2,
\qquad
\xi_3=(\theta_2-\theta_1) \cdot \tau_3.
\end{equation}
Then
\begin{equation}\label{eqn:sunit}
\xi_1 \varepsilon_1+\xi_2 \varepsilon_2+\xi_3 \varepsilon_3=0.
\end{equation}
Note that $\varepsilon_1$ is an $S$-unit in $K$ and $\varepsilon_2$,
$\varepsilon_3$ are Galois conjugates of $\varepsilon$. This
equation will serve as our $S$-unit equation.
We would like to rewrite \eqref{eqn:sunit} in a manner
that makes it convenient to apply Theorems~\ref{thm:Yu}
and~\ref{thm:Matveev}. Observe that \eqref{eqn:sunit} can
be rewritten as
\begin{equation}\label{eqn:sunit2}
\frac{\xi_3 \varepsilon_3}{\xi_1 \varepsilon_1} \; = \;
\left(\frac{-\xi_2}{\xi_1}\right)
\left(\frac{\varepsilon_2}{\varepsilon_1}\right)
\; - \; 1.
\end{equation}
Let
\[
\alpha_j:=\frac{\delta_{j,2}}{\delta_{j,1}} \quad (j=1,\dotsc,r),
\qquad
\alpha_{r+1}:=\frac{-\xi_2}{\xi_1}, \qquad b_{r+1}=1.
\]
Then
\begin{equation}\label{eqn:sunit3}
\frac{\xi_3 \varepsilon_3}{\xi_1 \varepsilon_1} \; = \;
\Lambda
\end{equation}
where
 $\Lambda$ is the  \lq\lq linear form\rq\rq
\[
\Lambda: \; = \; \alpha_1^{b_1} \cdots \alpha_{r+1}^{b_{r+1}} \; - \; 1.
\]
We assume that we know $\theta$, $\tau$ and $\delta_1,\dotsc,\delta_r$
explicitly and can therefore compute their absolute logarithmic
heights. We will use this to estimate the heights of other
algebraic numbers, such as $\xi_i$, $\alpha_j$, without computing their
minimal polynomials.
%Let
%\[
%c_7 \; :=\; h(\theta), \qquad c_8 \; :=\; h(\tau).
%\]
Then, by Lemmas~\ref{lem:conjheight} at \ref{lem:heightsum}
\[
h(\xi_i) \; \le \; c_7, \qquad c_7 \; :=\; \log{2}+2h(\theta)+h(\tau).
\]
\begin{lem}\label{lem:difference}
Let
\[
c_{8} \; := \; 2D c_7.
\]
Let $\nu$ be any place of $L$. Then
\[
\log{\lVert (\varepsilon_3/\varepsilon_1)^{-1} \rVert_\nu}
\; \le \;
\log{\lVert \Lambda^{-1} \rVert_\nu} \; + \; c_{8}.
\]
\end{lem}
\begin{proof}
Note that
\[
\log{\lVert (\varepsilon_3/\varepsilon_1)^{-1} \rVert_\nu}
\; = \;
\log{\lVert \Lambda^{-1} \rVert_\nu} \; + \;
\log{\lVert \xi_3/\xi_1 \rVert_\nu}.
\]
By Lemma~\ref{lem:heightsum}
\[
\log{\lVert \xi_3/\xi_1 \rVert_\nu}
\; \le \;  D \cdot h(\xi_3/\xi_1)
\; \le \; D \cdot (h(\xi_3)+h(\xi_1)) \, .
\]
\end{proof}
Recall that
\[
B = \max\{ \lvert b_1 \rvert, \dotsc, \lvert b_r \rvert, \lvert b_{r+1} \rvert\},
\]
where $b_{r+1} = 1$. We now apply Matveev's theorem in order to obtain a bound for $B$.
%We suppose $B \ge 3$.
%Thus $B=\max\{ \lvert b_1 \rvert, \dotsc, \lvert b_{r+1} \rvert\}$.
%We would like to obtain a bound for $B$.
%We now apply Matveev's theorem.
\begin{lem}\label{lem:Matveev}
Let
\[
h_j^* \; := \; \sqrt{4 h(\delta_j)^2 + \frac{\pi^2}{D^2}}
\quad \text{for $j=1,\dotsc,r$},
\quad \text{and} \qquad
h_{r+1}^* \; := \; \sqrt{4 c_7^2 + \frac{\pi^2}{D^2}} .
\]
Let
\[
c_{9} \; = \;
6 \cdot 30^{r+5} \cdot (r+2)^{5.5} \cdot
D^{r+3} \cdot \log(eD) \cdot h_1^* \cdots h_{r+1}^*\, ,
\]
and
\[
c_{10} \; = \; c_{8}+c_{9} \cdot \log(e(r+1)).
\]
Let $\nu$ be an infinite place of $L$.
Then
\[
\log{\lVert (\varepsilon_3/\varepsilon_1)^{-1} \rVert_\nu}
\; \le \;
c_{10} \; + \; c_{9} \cdot \log{B}.
\]
\end{lem}
\begin{proof}
We will apply Theorem~\ref{thm:Matveev} with $n=r+1$.
Observe that
\[
h(\alpha_j) \le 2 h(\delta_j) \qquad \text{for $j=1,\dotsc,r$}, \quad
\text{and} \qquad h(\alpha_{r+1}) \le 2 c_7.
\]
Thus $h_j^\prime \le h_j^*$ where $h_j^\prime$ is defined in
\eqref{eqn:hjprime}.
By Theorem~\ref{thm:Matveev},
\[
\log{\lVert \Lambda^{-1} \rVert_\nu} \; \le \; c_{9} \cdot (\log(e(r+1))+\log{B}).
\]
Lemma~\ref{lem:difference} completes the proof.
\end{proof}
We also apply Yu's theorem.
\begin{lem}\label{lem:Yu}
Let
\[
h_j^{\dagger} \;  := \; \max\left\{ 2 h(\delta_j), \, \frac{1}{16 e^2 D^2 }\right\} \qquad
\text{for $j=1,\dotsc,r$},
\]
and
\[
h_{r+1}^{\dagger} \;  := \; \max\left\{ 2 c_7, \, \frac{1}{16 e^2 D^2 }\right\} \, .
\]
Let $T$ be the set of rational primes $p$ below
the primes $\fp \in S$. Let
\[
c_{11}:=
\max_{p \in T} \;  \max\left\{  \frac{u^{r+1} \cdot p^v}{v \cdot \log{p}} \;
: \; \text{$u$, $v$ are positive integers and $\; uv \le D/d$}
 \right\},
\]
and
\[
c_{12} := c_1(r+1,D) \cdot c_{11} \cdot h_1^{\dagger} \cdots h_{r+1}^\dagger.
\]
Let $\nu$ be a finite place of $L$. Then
\[
\log{\lVert (\varepsilon_3/\varepsilon_1)^{-1} \rVert_\nu}
\; \le \;
c_{8}+c_{12} \log{B}.
\]
\end{lem}
\begin{proof}
Of course we may suppose that
$\lVert (\varepsilon_3/\varepsilon_1)^{-1} \rVert_\nu \ne 1$.
Let $\mP$ be the prime ideal of $\OO_L$ corresponding to $\nu$.
We will deduce the lemma from Theorem~\ref{thm:Yu} combined
with Lemma~\ref{lem:difference}. For this,
it suffices to show that
${c_3(r+1,D,\mP,\alpha_1,\dotsc,\alpha_{r+1}) \le c_{12}}$. Observe
that $h_j \le h_j^\dagger$ for $j=1,\dotsc,r+1$. Thus
it is enough to show that $c_2(r+1,\mP) \le c_{11}$.

Let $K_i=\Q(\theta_i) \subseteq L$.
Recall that $\varepsilon$ is an $S$-unit and that $\varepsilon_i$
is the image of $\varepsilon$ under the map $\sigma_i : K \rightarrow K_i$,
$\theta \mapsto \theta_i$.
As $\lVert (\varepsilon_3/\varepsilon_1)^{-1} \rVert_\nu \ne 1$,
we see that $\ord_\mP(\varepsilon_i) \ne 0$ for $i=1$ or $3$. Thus $\mP$ must be a prime above $\fp_i:=\sigma_i(\fp)$
of $\OO_{K_i}$ for some $\fp \in S$,
where $i=1$ or $3$. In particular $\mP$ is above some rational prime $p \in T$.
However, $e(\fp|p)=f(\fp|p)=1$ for all $\fp \in S$.
Thus $e(\mP|p)=e(\mP|\fp_i)$ and $f(\mP|p)=f(\mP|\fp_i)$
for $i=1$ or $3$. Let
$u=e(\mP|p)$ and $v=f(\mP|p)$. We see that
$uv=e(\mP|\fp_i)f(\mP|\fp_i)\leq[L:K_i]=D/d$.
Now $c_2(r+1,\mP) \le c_{11}$ follows from the definitions
of $c_2$ and $c_{11}$.
\end{proof}

\begin{lem}\label{lem:mulogB}
Let
\[
c_{13}\; :=\; \frac{\# M_K^\infty+2\cdot \#S}{d},
\]
and
\[
c_{14} \; := \; 2 h(\tau) + c_{13} \cdot \max(c_{8},c_{10}),
\qquad c_{15} \; := \; c_{13} \cdot \max(c_{9},c_{12}).
\]
Then
\[
h(\mu_3/\mu_1)
 \; \le \; c_{14} \, +\, c_{15} \cdot \log{B}.
\]
\end{lem}
\begin{proof}
Let $\sS$ be the prime ideals appearing in the support
of $\varepsilon_3/\varepsilon_1$.
We will show that $\# \sS \le (2D/d) \cdot \#S$.
Indeed, $\varepsilon_i$ belongs to $K_i=\Q(\theta_i)$
and its support in $K_i$ is contained in $\sigma_i(S)$. Now a prime belonging to
$\sigma_i(S)$ has at most $[L:K_i]=D/d$
primes above it in $L$. Thus
\[
\#\sS \; \le\; (D/d) \cdot \# \sigma_1(S)+(D/d) \cdot \# \sigma_3(S) \; \le
(2D/d) \cdot \#S
\]
as required.
Moreover, since $[L:K]=D/d$, we have $\#M_L^\infty \le (D/d) \cdot \# M_K^\infty$.

Let $\eta \in M_L$
be the place of $L$ such that $\lVert \varepsilon_3/\varepsilon_1 \rVert_\eta$
is minimal. By Lemma~\ref{lem:minimal}
\[
h(\varepsilon_3/\varepsilon_1) \; \le \; \frac{\#M_L^\infty+\#\sS}{D} \cdot \lVert (\varepsilon_3/\varepsilon_1)^{-1} \rVert_\eta.
\]
From the above inequalities for $\#M_L^\infty$ and $\#\sS$, we deduce that
\[
h(\varepsilon_3/\varepsilon_1) \; \le \;
c_{13} \cdot \lVert (\varepsilon_3/\varepsilon_1)^{-1} \rVert_\eta.
\]
We now apply Lemmas~\ref{lem:Matveev} and~\ref{lem:Yu} to obtain
\[
h(\varepsilon_3/\varepsilon_1) \; \le \;
c_{13} \cdot \left(\max(c_8,c_{10})\; +\; \max(c_9,c_{12}) \cdot \log{B} \right).
\]
Finally, observe that $\mu_3/\mu_1=(\tau_3/\tau_1) \cdot (\varepsilon_3/\varepsilon_1)$
and thus
\[
h(\mu_3/\mu_1)
\; \le \; 2 h(\tau) \, + \,  h(\varepsilon_3/\varepsilon_1).
\]
\end{proof}

We shall henceforth suppose $(X,Y) \ne (\pm 1,0)$. %\edit{(is this added if we exit early?)}
As $\gcd(X,Y)=1$, this forces $Y \ne 0$.
\begin{lem}\label{lem:quotient}
Let $\nu$ be a place of $L$.
Let
\[
\kappa_{\nu}=\begin{cases}
1 & \text{if $\nu \in M_L^0$},\\
1/2^{D_\nu} & \text{if $\nu \in M_L^\infty$}.
\end{cases}
\]
Then
\[
\max\{ \lVert \mu_1 \rVert_\nu \, ,\, \lVert \mu_3 \rVert_\nu \}^2 \; \ge \;
\kappa_\nu \cdot \min\left\{1, \lVert \theta_1 -\theta_3 \rVert_\nu\right\}^2
\cdot
\max\{ 1 \, ,\, \lVert \mu_1 \rVert_\nu \} \cdot
\max\{ 1 \, ,\, \lVert \mu_3 \rVert_\nu \} \, .
\]
\end{lem}
\begin{proof}
%Note that $\theta_1-\theta_3$ is an algebraic
%integer, and so $\lVert \theta_1-\theta_3 \rVert_\nu \le 1$.
There is nothing to prove unless, $\lVert \mu_i \rVert_\nu \le 1$
for both $i=1$, $2$. In this case, it is enough to show that
\begin{equation}\label{eqn:valineq}
\max\{ \lVert \mu_1 \rVert_\nu \, ,\, \lVert \mu_3 \rVert_\nu \} \; \ge \;
\kappa_\nu \cdot \lVert \theta_1 -\theta_3 \rVert_\nu .
\end{equation}
Suppose first that $\nu$ is finite and let
$\mP$ be the prime ideal of $\OO_L$ corresponding to $\nu$.
Then \eqref{eqn:valineq} is equivalent to
\[
\min\{ \ord_\mP(\mu_1) \, ,\, \ord_\mP(\mu_3)  \} \; \le \;
\ord_\mP(\theta_1 -\theta_3) .
\]
Let $k=\min\{ \ord_\mP(\mu_1) \, ,\, \ord_\mP(\mu_3)  \}$.
Then $\mP^k \mid \mu_i$ for $i=1$, $3$.
Recall that ${\mu_i=a_0 X- \theta_i Y}$. Thus $\mP^k$ divides both
\[
(\theta_1-\theta_3) a_0 X\; = \; \theta_1 \mu_3-\theta_3 \mu_1 \quad \text{and} \quad
(\theta_1-\theta_3) Y \; =\; \mu_3-\mu_1.
\]
However $\gcd(X,Y)=\gcd(a_0,Y)=1$, thus $\mP^k \mid (\theta_1-\theta_3)$
as desired.

Next suppose $\nu$ is infinite.
As $(\theta_1-\theta_3)Y=\mu_3-\mu_1$,
and $Y \ne 0$ is a rational integer, we have
\[
\begin{split}
\lVert \theta_1-\theta_3 \rVert_\nu \; & \le \;
\lVert \mu_1-\mu_3 \rVert_\nu \; \\
& = \;
\lvert \mu_1 -\mu_3 \rvert_\nu^{D_\nu}
\;\\
& \le \;
2^{D_\nu} \cdot \max\{ \lvert \mu_1 \rvert_\nu,~\lvert \mu_3 \rvert_\nu\}^{D_\nu} \\
& \le \; 2^{D_\nu} \cdot \max\{ \lVert \mu_1 \rVert_\nu,~\lVert \mu_3 \rVert_\nu\}.
\end{split}
\]
This completes the proof.
\end{proof}

\begin{lem}
Let
\[
c_{16} \; = \; c_{14}+ \frac{3}{2} \log{2}+ 2 h(\theta)+h(\tau) \, .
\]
Then
\begin{equation}\label{eqn:epslogB}
h(\varepsilon) \; \le \; c_{16}+c_{15} \cdot \log{B}\, .
\end{equation}
\end{lem}
\begin{proof}
First note that
\[
\begin{split}
h(\mu_3/\mu_1) \;
& = \;
\frac{1}{D} \sum_{\nu \in M_L} \log\max\left\{1,~\lVert \mu_3/\mu_1 \rVert_\nu \right\} \\
& = \;
\frac{1}{D} \sum_{\nu \in M_L} \log\max\left\{1,~\lVert \mu_3/\mu_1 \rVert_\nu \right\} + \frac{1}{D} \sum_{\nu \in M_L}\log{\lVert \mu_1 \rVert_\nu} \quad \text{(from
\eqref{eqn:productformula})}\\
& = \;
\frac{1}{D} \sum_{\nu \in M_L} \log\max\{\lVert \mu_1\rVert,~\lVert \mu_3 \rVert_\nu \} \\
& \ge \; \frac{1}{2}(h(\mu_1)+h(\mu_3)) + \frac{1}{D} \sum_{\nu \in M_L}\left(\frac{1}{2} \log{\kappa_\nu} + \log \min\{1,~\lVert(\theta_1-\theta_3) \rVert_\nu\} \right)
\end{split}
\]
by Lemma~\ref{lem:quotient}. However $\mu_1$, $\mu_3$ are conjugates
of $\mu$, thus $h(\mu_1)=h(\mu_3)=h(\mu)$. Moreover,
\[
\frac{1}{D} \sum_{\nu \in M_L} \frac{1}{2} \log{\kappa_\nu}
 \; = \;
- \frac{\log{2}}{2D} \sum_{\nu \in M_L^\infty} D_\nu
\; = \; -\frac{1}{2} \log{2} \, .
\]
Thus
\[
\begin{split}
h(\mu) \;  & \le \;
h(\mu_3/\mu_1) \, + \, \frac{1}{2} \log{2} \, - \,
\frac{1}{D} \sum_{\nu \in M_L} \log \min\{1,~\lVert(\theta_1-\theta_3) \rVert_\nu\}\\
& = \;
h(\mu_3/\mu_1) \, + \, \frac{1}{2} \log{2} \, + \,
\frac{1}{D} \sum_{\nu \in M_L} \log \max\{1,~\lVert(\theta_1-\theta_3)^{-1} \rVert_\nu\}\\
& = \;
h(\mu_3/\mu_1) \, + \, \frac{1}{2} \log{2} \, + \,  h((\theta_1-\theta_3)^{-1})\\
& \le \;
h(\mu_3/\mu_1) \, + \, \frac{3}{2} \log{2} \, + \,  2 h(\theta) \, ,
\end{split}
\]
by Lemmas~\ref{lem:conjheight} and \ref{lem:heightsum}.
But $\varepsilon=\tau^{-1} \mu$, thus
\[
h(\varepsilon) \; \le \; h(\mu_3/\mu_1) \, + \, \frac{3}{2} \log{2} \, + \,  2 h(\theta) \, + \, h(\tau) \, .
\]
Applying Lemma~\ref{lem:mulogB} completes the proof.
\end{proof}

It is worthwhile to take stock for a moment. The inequality
\eqref{eqn:epslogB} relates the height of
$\varepsilon=\delta_1^{b_1} \cdots \delta_r^{b_r}$
to $B=\max\{\lvert b_1 \rvert,\dotsc,\lvert b_r \rvert, 1\}$.
The constants $c_7,\dotsc,c_{16}$ are given explicitly
in terms of $\theta$, $\tau$, $\delta_1,\dotsc,\delta_r$
(all belonging to $K$), the prime ideals of $K$ belonging to $S$,
the signature of $K$,
 and the degree $D$, which can
be deduced from the Galois group of the minimal
polynomial of $\theta$. We do not need the field $L$
explicitly.

\begin{lem}\label{lem:htlbB}
Let $U$ be any subset of $S \cup M_K^{\infty}$ of size $r$.
Let $\cM$ be the $r\times r$-matrix
\[
\cM=(\, \log{\lVert \delta_j \rVert_\nu} \, )_{\nu \in U,~1 \le j \le r} \, .
\]
The matrix $\cM$ is invertible. Let $c_{17}$ be the largest
of the absolute values of the entries of $\cM^{-1}$.
Then
\[
B \;  \le \;  2d \cdot c_{17} \cdot h(\varepsilon).
\]
\end{lem}
\begin{proof}
The determinant of $\cM$ is in fact
\[
\pm \left(\prod_{\nu \in U} D_\nu\right) \cdot R(\delta_1,\dotsc,\delta_r)
\]
where $R(\delta_1,\dotsc,\delta_r)$ is the regulator of system
of $S$-units $\delta_1,\dotsc,\delta_r$,
and therefore does not vanish (c.f. \cite[Section 3]{BG}).
Consider the vectors
$\bb:=\big[b_j\big]_{j=1,\dotsc,r}$ and
$\uu:=\big[\log{\lVert \varepsilon \rVert_\nu} \big]_{\nu \in U}$
in $\R^r$. As $\varepsilon=\delta_1^{b_1} \cdots \delta_r^{b_r}$
we see that $\uu=\cM \bb$ and so $\bb=\cM^{-1} \uu$. It follows,
for $j=1,\dotsc,r$ that
\[
\begin{split}
\lvert b_j \rvert \; %:= \; \max\{ \lvert b_1 \rvert,\dotsc,\lvert b_r \rvert\}
\; & \le \; c_{17} \cdot \sum_{\nu \in U} \lvert \log{\lVert \varepsilon \rVert_\nu}\rvert\\
& \le \; c_{17} \cdot \sum_{\nu \in M_K} \log{\max\{1,\lVert \varepsilon \rVert_\nu\}} + \log{\max\{1,\lVert \varepsilon^{-1} \rVert_\nu\}}\\
& = \; 2d \cdot c_{17} \cdot h(\varepsilon)
\end{split}
\]
as required.
\end{proof}

\noindent\textbf{Remark.} Observe that there are $r+1$ possibilities for the set $U$. To compute $c_{17}$ in practice, we iterate across all such sets and select $c_{17}$ as the smallest possible value across each of the associated $r+1$ matrices $\cM$.

\begin{prop}\label{prop:initialBd}
Let
\[
c_{18} \; := \; 2d \cdot c_{17} \cdot c_{16}\, ,
\qquad
c_{19} \; := \; 2d \cdot c_{17} \cdot c_{15}\, ,
\qquad
c_{20} \; := \; 2c_{18}\, +\,  \max\{2 c_{19} \log{c_{19}},~4e^2\}.
\]
Then
\begin{equation}\label{eqn:Bbound}
B \; \le \;  c_{20}.
\end{equation}
\end{prop}
\begin{proof}
Combining Lemma~\ref{lem:htlbB} with \eqref{eqn:epslogB} we have
\[
B
\; \le \; 2d \cdot c_{17} \cdot \big( c_{16}+c_{15} \cdot \log{B} \big)
\;  \le \; c_{18}+ c_{19} \log{B}.
\]
%Thus $B \; \le \;  c_{18}+c_{19} \log{B}$.
The Proposition follows from a result of
Peth\H{o} and de Weger (Lemma B.1 of \cite[Appendix B]{Smart}).
\end{proof}

%-------------------------------------------------------------------------------------------%

\subsection*{Example 5 continued}

We give some further details for Example 5. Here $a_0=5$ and
the minimal polynomial for $\theta$ is
\[
x^{11} + x^{10} + 20x^9 + 25 x^8 + 750 x^7 + 625 x^6 + 18750 x^5 + 468750 x^3 +
    7812500 x - 19531250.
  \]
The field $K=\Q(\theta)$ has degree $11$, and signature $(1,5)$.
In this case we have $2$ possibilities
for $(\tau,\delta_1,\dotsc,\delta_r)$; one has $S$-unit
rank $r=9$ and the other has $S$-unit rank $r=10$.
We take a closer look at one of these
$2$ possibilities, with $r=10$: \label{page:taudeltatuple}
\begin{tiny}
\begin{align*}
\tau=\frac{1}{5^8} & (11114\theta^{10} - 156626\theta^9 - 3960\theta^8 + 713050\theta^7 +
    3733000\theta^6 - 129663750\theta^5 + 175803125\theta^4\\
	& - 184687500\theta^3
    + 1457890625\theta^2 - 70168750000\theta + 134298828125),\\
  \delta_1=\frac{1}{5^9}& (62639\theta^{10} - 748196\theta^9 - 4621980\theta^8 -
        22207025\theta^7 + 38965000\theta^6 - 34195000\theta^5 -
        449543750\theta^4\\
	& - 21271312500\theta^3 - 51765703125\theta^2 -
        209809765625\theta + 942912109375),\\
  \delta_2=\frac{1}{5^8}& (-304507\theta^{10} - 1286200\theta^9 - 8286278\theta^8 -
        14744530\theta^7 - 120138150\theta^6 + 295735000\theta^5\\
	& +
        31769375\theta^4 + 19645671875\theta^3 - 1856078125\theta^2 +
        159741562500\theta - 1543269140625),\\
  \delta_3=\frac{1}{5^9}& (-506181269733\theta^{10} - 15199081379048\theta^9 +
        3417039996000\theta^8 + 20631263730850\theta^7\\
	& - 862101634598875\theta^6
        - 11248761245089375\theta^5 + 13277953474900000\theta^4 -
        47969344104562500\theta^3\\
	& - 481688292060625000\theta^2 -
        5526042413395703125\theta + 13231499496662109375),\\
  \delta_4=\frac{1}{5^9}&(375938718\theta^{10} + 1113068513\theta^9 + 9701253830\theta^8 +
        28420450900\theta^7 + 337680104250\theta^6 + 897075371250\theta^5 \\
	&+
        8807817215625\theta^4
	 + 17270145140625\theta^3 + 210084124843750\theta^2
        + 411927193359375\theta + 3744720025390625),\\
  \delta_5=\frac{1}{5^9} & (-44039\theta^{10} - 174484\theta^9 - 2041150\theta^8 -
        12553050\theta^7 - 48229625\theta^6 - 380426875\theta^5 -
        367550000\theta^4\\
	& - 6470828125\theta^3 + 8499687500\theta^2 -
        60500781250\theta + 157595703125),\\
  \delta_6=\frac{1}{5^9} & (156\theta^{10} + 1076\theta^9 + 7590\theta^8 + 32475\theta^7 +
        181375\theta^6 + 466250\theta^5 + 1753125\theta^4
	 - 4156250\theta^3\\ & -
        7578125\theta^2 - 133984375\theta + 267578125),\\
  \delta_7=\frac{1}{5^9} & (3783\theta^{10} - 10047\theta^9 - 20595\theta^8 + 94800\theta^7 +
        2714750\theta^6 - 9815000\theta^5 + 11365625\theta^4\\
	& + 6562500\theta^3 +
        1218125000\theta^2 - 6610156250\theta + 7017578125),\\
  \delta_8=\frac{1}{5^9} & (21\theta^{10} - 169\theta^9 + 680\theta^8 - 325\theta^7 -
        2500\theta^6 - 11875\theta^5 + 459375\theta^4\\
	& - 3640625\theta^3 +
        20156250\theta^2 - 65625000\theta + 72265625),\\
  \delta_9=\frac{1}{5^9} & (-2386\theta^{10} - 126366\theta^9 - 363925\theta^8 +
        2473650\theta^7 - 14427125\theta^6 - 87118750\theta^5 - 55203125\theta^4
        + 281968750\theta^3\\ & - 4114296875\theta^2 - 68742968750\theta +
        152501953125),\\
  \delta_{10}=\frac{1}{5^9} & (-173\theta^{10} - 1528\theta^9 - 4840\theta^8 + 6800\theta^7 +
        54125\theta^6 - 298750\theta^5 - 4609375\theta^4\\
	& - 19546875\theta^3 -
        11953125\theta^2 + 270703125\theta + 1181640625).\\
\end{align*}
\end{tiny}
The set $S$ is composed of the following five primes of ramification
degree $1$ and inertial degree $1$:
\begin{multline}\label{eqn:primesS}
\fp_1=\langle 11, 3+\theta \rangle,
\quad
\fp_2=\langle 7, 1+\theta \rangle,
\quad
\fp_3=\langle 5, \phi \rangle, \\
%\quad
\fp_4=\langle 3, 5+\theta \rangle,
\quad
\fp_5=\langle 2, 1+\theta \rangle,
\end{multline}
where
\begin{multline*}
\phi=
\frac{1}{5^9}(4\theta^{10} + 9\theta^9 + 185\theta^8 +
425\theta^7 + 4625\theta^6
        + 13750\theta^5 + 131250\theta^4\\
	+ 750000\theta^3 + 3203125\theta^2 +
        26953125\theta + 5859375).
\end{multline*}
The bound for $B$ given by Proposition~\ref{prop:initialBd}
is
\[
B \le 1.57 \times 10^{222}.
\]

\begin{comment}
	\subsection*{Example 5 continued} %\edit{(should verify these...)}}
We give some further details for Example 5. Here $a_0=5$ and
the minimal polynomial for $\theta$ is
\[
x^{11} + x^{10} + 20x^9 + 25 x^8 + 750 x^7 + 625 x^6 + 18750 x^5 + 468750 x^3 +
    7812500 x - 19531250.
\]
The field $K=\Q(\theta)$ has degree $11$, and signature $(1,5)$.
In this case we have $4$ possibilities
for $(\tau,\delta_1,\dotsc,\delta_r)$; two have $S$-unit
rank $r=9$ and the other two have $S$-unit rank $r=10$.
We take a closer look at one of these
$4$ possibilities, with $r=10$: \label{page:taudeltatuple}
\begin{tiny}
\begin{align*}
\tau=\frac{1}{5^8} & (11114\theta^{10} - 156626\theta^9 - 3960\theta^8 + 713050\theta^7 +
    3733000\theta^6 - 129663750\theta^5 + 175803125\theta^4\\
	& - 184687500\theta^3
    + 1457890625\theta^2 - 70168750000\theta + 134298828125)\\
\delta_1=\frac{1}{5^9}& (62639\theta^{10} - 748196\theta^9 - 4621980\theta^8 -
        22207025\theta^7 + 38965000\theta^6 - 34195000\theta^5 -
        449543750\theta^4\\
	& - 21271312500\theta^3 - 51765703125\theta^2 -
        209809765625\theta + 942912109375),\\
\delta_2=\frac{1}{5^8}& (-304507\theta^{10} - 1286200\theta^9 - 8286278\theta^8 -
        14744530\theta^7 - 120138150\theta^6 + 295735000\theta^5\\
	& +
        31769375\theta^4 + 19645671875\theta^3 - 1856078125\theta^2 +
        159741562500\theta - 1543269140625),\\
\delta_3=\frac{1}{5^9}& (-506181269733\theta^{10} - 15199081379048\theta^9 +
        3417039996000\theta^8 + 20631263730850\theta^7\\
	& - 862101634598875\theta^6
        - 11248761245089375\theta^5 + 13277953474900000\theta^4 -
        47969344104562500\theta^3\\
	& - 481688292060625000\theta^2 -
        5526042413395703125\theta + 13231499496662109375),\\
\delta_4=\frac{1}{5^9}&(375938718\theta^{10} + 1113068513\theta^9 + 9701253830\theta^8 +
        28420450900\theta^7 + 337680104250\theta^6 + 897075371250\theta^5 \\
	&+
        8807817215625\theta^4
	 + 17270145140625\theta^3 + 210084124843750\theta^2
        + 411927193359375\theta + 3744720025390625),\\
\delta_5=\frac{1}{5^9} & (-44039\theta^{10} - 174484\theta^9 - 2041150\theta^8 -
        12553050\theta^7 - 48229625\theta^6 - 380426875\theta^5 -
        367550000\theta^4\\
	& - 6470828125\theta^3 + 8499687500\theta^2 -
        60500781250\theta + 157595703125),\\
\delta_6=\frac{1}{5^9} & (156\theta^{10} + 1076\theta^9 + 7590\theta^8 + 32475\theta^7 +
        181375\theta^6 + 466250\theta^5 + 1753125\theta^4
	 - 4156250\theta^3\\ & -
        7578125\theta^2 - 133984375\theta + 267578125),\\
\delta_7=\frac{1}{5^9} & (3783\theta^{10} - 10047\theta^9 - 20595\theta^8 + 94800\theta^7 +
        2714750\theta^6 - 9815000\theta^5 + 11365625\theta^4\\
	& + 6562500\theta^3 +
        1218125000\theta^2 - 6610156250\theta + 7017578125),\\
\delta_8=\frac{1}{5^9} & (21\theta^{10} - 169\theta^9 + 680\theta^8 - 325\theta^7 -
        2500\theta^6 - 11875\theta^5 + 459375\theta^4\\
	& - 3640625\theta^3 +
        20156250\theta^2 - 65625000\theta + 72265625),\\
\delta_9=\frac{1}{5^9} & (-2386\theta^{10} - 126366\theta^9 - 363925\theta^8 +
        2473650\theta^7 - 14427125\theta^6 - 87118750\theta^5 - 55203125\theta^4
        + 281968750\theta^3\\ & - 4114296875\theta^2 - 68742968750\theta +
        152501953125),\\
\delta_{10}=\frac{1}{5^9} & (-173\theta^{10} - 1528\theta^9 - 4840\theta^8 + 6800\theta^7 +
        54125\theta^6 - 298750\theta^5 - 4609375\theta^4\\
	& - 19546875\theta^3 -
        11953125\theta^2 + 270703125\theta + 1181640625).\\
\end{align*}
\end{tiny}
The set $S$ is composed of the following five primes of ramification
degree $1$ and inertial degree $1$:
\begin{multline}\label{eqn:primesS}
\fp_1=\langle 11, 3+\theta \rangle,
\quad
\fp_2=\langle 7, 1+\theta \rangle,
\quad
\fp_3=\langle 5, \phi \rangle, \\
%\quad
\fp_4=\langle 3, 5+\theta \rangle,
\quad
\fp_5=\langle 2, 1+\theta \rangle,
\end{multline}
where
\begin{multline*}
\phi=
\frac{1}{5^9}(4\theta^{10} + 9\theta^9 + 185\theta^8 +
425\theta^7 + 4625\theta^6
        + 13750\theta^5 + 131250\theta^4\\
	+ 750000\theta^3 + 3203125\theta^2 +
        26953125\theta + 5859375).
\end{multline*}
The bound for $B$ given by Proposition~\ref{prop:initialBd}
is
\[
B \le 1.57 \times 10^{222}.
\]
\end{comment}

%-------------------------------------------------------------------------------------------%
%-------------------------------------------------------------------------------------------%

\section{Controlling the Valuations of $a_0 X - \theta Y$}\label{sec:controlling-vals}

In this section and the next, we will suppose that we have a bound
\begin{equation}\label{eqn:cB0}
B \le \cB_{\infty}
\end{equation}
and we will explain a method for replacing this
bound with what is hopefully a smaller bound. Our
subsequent constants will depend on $\cB_{\infty}$.
Initially we may take $\cB_{\infty} =c_{20}$ by Proposition~\ref{prop:initialBd}.
However, if we succeed in obtaining a smaller bound for $B$,
we may replace $\cB_{\infty}$ by that bound and repeat the process.

We shall replace the reduction step
using linear forms in $\fp$-adic logarithms as in
the paper of Tzanakis and de Weger \cite{TW}. In particular
we will eliminate all computations with
completions of extensions of $K$, as these are extremely tedious
and error-prone.

Write
%\begin{equation}\label{eqn:cB0tocB1}
%\cB_1:=\sqrt{r} \cdot \cB_{\infty}, \edit{\qquad \cB_0 = c_{20} \quad \text{(initial value for $\cB_0$)}}.
%\end{equation}
%Note that
%\begin{equation}\label{eqn:cB1}
%\lVert \bb \rVert \le \cB_1
%\end{equation}
%where $\lVert \bb \rVert$ denotes the $L^2$-norm of $\bb=\big[b_j\big]_{j=1,\dotsc,r}$. \edit{To reiterate, we will update $\cB_{\infty}$ and $\cB_1$ throughout our algorithm, keeping in mind that $\cB_0$ will always denote the bound on the $L^{\infty}$-norm of $\bb$, while $\cB_1$ will always be a bound for the $L^2$-norm of $\bb$.}
\begin{equation}\label{eqn:cB0tocB1}
\cB_2=\sqrt{r} \cdot \cB_{\infty}, \qquad \cB_1 = r\cdot \cB_{\infty}, \qquad \cB_{\infty} = c_{20} \quad \text{(initial value for $\cB_{\infty}$)}.
\end{equation}
Note that
\begin{equation}\label{eqn:cB1}
\lVert \bb \rVert_2 \le \cB_2 \quad \text{ and } \quad \lVert \bb \rVert_1 \le \cB_1,
\end{equation}
where $\lVert \bb \rVert_2$ denotes the $L^2$-norm of the vector $\bb=\big[b_j\big]_{j=1,\dotsc,r}$, while $\lVert \bb \rVert_1$ denotes the $L^1$-norm. To reiterate, we will update $\cB_{\infty}$, $\cB_1$, and $\cB_2$ throughout our algorithm, keeping in mind that these will always denote bounds on the $L^{\infty}$-norm, $L^1$-norm, and $L^2$-norm of $\bb$, respectively. Note that we will focus primarily on $\cB_{\infty}$ and $\cB_2$, but we include $\cB_1$ here to simplify our notation in the remainder of the paper. %Unless specified, we will always refer to the $L^2$-norm when discussing vector lengths, often denoting it simply by $\lVert \cdot \rVert$.

Given a lattice $L \subseteq \Z^r$ and
a vector $\ww \in \Z^r$, we denote by
$D(L,\ww)$ the shortest length of a vector
belonging to the coset $\ww+L$. This value can be
computed using a closest vector algorithm.
Indeed, for $\vv \in \Z^r$, write $\cc(L,\vv)$ for the closest
vector in $L$ to $\vv$ (if there is more than one
at the closest distance, choose any of them).
\begin{lem}\label{lem:closest}
$D(L,\ww)=\lVert \ww+\cc(L,-\ww) \rVert_2$.
\end{lem}
\begin{proof}
Let $\bfl \in L$ and suppose
\[
\lVert \ww+\bfl \rVert_2 < \lVert \ww+\cc(L,-\ww) \rVert_2.
\]
Then
\[
\lVert \bfl-(-\ww) \rVert_2 < \lVert \cc(L,-\ww) -(-\ww)\rVert_2.
\]
Thus $\bfl$ is a vector belonging to $L$ that is strictly closer
to $-\ww$ than $\cc(L,-\ww)$ giving a contradiction.
\end{proof}

Our first goal is to use the bounds \eqref{eqn:cB1}
to deduce  bounds on the valuations $\ord_\fp(a_0 X- \theta Y)$
for $\fp \in S$.
\begin{prop}\label{prop:valbd}
Let $\fp \in S$ and let $p$ be the rational prime below $\fp$.
Let $k \ge 1$.
Then there is some $\theta_0 \in \Z$ such that
\[
\theta \equiv \theta_0 \pmod{\fp^k}.
\]
Write
\begin{equation}\label{eqn:facT1}
\fa:=(p \OO_K)/\fp, \qquad
\tau \OO_K =\cT_1/\cT_2,
\end{equation}
where $\cT_1$ and $\cT_2$ are coprime ideals. The following hold:
\begin{enumerate}
\item[(i)] If $\gcd(\fa^k,\theta-\theta_0) \ne \gcd(\fa^k,\cT_1)$
then
\begin{equation}\label{eqn:valub}
\ord_{\fp}(a_0 X-\theta Y) \le k-1.
\end{equation}
\end{enumerate}
Suppose $\gcd(\fa^k,\theta-\theta_0) = \gcd(\fa^k,\cT_1)$.
Let
\[
\fb:=\fa^k/\gcd(\fa^k,\cT_1) \, .
\]
Let
\[
k^\prime \; := \; \max_{\fq \mid \fb}\left\lceil \frac{\ord_{\fq}(\fb)}{e(\fq|p)}\right\rceil \, ;
\]
this is the smallest integer
such that $\fb \mid p^{k^\prime}$.
Given $u \in K^\times$ whose support is coprime with $\fb$, denote
its image in $(\OO_K/\fb)^\times/(\Z/p^{k^\prime} \Z)^\times$
by $\overline{u}$.
Let
\[
\phi: \Z^r \rightarrow (\OO_K/\fb )^\times / (\Z/p^{k^\prime}\Z)^\times,
\qquad (n_1,\dotsc,n_r) \mapsto \overline{\delta_1}^{n_1} \cdots \overline{\delta_r}^{n_r}.
\]
Write
\[
\tau_0:=\frac{(\theta_0-\theta)}{\tau}.
\]
Then the support of $\tau_0$ is coprime with $\fb$.
\begin{enumerate}
\item[(ii)] If $\overline{\tau_0}$ does not belong to
$\Img(\phi)$ then \eqref{eqn:valub} holds.
\item[(iii)] Suppose $\overline{\tau_0}=\phi(\ww)$ for some $\ww \in \Z^r$. Let $L=\Ker(\phi)$ and suppose $D(L,\ww) >\cB_2$.
Then \eqref{eqn:valub} holds.
\end{enumerate}
\end{prop}
\begin{proof}
Let $\fp$, $p$, and $k$ be as in the statement of the proposition.
We suppose that
\begin{equation}\label{eqn:kbound}
\ord_\fp(a_0X-\theta Y)  \ge k
\end{equation}
and show that this leads to a contradiction under
the hypotheses of any of (i), (ii), (iii).
Recall $k \ge 1$. From the proof of Lemma~\ref{lem:adequate}, we know $p \nmid Y$.
%Suppose $p \mid Y$. Then $\fp \mid Y$ and so $\fp \mid (a_0 X)$.
%As $a_0$, $X$ are rational integers, $p \mid (a_0 X)$.
%This contradicts the restrictions
%$\gcd(X,Y)=\gcd(a_0,Y)=1$ imposed in \eqref{eqn:TM}.

Since $e(\fp|p)=f(\fp|p)=1$, we have $\OO_K/\fp^k \cong \Z/p^k$.
Thus there is some $\theta_0 \in \Z$
such that $\theta-\theta_0 \equiv 0 \pmod{\fp^k}$.
However,
$a_0 X-\theta Y \equiv 0 \pmod{\fp^k}$
and so therefore
$a_0 X- \theta_0 Y \equiv 0 \pmod{\fp^k}$.
However $a_0 X -\theta_0 Y \in \Z$. Thus, recalling that $e(\fp|p)=1$,
we have
$a_0 X-\theta_0 Y \equiv 0 \pmod{p^k}$. From \eqref{eqn:TMdelta}
\[
Y(\theta_0-\theta) \equiv \tau \cdot \delta_1^{b_1} \cdots \delta_r^{b_r}
\pmod{(p \OO_K)^k}.
\]
Note that the prime $\fp$ belongs to the support of the $\delta_i$.
However the other primes $\fp^\prime \mid p$, $\fp^\prime \ne \fp$
do not belong to the support of the $\delta_i$. We now eliminate $\fp$;
as in the statement of the proposition we take
$\fa:=(p\OO_K)/\fp$.
Then
\[
Y(\theta_0-\theta) \equiv \tau \cdot \delta_1^{b_1} \cdots \delta_r^{b_r}
\pmod{\fa^k}.
\]
Observe that $\fa$ is coprime to the support of the
$\delta_i$ and $Y$.
Recall $\tau \OO_K=\cT_1/\cT_2$ where $\cT_1$, $\cT_2$
are coprime integral ideals. By Lemma~\ref{lem:tauden},
the ideal $\cT_2$ is supported on $S$ and therefore
coprime to $\fa$. We therefore have a contradiction
if ${\gcd(\theta_0-\theta,\fa^k) \ne \gcd(\cT_1,\fa^k)}$.
This proves (i). Suppose $\gcd(\theta_0-\theta,\fa^k) = \gcd(\cT_1,\fa^k)$.
Then
\[
Y\cdot \tau_0 \equiv \delta_1^{b_1} \cdots \delta_r^{b_r}
\pmod{\fb},
\]
where $Y$, $\tau_0$, and $\delta_i$ all have support disjoint from $\fb$.
As in the proposition, $k^\prime$ is the smallest positive integer
such that $\fb \mid p^{k^\prime}$, and thus $(\Z/p^{k^\prime} \Z)^\times$
is a subgroup of $(\OO_K/\fb)^\times$ containing the image of $Y$.
Note that $\overline{Y}=\overline{1}$.
Thus $\phi(\bb)=\overline{\tau_0}$. If
$\overline{\tau_0} \notin \Img(\phi)$, then
we have a contradiction, and so our original assumption~\eqref{eqn:kbound}
is false. This proves (ii).

Suppose now that $\overline{\tau_0} \in \Img(\phi)$ and write
$\overline{\tau_0}=\phi(\ww)$ with $\ww \in \Z^r$.
Then
$\bb \in \ww+L$. Thus
$\lVert \bb\rVert_2 \ge D(L,\ww)$. If $D(L,\ww) > \cB_2$
then $\lVert \bb \rVert_2 > \cB_2$ and we contradict \eqref{eqn:cB1}.
This proves (iii).
\end{proof}

\medskip

\noindent \textbf{Remarks.}
\begin{itemize}
\item $\theta_0$ can be easily computed using Hensel's Lemma.
\item To apply the proposition in practice,
it is necessary to compute the abelian group structure
of $(\OO_K/\bb)^\times$ for ideals $\bb$ of very large norm (but
supported on the primes above $p$). For this we may apply
the algorithms in \cite[Section 4.2]{CohenAdvanced}.
\item $\cc(-\ww,L)$ (and therefore $D(\ww,L)$) can be computed using a closest
vector algorithm such as Fincke and Pohst \cite{FinckePohst}.
\item To effectively apply Proposition~\ref{prop:valbd}
in practice, we need to guess a value of $k$
such that $D(L,\ww)>\cB_2$.
We expect $D(L,\ww)$ to be around $I^{1/r}$
where $I$ is the index $[\Z^r : L]$.
Let us make two simplifying
assumptions: the first is that $\phi$ is surjective,
and the second is that $\gcd(\fa^k,\cT_1)=1$
so that
$\fb=\fa^k$ and $k^\prime=k$. Then
\[
I=\frac{\# (\OO_K/\fa^k)^\times}{\# (\Z/p^k\Z)^\times}
\approx \frac{\Norm(\fa)^k}{{p^k}}=p^{(d-2)k}
\]
where $d$ is the degree of $K$. Thus we should
expect a contradiction if $p^{(d-2)k/r}$ is much bigger than $\cB_2$,
or equivalently
\[k \gg \frac{r \log{\cB_2}}{(d-2) \log{p}}.\]
This heuristic gives a good guide for which values of $k$ to try.
\end{itemize}

%-------------------------------------------------------------------------------------------%

\subsection*{Example 5 continued}\label{page:fpbounds}
We continue giving details for Example 5,
and in particular for the specific tuple
$(\tau,\delta_1,\dotsc,\delta_{10})$
given on page~\pageref{page:taudeltatuple}.
 In Section~\ref{sec:sunit}
we noted that $B \le 1.57 \times 10^{222}$. Thus we take
\begin{equation}\label{eqn:cB0bd}
\cB_{\infty}=1.57 \times 10^{222}, \qquad
\cB_2=\sqrt{10} \cdot \cB_{\infty} \approx 4.96 \times 10^{222}.
\end{equation}
We let $\fp=\fp_1=\langle 11, 3+\theta \rangle$
which is a prime above $11$.
The above heuristic suggests that we choose $k$ to
be larger than
\[
\frac{10 \log{\cB_2}}{(11-2) \cdot \log{11}} \approx 237.60\, .
\]
Our program tries $k=238$. It turns out (in the notation
of Proposition~\ref{prop:valbd}) that
$\gcd(\fa^k,\theta-\theta_0) = \gcd(\fa^k,\cT_1)=1$,
thus $\fb=\fa^k$, and moreover $k^\prime=k=238$.
The map $\phi$ is surjective, and thus $L$
does indeed have index
\[
I=\frac{\# (\OO_K/\fa^k)^\times}{\# (\Z/p^k\Z)^\times}
=2^7 \times 3^2 \times 5 \times 11^{2133} \times 61 \times 7321
\approx 5.02 \times 10^{2230}.
\]
We do not give $L$ as its basis vectors are naturally huge.
However, we find that
\[
D(L,\ww) \approx 1.14 \times 10^{223}.
\]
This is much larger than $\cB_2$ and we therefore
we know from Proposition~\ref{prop:valbd} that
$\ord_\fp(a_0 X-\theta Y) \le k-1=237$.

It is interesting to note that $I^{1/10} \approx 1.18 \times 10^{223}$
which is rather close to $D(L,\ww)$. If instead we take $k=237$,
we find that $I^{1/10} \approx 1.36 \times 10^{222}$ and
${D(L,\ww) \approx 9.55 \times 10^{221}}$ which is somewhat less
than $\cB_2$. We have generally found the above heuristic to
be remarkably accurate in predicting a good choice for $k$.
%We are unable to reduce our bound for $\ord_{\fp}(a_0 X-\theta Y)$ further
%without first reducing our initial bound for $B$.

Now let $\fp_1,\dotsc,\fp_5$ be the primes of $S$
as in \eqref{eqn:primesS}, where $\fp_1=\fp$ as above.
Proposition~\ref{prop:valbd} gives upper bounds
$237$, $292$, $354$, $518$, $821$ for $\ord_{\fp_j}(a_0 X- \theta Y)$
with $j=1,\dotsc,5$ respectively.

\begin{comment}
\subsection*{Example 5 continued}\label{page:fpbounds}
We continue giving details for Example 5,
and in particular for the specific tuple
$(\tau,\delta_1,\dotsc,\delta_{10})$
given on page~\pageref{page:taudeltatuple}.
 In Section~\ref{sec:sunit}
we noted that $B \le 1.57 \times 10^{222}$. Thus we take
\begin{equation}\label{eqn:cB0bd}
\cB_{\infty}=1.57 \times 10^{222}, \qquad
\cB_1=\sqrt{10} \cdot \cB_{\infty} \approx 4.96 \times 10^{222}.
\end{equation}
We let $\fp=\fp_1=\langle 11, 3+\theta \rangle$
which is a prime above $11$.
The above heuristic suggests that we choose $k$ to
be larger
\[
\frac{10 \log{\cB_1}}{(11-2) \cdot \log{11}} \approx 237.60\, .
\]
Our program tries $k=238$. It turns out (in the notation
of Proposition~\ref{prop:valbd}) that
$\gcd(\fa^k,\theta-\theta_0) = \gcd(\fa^k,\cT_1)=1$,
thus $\fb=\fa^k$, and moreover $k^\prime=k=238$.
The map $\phi$ is surjective, and thus $L$
does indeed have index
\[
I=\frac{\# (\OO_K/\fa^k)^\times}{\# (\Z/p^k\Z)^\times}
=2^7 \times 3^2 \times 5 \times 11^{2133} \times 61 \times 7321
\approx 5.02 \times 10^{2230}.
\]
We do not give $L$ as its basis vectors are naturally huge.
However, we find that
\[
D(L,\ww) \approx 1.14 \times 10^{223}.
\]
This is much larger than $\cB_1$ and we therefore
we know from Proposition~\ref{prop:valbd} that
$\ord_\fp(a_0 X-\theta Y) \le k-1=237$.

It is interesting to note that $I^{1/10} \approx 1.18 \times 10^{223}$
which is rather close to $D(L,\ww)$. If instead we take $k=237$,
we find that $I^{1/10} \approx 1.36 \times 10^{222}$ and
$D(L,\ww) \approx 9.55 \times 10^{221}$ which is somewhat less
than $\cB_1$. We have generally found the above heuristic to
be remarkably accurate in predicting a good choice for $k$.
We are unable to reduce our bound for $\ord_{\fp}(a_0 X-\theta Y)$
without first reducing our initial bound for $B$.

Now let $\fp_1,\dotsc,\fp_5$ be the primes of $S$
as in \eqref{eqn:primesS} (where $\fp_1=\fp$ above).
Proposition~\ref{prop:valbd} give upper bounds
$237$, $292$, $355$, $518$, $821$ for $\ord_{\fp_j}(a_0 X- \theta Y)$
with $j=1,\dotsc,5$ respectively.
\end{comment}

%-------------------------------------------------------------------------------------------%
%-------------------------------------------------------------------------------------------%

\section{Linear Forms in Real Logarithms}\label{sec:LFRL}

In this section, we determine bounds on linear forms in logarithms which we will subsequently use in Section~\ref{sec:red} to successively reduce the large upper bound $\cB_{\infty}$ established in Section~\ref{sec:sunit}.

We let $s:=\#S$ and write
\[
S=\{\fp_1,\dotsc,\fp_s\}.
\]
Using Proposition~\ref{prop:valbd}, we suppose that we have obtained, for $1 \le j \le s$, integers $k_j$
such that
\begin{equation}\label{eqn:kjminus1}
\ord_{\fp_j}(a_0 X- \theta Y) \le k_j-1.
\end{equation}
Recall that
\begin{equation}\label{eqn:varepsilondef}
\delta_1^{b_1} \cdots \delta_r^{b_r} \; = \; \varepsilon
\; = \;
(a_0 X- \theta Y)/\tau \, .
\end{equation}
We write $k_j^\prime:=\ord_{\fp_j}(\tau)$, and
$k_j^{\prime\prime}:=k_j-1-k_j^\prime$. We obtain
\begin{equation}\label{eqn:valbds}
-k_j^\prime \; \le \; \ord_{\fp_j}(\varepsilon) \; \le \; k_j^{\prime\prime} \, .
\end{equation}

\noindent {\textbf{Remark.} In practice, we are often able to update $\cB_1$ and $\cB_2$ with a smaller bound after each iteration of Proposition~\ref{prop:valbd}. In particular, for $1 \leq i \leq r$ where $|\Norm(\delta_i)| = 1$, and any $\nu \in M_K^{0}$, we observe that $\lVert \delta_i \rVert_{\nu} = 1$. Thus
\[\log \lVert \delta_i \rVert_{\nu} = 0\]
for all $\nu \in S$ and all units $\delta_i$. Let $(u,v)$ be the signature of $K$ and reorder $\delta_1, \dots, \delta_r$ so that $\delta_1, \dots, \delta_{u+v-1}$ are units and $\delta_{u+v}, \dots, \delta_r$ are non-units of $K$. Let $\cM_0$ denote the $s \times s$ matrix
\[\cM_0=(\, \log{\lVert \delta_j \rVert_\nu} \, )_{\nu \in S,~ u+v \le j \le r} \, .\]
Following the argument in the proof of Lemma~\ref{lem:htlbB}, this matrix is invertible. Consider the vectors $\bb_0:=\big[b_i\big]_{i=u+v,\dotsc,r}$ and
$\uu_0:=\big[\log{\lVert \varepsilon \rVert_\nu} \big]_{\nu \in S}$ in $\R^s$. By the above, we have $\uu_0 = \cM_0 \bb_0$ and thus $\bb_0 = \cM_0^{-1}\uu_0$. That is, for $1 \leq i \leq s$,
\[b_{u+v-1+i} = m_{i1}\log\lVert \varepsilon \rVert_{\fp_1} + \cdots + m_{is}\log\lVert \varepsilon \rVert_{\fp_s},\]
where $\cM_0^{-1} = \big[m_{ij}\big]$. It follows that
\begin{equation}\label{eqn:finbound}
|b_{u+v-1+i}| \leq |m_{i1}|\lvert\log\lVert \varepsilon \rVert_{\fp_1}\rvert + \cdots + |m_{is}|\lvert\log\lVert \varepsilon \rVert_{\fp_s}\rvert.
\end{equation}
Applying Proposition~\ref{prop:valbd} to any $\fp_j$ for $1 \leq j \leq s$ and using \eqref{eqn:valbds} and \eqref{eqn:normval}, we obtain
\[|\log\lVert \varepsilon \rVert_{\fp_j}| \leq \log(\Norm(\fp_j))\cdot\max\{|k_j^{\prime}|,|k_j^{\prime\prime}|\}.\]
Using this inequality with \eqref{eqn:finbound}, we test whether we obtain a stronger bound on any of $|b_{u+v}|,\dots,|b_r|$. If so, we update $\cB_1$ and $\cB_2$ accordingly and use this new value in Proposition~\ref{prop:valbd} in the next iteration. It is worth noting that after applying this proposition to all $\fp \in S$, we obtain better bounds for each of $|b_{u+v}|,\dots,|b_r|$ and thus we are always left with better bounds $\cB_1, \cB_2$.

\medskip
\begin{comment}
A priori, our exponent vector $\bb=(b_1,\dotsc,b_r)$
belongs to $\Z^r$.
We shall in fact give a sublattice
 $L \subseteq \Z^r$ of rank $r-s$
such that $\bb \in \mathbf{g}+L$, where $\mathbf{g}$ is a vector
whose $L^2$-norm is explicitly bounded.
\begin{lem}
Let
\[
\phi \; : \; \Z^r \rightarrow \Z^s,
\qquad (n_1,\dotsc,n_r) \, \mapsto \, \big( \, \ord_{\fp_j}(\delta_1^{n_1} \cdots \delta_r^{n_r}) \; : \; j=1,\dotsc,s \, \big) \, .
\]
Then $\phi(\Z^r)$ has finite index in $\Z^s$.
Let $\hh_1,\dotsc,\hh_s$ be a $\Z$-basis for $\phi(\Z^r)$,
and $H$ be the matrix with rows $\hh_1,\dotsc,\hh_s$.
Choose $\mathbf{g}_j \in \Z^r$ such that $\phi(\mathbf{g}_j)=\hh_j$,
and let $G$ be the matrix with rows $\mathbf{g}_1,\dotsc,\mathbf{g_s}$.
Let
\[
\cB \; := \; \left\{ \, (c_1,\dotsc,c_s) \in \R^s \; : \;
-k_j^\prime \; \le \;  c_j \; \le \;  k_j^{\prime\prime}.
\right\} \, .
\]
Let $c_{21}$ be \textbf{either} of the following.
\begin{enumerate}
\item[(i)] $c_{21}$ is the maximum of the values
$\lVert \cc^\prime \cdot (H^{-1} G)\rVert$
where $\cc^\prime$ ranges over the $2^s$-vertices
of the box $\cB$.

\medskip

\item[(ii)] $\displaystyle
c_{21}=\sqrt{ \lambda \sum_{j=1}^s
\max\left\{ \lvert k_j^\prime\rvert \, ,\, \lvert k_j^{\prime\prime}\rvert \right\}^2}$
where $\lambda$ is the largest eigenvalue
of the matrix $(H^{-1} G)(H^{-1} G)^T$.
\end{enumerate}
%\[
%\lVert \cc (H^{-1} G) \rVert \le c_{21}, \qquad \text{for all $\cc \in \cB$}.
%\]
Let $L=\Ker(\phi)$, which is a sublattice of $\Z^r$
of rank $r-s$. Then $\bb \in \mathbf{g}+L$
where $\lVert \mathbf{g} \rVert \le c_{21}$.
\end{lem}
\begin{proof}
Let us first show that the index of $\phi(\Z^r)$ is finite.
Let $(c_1,\dotsc,c_s) \in \Z^s$. We will show that
$h\cdot (c_1,\dotsc,c_s) \in \phi(\Z^r)$ where $h$ is the class
number of $K$. Consider the fractional ideal
$\ga=\fp_1^{c_1} \cdots \fp_s^{c_s}$. Then $\ga^h$
is principal, and so generated by an $S$-unit.
As $\delta_1,\dotsc,\delta_s$ is a basis for the $S$-unit
group modulo the roots of unity, there are $n_1,\dotsc,n_r \in \Z$
such $\delta_1^{n_1} \cdots \delta_r^{n_r} \cdot \OO_K= \ga^h$.
Thus $\phi(n_1,\dotsc,n_r)=h \cdot (c_1,\dotsc,c_s)$ as required.
It follows that the image has finite index in $\Z^s$, and so
the kernel $L$ is of rank $r-s$.

Let $\cc=\phi(\bb) \in \Z^s$. From \eqref{eqn:valbds},
we see that $\cc \in \cB$. However, $\cc \in \phi(\Z^r)$
and so there are $m_1,\dotsc,m_s \in \Z$ such that
$\cc=m_1 \hh_1+\cdots+m_s \hh_s$. We can rewrite this
as $\cc=\mm \cdot H$, where $\mm=(m_1,\dotsc,m_s)$.
Let $\mathbf{g}=m_1 \mathbf{g}_1+\cdots+m_s \mathbf{g}_s=\mm \cdot G$.
Then $b-\mathbf{g} \in \Ker(\phi)=L$. Moreover,
$\mathbf{g}=\cc (H^{-1} G)$. We would
like to show that $\lVert \mathbf{g} \rVert \le c_{21}$.

Since the function $\cc \mapsto \lVert \cc \cdot (H^{-1}G) \rVert$
is convex, its maximum on the box $\cB$ is attained at one of the
$2^s$ vertices of the box. This completes the proof if $c_{21}$
is taken as in (i). For (ii)
note that
\[
\lVert \cc \rVert^2 \; \le \; \sum_{j=1}^s
\max\{ \lvert k_j^\prime\rvert \, , \, \lvert k_j^{\prime\prime}\rvert\}^2 \, .
\]
Since $\mathbf{g}=\cc \cdot (H^{-1} G)$, the norm $\lVert \mathbf{g} \rVert$
is bounded by $\sqrt{\lambda} \cdot \lVert \cc\rVert$, where
$\lambda$ is the largest
eigenvalue of $(H^{-1}G)(H^{-1}G)^T$ (see for example \cite[page 281]{Meyer}).
\end{proof}
\end{comment}

To improve our initial bound \eqref{eqn:cB0}, we rely on the inequality ${B \le 2 c_{17} \cdot d \cdot h(\varepsilon)}$
furnished by Lemma~\ref{lem:htlbB}. However
$h(\varepsilon)=h(\varepsilon^{-1})$ and so
\[
B \; \le \; 2 c_{17} \sum_{\nu \in M_K} \log{\max\{1,\, \lVert \varepsilon^{-1} \rVert_\nu\}} \, .
\]
However, since $\varepsilon$ is an $S$-unit,
for $\nu \notin M_K^\infty \cup S$, we have $\lVert \varepsilon \rVert_\nu=1$.
Thus
\begin{equation}\label{eqn:insum2}
B \; \le \; 2 c_{17} \sum_{\nu \in M_K^\infty \cup S} \log{\max\{1,\, \lVert \varepsilon^{-1} \rVert_\nu\}} \, .
\end{equation}
Therefore, to obtain a better bound for $B$, it is enough to
gain good control on
the contributions to the sum on the right hand-side of \eqref{eqn:insum2}.

\begin{lem}\label{lem:c21}
Let
\[
c_{21} \; = \; \sum_{i=1}^s \max\{0,\, k_i^{\prime\prime}\} \cdot \log{(\Norm(\fp_i))} \, .
\]
Then
\begin{equation}\label{eqn:insum3}
B \; \le \; 2 c_{17}
\left( c_{21} \, +\, \sum_{\nu \in M_K^\infty} \log{\max\{1,\, \lVert \varepsilon^{-1} \rVert_\nu\}} \right) \, .
\end{equation}
\end{lem}
\begin{proof}
From \eqref{eqn:valbds} and \eqref{eqn:normval} we have
\[
\sum_{\nu \in S}
\log\max\{1,\lVert \varepsilon^{-1} \rVert_\nu \}
\; \le \;
c_{21} \, .
\]
The lemma now follows from \eqref{eqn:insum2}.
\end{proof}
%The lemma, together with \eqref{eqn:insum2} gives

%\bigskip

We shall write
\[
M_K^\infty \; = \; M_K^{\R} \, \cup \, M_K^{\C} \, ,
\]
where $M_K^{\R}$ and $M_K^{\C}$ are respectively the sets
of real and complex places.
Recall that $(u,v)$ denotes the signature of $K$. Thus
we have embeddings
\[
\sigma_1,\dotsc,\sigma_{u}, \qquad
\sigma_{u+1},\dotsc,\sigma_{u+v},\overline{\sigma_{u+1}},
\dotsc, \overline{\sigma_{u+v}}
\]
of $K$, where $\sigma_i$ are real embeddings for $1 \le i \le u$,
and $\sigma_{u+i}$, $\overline{\sigma_{u+i}}$ are pairs of complex
conjugate embeddings. Let
\begin{equation}\label{eqn:cEdef}
\cE_K^{\R} \; := \; \{\sigma_1,\dotsc,\sigma_{u}\},
\qquad
\cE_K^{\C} \; := \; \{\sigma_{u+1},\dotsc,\sigma_{u+v}\}.
\end{equation}
For the membership of $\cE_K^{\C}$, we are making an arbitrary
choice of a member from each pair of conjugate complex embeddings,
but that is unimportant.
Note that $M_K^\R$ is in one-to-one correspondence
with $\cE_K^{\R}$ and $M_K^{\C}$ is in one-to-one correspondence
with $\cE_K^{\C}$.
We consider the contribution
to the sum \eqref{eqn:insum3} coming from $\nu \in M_K^{\C}$,
or equivalently from $\sigma \in \cE_K^{\C}$.

Let $\Im(z)$ denote the imaginary part of a complex number $z$.
\begin{lem}\label{lem:cmxbd}
If $v=0$ (i.e. $\cE_K^{\C}=\emptyset$)
 then let $c_{22} :=0$. Otherwise let
\[
c_{22} \; = \; 2 \sum_{\sigma \in \cE_K^{\C}}
\log \max \left\{1,\, \frac{\lvert \sigma(\tau)\rvert}{
\lvert \Im(\sigma(\theta))\rvert } \right\} \, .
\]
Then
\begin{equation}\label{eqn:insum}
B \; \le \; 2 c_{17}
\left( c_{21} \, +\, c_{22} \, +\,
 \sum_{\sigma \in \cE_K^{\R}} \log{\max\{1,\, \lvert \sigma(\varepsilon) \rvert^{-1}\}} \right) \, .
\end{equation}
\end{lem}
\begin{proof}
Note that \eqref{eqn:insum3} can be rewritten as
\[
B \; \le \; 2 c_{17}
\left( c_{21} \, +\,
 2 \sum_{\sigma \in \cE_K^{\C}} \log{\max\{1,\, \lvert \sigma(\varepsilon) \rvert^{-1}\}}
\,
+\,
 \sum_{\sigma \in \cE_K^{\R}} \log{\max\{1,\, \lvert \sigma(\varepsilon) \rvert^{-1}\}} \right) \, .
\]
Let $\sigma \in \cE_K^{\C}$. Then, as
$a_0 X- \theta Y=\tau \cdot \varepsilon$,
we have
\[
\lvert \sigma(\varepsilon) \rvert \; = \;
\frac{1}{\lvert \sigma(\tau) \rvert} \cdot
\lvert \sigma(a_0X- \theta Y) \rvert \; \ge
\;
\frac{1}{\lvert \sigma(\tau) \rvert} \cdot
\lvert Y \rvert \cdot \lvert \Im(\sigma(\theta)) \rvert
\;
\ge
\;
\frac{
\lvert \Im(\sigma(\theta)) \rvert
}{\lvert \sigma(\tau) \rvert}
\, ,
\]
because of our assumption $\lvert Y \rvert \ne 0$. The lemma
follows.
\end{proof}

The following is immediate.
\begin{prop}\label{prop:totallycomplexbound}
If $K$ is totally imaginary then
\[B \; \le \; {2 c_{17}}({c_{21}+c_{22}})\, .\]
\end{prop}

%-------------------------------------------------------------------------------------------%

\subsection{The non-totally complex case}
Suppose now that $K$ has one or more
real embeddings. Recall that the signature
of $K$ is $(u,v)$. Thus $u \ge 1$.
\begin{lem}\label{lem:atmostone}
If $u=1$ we let $c_{23}:=1$. If $u \, \ge\, 2$ we let
\[
c_{23}:=\min\left\{
\frac{\lvert \sigma(\theta)-\sigma^\prime(\theta) \rvert}{\lvert \sigma(\tau) \rvert + \lvert \sigma^\prime(\tau) \rvert}
\; : \; \sigma,~\sigma^\prime \in \cE_K^{\R},\; \sigma \ne \sigma^\prime
\right\} \, .
\]
Then there is at most one $\sigma \in \cE_K^\R$ such that
$\lvert \sigma(\varepsilon) \rvert < c_{23}$.
\end{lem}
\begin{proof}
Suppose otherwise. Then there are
$\sigma$, $\sigma^\prime \in \cE_K^\R$ with $\sigma \ne \sigma^\prime$
such that
$\lvert \sigma(\varepsilon) \rvert < c_{23}$ and $\lvert \sigma^\prime(\varepsilon) \rvert< c_{23}$.
As $a_0 X- \theta Y=\tau \cdot \varepsilon$ we find that
\[
\lvert a_0 X- \sigma(\theta) Y \rvert\; < c_{23} \cdot
\lvert \sigma(\tau) \rvert,\qquad
\lvert a_0 X- \sigma^\prime(\theta) Y \rvert\; < c_{23} \cdot
\lvert \sigma^\prime(\tau) \rvert\, .
\]
Thus
\[
\lvert \sigma(\theta)- \sigma^\prime(\theta) \rvert \cdot \lvert Y \rvert <
c_{23} \cdot ( \lvert \sigma(\tau) \rvert+
\lvert \sigma^\prime(\tau) \rvert).
\]
Recall our assumption that $Y \ne 0$. This inequality now
contradicts our definition of $c_{23}$.
\end{proof}

\begin{lem}\label{lem:eta}
Let
\[
c_{24}\; := \; c_{21}\; + \; c_{22} \; + \; (u \, - \, 1) \log\max\{1, \, c_{23}^{-1}\},
\]
and
\[
c_{25}\; := \; \exp(c_{24}) \, ,
\qquad
c_{26} \; := \frac{1}{2 c_{17}} \, .
\]
Suppose $B > 2 c_{17} \cdot c_{24}$.
Let $\sigma \in \cE_K^\R$ be chosen so that
$\lvert \sigma(\varepsilon) \rvert$ is minimal. Then
\begin{equation}\label{eqn:epseta}
\lvert \sigma(\varepsilon) \rvert \; \le \;
c_{25} \cdot \exp(-c_{26} \cdot B) \, .
\end{equation}
\end{lem}
\begin{proof}
From Lemma~\ref{lem:atmostone}, we have
\[
\lvert \sigma^\prime(\varepsilon) \rvert \; \ge c_{23}
\]
for all $\sigma^\prime \in \cE_K^\R$ with $\sigma^\prime \ne \sigma$.
From \eqref{eqn:insum} we deduce that
\[
\begin{split}
B \; & \le \;
2 c_{17}
\left( c_{21} \, +\, c_{22} \, +\,
(u \, -\, 1) \log\max\{1, \, c_{23}^{-1}\}
\, + \,
 \log{\max\{1,\, \lvert \sigma(\varepsilon) \rvert^{-1}\}} \right) \\
& = \;
2 c_{17}
\left( c_{24} \, +\,
 \log{\max\{1,\, \lvert \sigma(\varepsilon) \rvert^{-1}\}} \right) \, .
\end{split}
\]
It follows that
\[
\log \max\{ 1,\, \lvert \sigma(\varepsilon)\rvert^{-1}\}
\; \ge \;
\frac{1}{2 c_{17}} B \, - \, c_{24}
\; \ge \;
c_{26} \cdot B \, - \, c_{24} \, .
\]
The hypothesis $B > 2 c_{17} \cdot c_{24}$ forces the right hand-side
to be positive, and so the left hand-side must simply be
$\log {\lvert \sigma(\varepsilon)^{-1}\rvert}$. After
exponentiating and rearranging, we obtain \eqref{eqn:epseta}.
\end{proof}

%-------------------------------------------------------------------------------------------%

\subsection{Approximate relations}
As in Lemma~\ref{lem:eta} we shall let $\sigma \in \cE_K^{\R}$
be the real embedding that makes
$\lvert \sigma(\varepsilon) \rvert$  minimal. Recall that the signature of $K$ is $(u,v)$.
Let
\begin{equation}\label{eqn:nrv}
n \; := r+v\, .
\end{equation}
In this section we introduce additional unknown integers
$b_{r+1},\dotsc ,{b_{n}}$, closely related to
the exponents $b_1,\dotsc,b_r$ found in \eqref{eqn:TMdelta}.
We shall use Lemma~\ref{lem:eta} to write down $d-2$
 linear forms in $b_1,\dotsc,b_n$ with real coefficients,
whose values are very small. We shall later give a method,
based on standard ideas originally due to de Weger,
that uses these
\lq approximate relations\rq\
to reduce our bound for $B = \max(\lvert b_1 \rvert,\dotsc,\lvert b_r \rvert,1)$.

%\medskip

We label the elements of $\cE_K^{\R}$ and $\cE_K^{\C}$ as in
\eqref{eqn:cEdef}, where $\sigma_1=\sigma$.
Write
\[
\theta_j=\sigma_j(\theta),
\quad
\tau_j=\sigma_j(\tau),
\quad
\varepsilon_j=\sigma_j(\varepsilon),
\quad
\delta_{i,j}=\sigma_j(\delta_i),
\qquad 1 \le j \le u+v, \; 1 \le i \le r.
\]
Let
$2 \le j \le u+v$ and write
\[
z_j \; := \; \frac{a_0 X- \theta_1 Y}{a_0 X - \theta_j Y} \, .
\]
Observe that
\begin{equation}\label{eqn:prelinform}
\begin{split}
 Y (\theta_1-
\theta_j)  \; &= \;
  (a_0 X - \theta_j Y) \; - \;
(a_0 X- \theta_1 Y)    \\
&= \;  (a_0 X -\theta_j Y) \cdot
 (1-z_j) \\
& = \;
\tau_j \cdot \delta_{1,j}^{b_1} \cdots \delta_{r,j}^{b_r} \cdot (1-z_j).
\end{split}
\end{equation}
In the following lemma, as always, $\log$ denotes the principal
determination of the logarithm (i.e.\ the imaginary part of
$\log$ lies in $(-\pi,\pi]$).
\begin{lem}\label{lem:log1minusz}
Let
%\[
%c_{27} \; := \; \min\{ \, {\lvert \tau \rvert_\nu} \; : \;
%\nu \in M_K^{\edit{\R}} \, \}\, ,\qquad
%c_{28} \; := \; \max\{ \, {\lvert \tau \rvert_\nu} \; : \;
%\nu \in M_K^\infty \, \}\, ,
%\]
%and
%\[
%c_{29} \; := \; \frac{c_{25}\cdot c_{28}}{ c_{23} \cdot c_{27}} \, ,
%\qquad
%c_{30} \; := \;
%\max\{ 2 c_{17} \cdot c_{24} \, , \; \log{(2 c_{29})}/c_{26}\}.
%\]
\[
c_{27} \; := \; \frac{\lvert \tau_1 \rvert \cdot c_{25}}{\min\{ \, {\lvert \tau_i \rvert} \; : \; \sigma_i \in \cE_K^{\R} \, , \sigma_i \neq \sigma \} \cdot c_{23}}\, ,\qquad
c_{28} \; := \: \frac{\lvert \tau_1 \rvert \cdot c_{25}}{\min\{ \, \lvert \Im(\theta_i) \rvert \; : \; \sigma_i \in \cE_K^{\C} \, \}},\]
and
\[c_{29}(j) \; :=
\begin{dcases}
\frac{\lvert \tau_1 \rvert \cdot c_{25}}{\lvert \tau_j \rvert \cdot c_{23}} & \text{ for }\ 2 \leq j \leq u \\ % \sigma_j \in \cE_K^{\R}\\
\frac{\lvert \tau_1 \rvert \cdot c_{25}}{\lvert \Im(\theta_j)\rvert} & \text{ for }\ u+1 \leq j \leq u+v. %\sigma_j \in \cE_K^{\C},
\end{dcases}\]
Define
\[c_{30} \; := \;
\max\{ 2 c_{17} \cdot c_{24} \, , \; \log{(2 c_{27})}/c_{26} , \; \log{(2 c_{28})}/c_{26}\}
\]
and suppose
$B \, > \, c_{30}$.
Then
\[
\lvert \, \log (1- z_j) \rvert \;
\le \;
2 c_{29}(j)
\cdot \exp(-c_{26} \cdot B)
 \,  \qquad \text{for } 2 \le j \le u+v.\]
\end{lem}
\begin{proof}
Let $2 \le j \le u+v$.
If $\sigma_j \in \cE_K^{\R}$, Lemma~\ref{lem:atmostone} yields
\[
\lvert a_0 X -\theta_j Y \rvert
\; = \; \lvert \tau_j \rvert \cdot \lvert \varepsilon_j \rvert
% \; \ge \; c_{23} \cdot c_{27}\, .
\; \ge \;\lvert \tau_j \rvert \cdot c_{23}\, .
\]
Conversely, if $\sigma_j \in \cE_K^{\C}$, following the proof of Lemma~\ref{lem:cmxbd}, we have
\[
\lvert a_0 X -\theta_j Y \rvert
\; = \; \lvert \tau_j \rvert \cdot \lvert \varepsilon_j \rvert
\; \ge \;\lvert \Im(\theta_j)\rvert \, .
\]
Now, by Lemma~\ref{lem:eta} we have
\[
\lvert a_0 X -\theta_1 Y \rvert \; =\;
\lvert \tau_1 \rvert \cdot \lvert \varepsilon_1 \rvert \; \le \;
% c_{28} \cdot c_{25} \cdot \exp(-c_{26} \cdot B)\, ;
\lvert \tau_1 \rvert \cdot c_{25} \cdot \exp(-c_{26} \cdot B)\, ;
\]
it is in invoking this lemma that we have
made use of the assumption $B> 2 c_{17} \cdot c_{24}$.
Thus
\[\lvert z_j \rvert \; \le \; c_{29}(j) \cdot \exp(-c_{26} \cdot B) \, .\]
Our assumption $B > c_{30} \ge \log{(2 c_{29}(j))}/c_{26}$
gives $\lvert z_j \rvert < 1/2$.
%We conclude (see \cite[page 230]{Smart}) that
From the standard Maclaurin expansion for $\log(1-x)$ we conclude
that
$\lvert  \log (1- z_j) \rvert \, \le \, 2  \cdot \lvert z_j \rvert$,
completing the proof.
\end{proof}

To ease notation, let
\begin{equation}\label{eqn:w}
w\; :=\; u+v-2.
\end{equation}
We now give our first set of $w$ approximate relations.
These only involve our original unknown exponents
$b_1,\dotsc,b_r$ found in \eqref{eqn:TMdelta}.
\begin{lem}\label{lem:linformreal}
Suppose $B>c_{30}$ holds.
Let $1 \le j \le w$.
Let
\[
\beta_j :=
\log \left\lvert
\frac{(\theta_1-\theta_2)\cdot \tau_{j+2}}{(\theta_1-\theta_{j+2})\cdot \tau_2}
\right\rvert \, , \qquad
\alpha_{1,j} := \log \left\lvert \frac{\delta_{1,{j+2}}}{\delta_{1,2}}\right\rvert
 \, ,
\ldots, \,
\alpha_{r,j} := \log \left\lvert \frac{\delta_{r,{j+2}}}{\delta_{r,2}}\right\rvert
\, .
\]
Then
\begin{equation}\label{eqn:linformrl}
\lvert \beta_j+b_1 \alpha_{1,j}+\cdots+b_{r} \alpha_{r,j} \lvert
\; \le \;  2 (c_{29}(2) + c_{29}(j+2)) \cdot \exp(-c_{26} \cdot B).
% 4 c_{29} \cdot \exp(-c_{26} \cdot B).
\end{equation}
\end{lem}
\begin{proof}
From \eqref{eqn:prelinform},
\[
\frac{(\theta_1-\theta_2)\cdot \tau_{j+2}}{(\theta_1-\theta_{j+2})\cdot \tau_{2}}
\cdot
\left(\frac{\delta_{1,j+2}}{\delta_{1,2}}\right)^{b_1}
\cdots
\left(\frac{\delta_{r,j+2}}{\delta_{r,2}}\right)^{b_r}
 \; =\;
\frac{1-z_2}{1-z_{j+2}} \, .
\]
Taking absolute values and then logs
gives
\[
\lvert \beta_j+b_1 \alpha_{1,j}+\cdots+b_{r} \alpha_{r,j} \lvert
\; \le \;  \lvert \log \lvert 1-z_2 \rvert \rvert+
\lvert \log\lvert 1-z_{j+2} \rvert \rvert.
\]
For a complex number $w$, we have
\[
\lvert \log \lvert w \rvert \rvert \; \le \; \lvert \log{w} \rvert
\]
since $\log \lvert w \rvert$ is the real part of $\log{w}$.
 The lemma now follows
from Lemma~\ref{lem:log1minusz}.
\end{proof}
In essense, in the above lemma, we have made use
of the fact that
\begin{equation}\label{eqn:logembed}
K^{\times} \rightarrow \R, \qquad \phi \mapsto \log \lvert \sigma(\phi) \rvert
\end{equation}
is a homomorphism for each embedding $\sigma$ of $K$,
and applied this to the approximate multiplicative
relation \eqref{eqn:prelinform} to obtain an
approximate (additive) relation \eqref{eqn:linformrl}.
If $\sigma$ is complex, then $\sigma$ and its conjugate $\overline{\sigma}$
induce the same homomorphism \eqref{eqn:logembed},
and thus we need only consider
the embeddings $\sigma_1,\dotsc,\sigma_{u+v}$.
Note that although these are $u+v$ embeddings,
we have obtained
only $u+v-2$ approximate relations so far.
That is,
we have had to sacrifice embeddings
because
we wanted to eliminate the two unknowns, $X$ and $Y$.
For $\sigma$ real, $\log \lvert \sigma(\phi) \rvert$
determines $\sigma(\phi)$ up to signs.
However, if $\sigma$ is complex, then \eqref{eqn:logembed}
loses the argument of $\sigma(\phi)$. Thus we should
consider another homomorphism
\begin{equation}\label{eqn:cxlogembed}
K^{\times} \rightarrow \R/\Z \pi, \qquad \phi \mapsto \Im(\log  \sigma(\phi))
\end{equation}
where $\Im(z)$ denotes the imaginary part of a complex number $z$.
Applying these homomorphisms to
\eqref{eqn:prelinform} allows us to obtain additional
approximate relations. Since there are $v$ complex embeddings,
we obtain an additional $v$ approximate relations. However
since these homomorphism are into $\R/\Z\pi$, the approximate
relations are only valid after shifting by an appropriate multiple
of $\pi$; thus for each complex embedding $\sigma_{u+j}$, we will need
an additional parameter $b_{r+j}$.

Recall that $w = u + v -2$.
\begin{lem}\label{lem:linformimag}
Let $1 \le j \le v$.
Let
\[
\beta_{w+j} :=
\Im\left(\log \left(\frac{\theta_1-\theta_{u+j}}{\tau_{u+j}}\right)\right),
\]
\[
\alpha_{1,w+j} := -\Im(\log \delta_{1,u+j}) \, ,
\ldots, \,
\alpha_{r,w+j} := -\Im(\log \delta_{r,u+j})\, ,
\quad
\alpha_{r+j,w+j} := \pi\, .
\]
Suppose $B \, > \, c_{30}$ holds.
Then there is some $b_{r+j} \in \Z$ such that
\begin{multline}\label{eqn:linformcx}
\lvert \beta_{w+j}+b_1 \alpha_{1,w+j}+\cdots+b_{r} \alpha_{r,w+j}+
b_{r+j} \alpha_{r+j,w+j}\lvert
\\
\; \le \;  2 c_{29}(u+j)
\cdot \exp(-c_{26} \cdot B).
\end{multline}
Moreover,
\begin{equation}\label{eqn:bdp1}
\lvert b_{r+j} \rvert \; \le %\; r \cdot B+2 \, .
\; \lvert b_1 \rvert + \cdots+ \lvert b_r\rvert+\frac{\pi+1}{\pi}\, .
\end{equation}
\end{lem}
\begin{proof}
From \eqref{eqn:prelinform},
and Lemma~\ref{lem:log1minusz},
\begin{multline*}
\lvert \log(Y)+
\log((\theta_1-\theta_{u+j})/\tau_{u+j})
-b_1 \log{\delta_{1,u+j}}-\cdots-b_r \log{\delta_{r,u+j}}+b^\prime \cdot \pi i \rvert
\\
\; \le \;
2 c_{29}(u+j)
\cdot \exp(-c_{26} \cdot B),
\end{multline*}
for some $b^\prime \in \Z$.
Thus
\begin{multline*}
\lvert \Im(\log(Y))+ \beta_{w+j}+
b_1 \alpha_{1,w+j}+\cdots+b_r \alpha_{r,w+j}+b^\prime \pi
\rvert
\\
\; \le \;
2 c_{29}(u+j)
\cdot \exp(-c_{26} \cdot B).
\end{multline*}
Recall that $Y \in \Z \setminus \{0\}$,  so
$\Im(\log(Y))$ is either $0$ or $\pi$
depending on whether $Y$ is positive or negative.
We take $b_{r+j}=b^\prime$ in the former case
and $b_{r+j}=b^{\prime}+1$ in the latter case.
This gives \eqref{eqn:linformcx}.

It remains to prove \eqref{eqn:bdp1}.
Our assumption $B>c_{30}$
gives
\[2 c_{29}(u+j) \cdot \exp(-c_{26} \cdot B)<1.\]
Moreover,
$\lvert \beta_{w+j} \rvert \le \pi$ and
$\lvert \alpha_{i,w+j} \rvert \le \pi$ for $0 \le i \le r$.
%Recall that $B=\max(\lvert b_1 \rvert,\dotsc,\lvert b_r \rvert)$.
From \eqref{eqn:linformcx},
%\[
%\begin{split}
%\pi \cdot \lvert b_{r+j} \rvert
%\; & = \; \lvert \alpha_{r+j,w+j}\rvert \cdot \lvert b_{r+j} \rvert \\
%& \le \; \lvert \beta_{w+j} \rvert+\lvert \alpha_{1,w+j} \rvert \cdot \lvert b_1 \rvert
%+ \cdots+ \lvert \alpha_{r,w+j} \rvert \cdot \lvert b_r\rvert+1\\
%& \le \; \pi+rB \cdot \pi+1.
%\end{split}
%\]
\[
\begin{split}
\pi \cdot \lvert b_{r+j} \rvert
\; & = \; \lvert \alpha_{r+j,w+j}\rvert \cdot \lvert b_{r+j} \rvert \\
& \le \; \lvert \beta_{w+j} \rvert+\lvert \alpha_{1,w+j} \rvert \cdot \lvert b_1 \rvert
+ \cdots+ \lvert \alpha_{r,w+j} \rvert \cdot \lvert b_r\rvert+1\\
& \le \; \pi(1 + \lvert b_1 \rvert
+ \cdots+ \lvert b_r\rvert)+1.\\
\end{split}
\]

The lemma follows.
\end{proof}

Summing up, Lemma~\ref{lem:linformreal} and Lemma~\ref{lem:linformimag}
give us $(u+v-2)+v=d-2$ approximate relations \eqref{eqn:linformrl},
\eqref{eqn:linformcx} in integer unknowns $b_1,\dotsc,b_{r+v}$.

%-------------------------------------------------------------------------------------------%
%-------------------------------------------------------------------------------------------%

\section{Reduction of Bounds} \label{sec:red}
We do not know which real embedding $\sigma \in \cE_K^\R$ makes
$\lvert \sigma(\varepsilon) \rvert$ minimal. So the procedure
described below for reducing the bound \eqref{eqn:cB0}
needs
to be repeated for each possible choice of embedding $\sigma$ in $\cE_K^\R$.
Thus, for every possible choice of $\sigma \in \cE_K^\R$, we let
$\sigma_1=\sigma$ and we choose an ordering of the other
embeddings as in \eqref{eqn:cEdef}.
Given a real number $\gamma$, we denote by $[\gamma]$
the nearest integer to $\gamma$, with the convention
that $[k+1/2]=k+1$ for $k \in \Z$.
Let $n$ be as in \eqref{eqn:nrv} and observe that
\[
n=(s+1)+d-2,
\]
where we recall that $s=\#S$.
Let $C$ be a positive integer to be chosen later. Let $\mathbf{I}_{m}$ and $\mathbf{0}_{i,j}$ be the $m \times m$ identity matrix and $i \times j$ zero matrix, respectively. Let $M$ be
the following $n \times n$ matrix
\[
  M:=
  \left[\begin{array}{c:@{}c@{}:@{}c@{}}
          \mathbf{0}_{w,s+1}
          & \begin{array}{ccc}
              [C\alpha_{1,1}] & \cdots & [C\alpha_{1,w}]\\ \relax
              \vdots & & \vdots \\ \relax
              [C\alpha_{w,1}] & \cdots & [C\alpha_{w,w}]
            \end{array}
          & \begin{array}{ccc}
              [C\alpha_{1,w+1}] & \cdots & [C\alpha_{1,d-2}] \\ \relax
              \vdots & &\vdots \\ \relax
              [C\alpha_{w,w+1}] & \cdots & [C\alpha_{w,d-2}]
            \end{array} \Bstrut \\ \hdashline
          \mathbf{I}_{s+1}
          & \begin{array}{ccc}
              [C\alpha_{w+1,1}] & \cdots & [C\alpha_{w+1,w}]\\ \relax
              \vdots & & \vdots \\ \relax
              [C\alpha_{r,1}] & \cdots & [C\alpha_{r,w}]
            \end{array}
          & \begin{array}{ccc}
              [C\alpha_{w+1,w+1}] & \cdots & [C\alpha_{w+1,d-2}] \\ \relax
              \vdots & &\vdots \\ \relax
              [C\alpha_{r,w+1}] & \cdots & [C\alpha_{r,d-2}]
            \end{array} \Bstrut \Tstrut \\ \hdashline
          \mathbf{0}_{v,s+1}
          & \mathbf{0}_{v,w}
          & [C\pi] \cdot \mathbf{I}_{v} \Tstrut
        \end{array}\right] \]

\begin{comment}
    \[  M:=
 \left[\begin{gathered}
   \tikzpicture[every node/.style={anchor=south west}]
        %\node[minimum width=1.5cm,minimum height=1.2cm] at (0,2.9) {$I_{s+1}$};
        \node[minimum width=2.5cm,minimum height=1.2cm] at (-1,2.3) {
	$\displaystyle
	\begin{matrix}
	1 & 0 & \cdots  & 0\\
	0 & 1 & \cdots & 0\\
	\vdots &  & \ddots & \vdots \\
	0 & 0 & \cdots & 1 \\
	\end{matrix}
	$
	};
        \node[minimum width=2.5cm,minimum height=1.2cm] at (-1,0) {
	$\displaystyle
	\begin{matrix}
	0 & 0 & \cdots  & 0\\
	0 & 0 & \cdots & 0\\
	0 & 0 & \cdots & 0\\
	\vdots &  &  & \vdots \\
	0 & 0 & \cdots & 0 \\
	\end{matrix}
	$
	};
        %\node[minimum width=1.5cm,minimum height=.4cm] at (0,1.3) {$\mbox{\normalfont\Large\bfseries 0}$};
        %\node[minimum width=2cm,minimum height=.6cm] at (0,0) {$C_2$};
        \node[minimum width=4.5cm,minimum height=1.2cm] at (1.5,0) {
	$\displaystyle
	\begin{matrix}
	[C\alpha_{1,1}] & [C\alpha_{1,2}] & \cdots  & [C\alpha_{1,w}]\\
	[C\alpha_{2,1}] & [C\alpha_{2,2}] & \cdots & [C\alpha_{2,w}]\\
	[C\alpha_{3,1}] & [C\alpha_{3,2}] & \cdots & [C\alpha_{3,w}]\\
	\vdots & \vdots & & \vdots \\
	[C\alpha_{r,1}] & [C\alpha_{r,2}] & \cdots & [C\alpha_{r,w}] \\
	0 & 0 & \cdots & 0 \\
	0 & 0 & \cdots & 0 \\
	\vdots & \vdots & & \vdots\\
	0 & 0 & \cdots & 0 \\
	\end{matrix}
	$
	};
        \node[minimum width=4.5cm,minimum height=1.2cm] at (6.7,0) {
	$\displaystyle
	\begin{matrix}
	[C\alpha_{1,w+1}] & [C\alpha_{1,w+2}] & \cdots  & [C\alpha_{1,d-2}]\\
	[C\alpha_{2,w+1}] & [C\alpha_{2,w+2}] & \cdots & [C\alpha_{2,d-2}]\\
	[C\alpha_{3,w+1}] & [C\alpha_{3,w+2}] & \cdots & [C\alpha_{3,d-2}]\\
	\vdots & \vdots & & \vdots \\
	[C\alpha_{r,w+1}] & [C\alpha_{r,w+2}] & \cdots & [C\alpha_{r,d-2}] \\
	[C\pi] & 0 & \cdots & 0 \\
	0 & [C\pi] & \cdots & 0 \\
	\vdots &   & \ddots & \vdots \\
	0 & 0 & \cdots & [C\pi] \\
	\end{matrix}
	$
	};
        %\node[minimum width=4.5cm,minimum height=1.2cm] at (1.5,1.2) {$M_{3,7}^{[1]}$};
        \draw[dashed] (-0.9,2.47) -- (1.5,2.47);
        \draw[dashed] (1.5,0.1) -- (1.5,4.3);
	\draw[dashed] (6.6,0.1) -- (6.6,4.3);
        %\draw[dashed] (0,0.6) -- (2,0.6);
        %\draw[dashed] (2,0) -- (2,1.2);
	\node (wall1) %[minimum height=2cm]
	at (-1,0) {};
	\node (mass) %[minimum width=0.5cm,minimum height=0.5cm]
	at (1.4,0) {};
	\draw [
    thick,
    decoration={
        brace,
        mirror,
        raise=0.5cm
    },
    decorate
] (wall1) -- (mass)
	node [pos=0.5,anchor=north,yshift=-0.55cm]
	{$s+1$};
	\endtikzpicture
    \end{gathered}\right]
\]
\end{comment}
and let $L$ be the sublattice of $\Z^n$ spanned by the rows of $M$.
Let
%\begin{gather*}
%\ww:= (\underbrace{0,0,\dotsc,0}_{s+1},[C \beta_1],\dotsc,[C \beta_{d-2}])
%\in \Z^n, \\
%\cB_2 \; :=\; \frac{ r \cB_{\infty}+1}{2} , \qquad
%\cB_3 \; :=\; \frac{2 r \cB_{\infty}+3}{2} , \qquad
%\cB_4 \; :=\; \frac{2w \cdot \cB_2+v \cdot \cB_3}{4w+v} \, ,\\
%\cB_5 \; :=\; \sqrt{(s+1) \cB_{\infty}^2+ w \cdot \cB_2^2+v \cdot \cB_3^2} \, ,
%\end{gather*}
\begin{gather*}
\ww:= (\underbrace{0,0,\dotsc,0}_{s+1},[C \beta_1],\dotsc,[C \beta_{d-2}])
\in \Z^n, \\
\cA_1 \; :=\; \frac{1+\cB_1}{2}, \qquad \cA_2 \; :=\; \frac{2\pi(1+\cB_1) + 1}{2\pi},\\
\cB_3 \; :=\; \sum_{j=1}^w(c_{29}(2) + c_{29}(j+2))^2 + \sum_{j=1}^vc_{29}(u+j)^2,\\
\cB_4 \; :=\; \cA_1\sum_{j=1}^w(c_{29}(2) + c_{29}(j+2)) + \cA_2\sum_{j=1}^vc_{29}(u+j) , \\
\text{ and } \quad \cB_5 \; :=\; \sqrt{\cB_2^2 - w\cB_{\infty}^2+ w\cA_1^2 + v\cA_2^2} \, .
\end{gather*}

\begin{prop}\label{prop:boundImprove}
Suppose $\ww \notin L$ and $D(L,\ww) > \cB_5$.
Then
%\begin{equation}\label{eqn:Bfinal}
%B \; \le \;
%\max \left(
%\; c_{30} \quad , \quad
%\frac{1}{c_{26}}
%\cdot
%\log{\left(
%\frac{2 C \cdot c_{29}}{
%\sqrt{\frac{D(L,\ww)^2-\cB_5^2+(4w+v)\cdot \cB_4^2}{4w+v}} \, - \, \cB_4
%}
%\right)} \right) \, .
%\end{equation}
\begin{equation}\label{eqn:Bfinal}
B \; \le \;
\max \left(
\; c_{30} \quad , \quad
\frac{1}{c_{26}}
\cdot
\log{\left(
\frac{2 C \cdot \cB_3}{\sqrt{\cB_3(D(L,\ww)^2-\cB_5^2)+\cB_4^2}\, - \, \cB_4}
\right)} \right) \, .
\end{equation}
\end{prop}

\begin{proof}
If $B \le c_{30}$ then \eqref{eqn:Bfinal} holds. We will therefore
suppose that $B> c_{30}$. Thus,
inqualities \eqref{eqn:linformrl} and \eqref{eqn:linformcx} hold.
Write
\[
\ww+\bb M  \; = \;
(b_{u+v-1},b_{u+v},\dotsc,b_{r}, \Theta_1, \Theta_2,\dotsc,\Theta_{d-2})\, .
\]

For $1 \le j \le w$,
%\[
%\begin{split}
%\lvert \Theta_j \rvert
%\; & \le \; \frac{1}{2}+\frac{\lvert b_1 \rvert}{2}+\cdots
%+ \frac{\lvert b_r \rvert}{2} \, + \,
%C \cdot \lvert \beta_j+b_1\alpha_{1,j}+\cdots + b_r \alpha_{r,j} \rvert\\
%\; & \le  \; \frac{r \cB_{\infty}+1}{2} \, +\,
%4 C \cdot c_{29} \cdot \exp(-c_{26} \cdot B)
%\qquad
%\text{(by \eqref{eqn:cB0} and \eqref{eqn:linformrl})}\\
%\; &\le \; \cB_2 \, + \,
% 2 \eta, \\
%\end{split}
%\]
\[
\begin{split}
\lvert \Theta_j \rvert
\; & \le \; \frac{1}{2}+\frac{\lvert b_1 \rvert}{2}+\cdots
+ \frac{\lvert b_r \rvert}{2} \, + \,
C \cdot \lvert \beta_j+b_1\alpha_{1,j}+\cdots + b_r \alpha_{r,j} \rvert\\
\; & \le \frac{1 + \cB_1}{2} \, +
2 C\cdot(c_{29}(2) + c_{29}(j+2)) \cdot \exp(-c_{26} \cdot B) \\
%\qquad
%\text{(by \eqref{eqn:cB0} and \eqref{eqn:linformrl})}\\
\; &\le \; \cA_1 \, + (c_{29}(2) + c_{29}(j+2))\cdot\eta, \\
\end{split}
\]
where the second inequality follows by \eqref{eqn:cB0} and \eqref{eqn:linformrl}, and $\eta := 2 C \cdot \exp(-c_{26} \cdot B)$.

Recall that $w:=u+v-2$. For $1 \le j \le v$,
%\[
%\begin{split}
%\lvert \Theta_{w+j} \rvert
%\; & \le \; \frac{1}{2}+\frac{\lvert b_1 \rvert}{2}+\cdots
%+ \frac{\lvert b_r \rvert}{2}+\frac{\lvert b_{r+j}\rvert}{2} \, + \,
%C \cdot \lvert \beta_j+b_1\alpha_{1,w+j}+\cdots + b_r \alpha_{r,w+j}+b_{r+j}\pi \rvert\\
% & \le  \;
%\frac{r \cB_{\infty}+1}{2} \, +\,
%\frac{r \cB_{\infty}+2}{2} \, +\,
%2 C \cdot c_{29} \cdot \exp(-c_{26} \cdot B)
%\qquad \text{(by \eqref{eqn:cB0}, \eqref{eqn:bdp1} and \eqref{eqn:linformcx})}\\
%&\le \; \frac{2r \cB_{\infty}+3}{2} \, + \,
%2 C \cdot c_{29} \cdot \exp(-c_{26} \cdot B) \\
%&\le \; \cB_3 \, + \, \eta \, . \\
%\end{split}
%\]
\begin{align*}
\lvert \Theta_{w+j} \rvert
\; & \le \; \frac{1}{2}+\frac{\lvert b_1 \rvert}{2}+\cdots
+ \frac{\lvert b_r \rvert}{2}+\frac{\lvert b_{r+j}\rvert}{2} \\
& \qquad \qquad+ C \cdot \lvert \beta_{w+j}+b_1\alpha_{1,w+j}+\cdots + b_r \alpha_{r,w+j}+b_{r+j}\pi \rvert\\
\; & \le \; \frac{2\pi + 1}{2\pi}+ \cB_1+ \,
2C \cdot c_{29}(u+j)\cdot \exp(-c_{26} \cdot B)\\
%\qquad \text{(by \eqref{eqn:cB0}, \eqref{eqn:bdp1} and \eqref{eqn:linformcx})}\\
&\le \; \cA_2 + c_{29}(u+j)\cdot \eta,
\end{align*}
where the second inequality follows from \eqref{eqn:cB0}, \eqref{eqn:linformcx}, and \eqref{eqn:bdp1}.

Since $\ww \notin L$, we have
%\begin{equation}\label{eqn:DLT}
%\begin{split}
%D(L,\ww)^2 \; & \le \; \lVert \ww+ \bb M \rVert^2 \\
%& = \; \edit{b_{u+v-1}^2+\cdots +b_{u+v}^2}+
%\Theta_1^2+\cdots+\Theta_{d-2}^2\\
%& \le \; (s+1) \cB_{\infty}^2+
%w\cdot \left(
% \cB_2 \, + \,
% 2 \eta
%\right)^2 + v \cdot
%\left(
%\cB_3 \, + \, \eta
%\right)^2\\
%& = \; \cB_5^2+(4w\cB_2+2v \cB_3)\eta+(4w+v)\eta^2 \\
%& = \; \cB_5^2+2(4w+v)\cB_4 \cdot \eta+(4w+v)\eta^2 \\
%& = \;
%(4w+v) \cdot \left(\eta \, + \, \cB_4 \right)^2
%\,+ \,
%\cB_5^2 - (4w+v) \cB_4^2 \, .
%\end{split}
%\end{equation}
\begin{equation*}%\label{eqn:DLT}
\begin{split}
D(L,\ww)^2 \; & \le \; \lVert \ww+ \bb M \rVert_2^2 \\
& = \; b_{u+v-1}^2+\cdots +b_{r}^2+
\Theta_1^2+\cdots+\Theta_{d-2}^2\\
& \le \; \cB_5^2+(2\cB_4)\eta+\cB_3\eta^2 \\
& = \; \cB_5^2+ \cB_3\left(\eta + \frac{\cB_4}{\cB_3}\right)^2 - \frac{\cB_4^2}{\cB_3}.
\end{split}
\end{equation*}
Recall our assumption that $\cB_5 \, < \, D(L,\ww)$.
Thus
%\[
%(4w+v)\cdot \cB_4^2 \; < \; D(L,\ww)^2 - \cB_5^2 + (4w+v) \cdot \cB_4^2 \; \le \; (4w+v) \cdot (\eta+\cB_4)^2.
%\]
\[\frac{\cB_4^2}{\cB_3} \; < \; D(L,\ww)^2 - \cB_5^2 + \frac{\cB_4^2}{\cB_3} \; \le \; \cB_3 \left(\eta + \frac{\cB_4}{\cB_3}\right)^2,\]
and so
%\[
%0 \; < \; \sqrt{\frac{D(L,\ww)^2-\cB_5^2+(4w+v)\cdot \cB_4^2}{4w+v}} \, - \, \cB_4 \;
%\le \; \eta \, .
%\]
\[0 \; < \; \frac{\sqrt{\cB_3(D(L,\ww)^2-\cB_5^2)+\cB_4^2}\, - \, \cB_4}{\cB_3} \;
\le \; \eta.\]
However $\eta := 2 C \cdot \exp(-c_{26} \cdot B)$.
This yields the bound
%\[
%B \; \le \;
%\frac{1}{c_{26}}
%\cdot
%\log{\left(
%\frac{2 C \cdot c_{29}}{
%\sqrt{\frac{D(L,\ww)^2-\cB_5^2+(4w+v)\cdot \cB_4^2}{4w+v}} \, - \, \cB_4
%}
%\right)}
%\]
\[
B \; \le \;
\frac{1}{c_{26}}
\cdot
\log{\left(
\frac{2 C \cdot \cB_3}{\sqrt{\cB_3(D(L,\ww)^2-\cB_5^2)+\cB_4^2}\, - \, \cB_4}
\right)},
\]
which gives \eqref{eqn:Bfinal}.
\end{proof}

\noindent \textbf{Heuristic.}
It remains to decide on a reasonable choice
for $C$. We expect that the determinant of the matrix $M$ is approximately $C^{d-2}$. Thus the distance between adjacent vectors in $L$
is expected to be in the region of $C^{(d-2)/n}$, and so we anticipate
(very roughly) that $D(L,\ww) \sim C^{(d-2)/n}$. We would like
$D(L,\ww)> \cB_5$. Therefore it is reasonable to choose $C \gg \cB_5^{n/(d-2)}$.
If, for a particular choice of $C$, the condition $D(L,\ww)>\cB_5$ fails,
then we simply try again with a larger choice of $C$. \\

%\bigskip

\noindent \textbf{Remark.} Our approach is somewhat unusual
in that it uses all $d-2$ available approximate relations
to reduce the initial bound. In contrast, it is much more
common to use one relation (e.g.\ \cite[Section 16]{TW})
to reduce the bound. In most examples, we have found
that both approaches give similar reductions in the size
of the bound and that there is no advantage in using one
over the other. However in some examples the approach
of using only one relation fails spectacularly. Here
are two such scenarios. % where it does fail.
\begin{enumerate}
\item[(i)] Suppose $\delta_1$ (say) belongs to a
proper subfield $K^\prime$ of $K$. Now let
$\sigma_2$, $\sigma_3$ be distinct embeddings of $K$
that agree on $K^\prime$. Then, in the notation
of Lemma~\ref{lem:linformreal} we find
 $\alpha_{1,3}=\log\lvert \sigma_3(\delta_1)/\sigma_2(\delta) \rvert=0$, and so the coefficient of the unknown $b_1$ is zero
in the approximate relation \eqref{eqn:linformrl}. Therefore
the one relation \eqref{eqn:linformrl} on its own fails to provide
any information on the size of $b_1$. In practice,
the lattice constructed in \cite[Section 16]{TW}
from this one relation will contain the tiny
vector $(1,0,\dotsc,0)$, and this will result in
the computational failure of the closest vector algorithm.
\item[(ii)] We continue to suppose that
 $\delta_1$ belongs to the proper subfield $K^\prime$
as above. Let $\sigma_{u+1}$ be a complex embedding of $K$
that extends a real embedding of $K^\prime$, and suppose for
simplicity that $\sigma_{u+1}(\delta_1)$ is positive. Then
again, $\alpha_{1,w+1}=0$ in the approximate relation
\eqref{eqn:linformcx}, and so that relation on its own
fails to control $b_1$.
\end{enumerate}
In the above two examples, we chose to illustrate the possible
failure of the approach of using one relation by imposing
$\delta_1 \in K^\prime$ where $K^\prime$ is a subfield of $K$.
However, a similar failure occurs (and is more difficult to
find) if the $S$-unit basis $\delta_1,\dotsc,\delta_r$
is multiplicatively dependent over $K^\prime$, meaning that
there is some non-trivial $(c_1,\dotsc,c_r) \in \Z^r$
such that $\delta_1^{c_1} \cdots \delta_r^{c_r} \in K^\prime$.

%-------------------------------------------------------------------------------------------%

\subsection*{Example 5 continued}
We continue giving details for
the tuple
$(\tau,\delta_1,\dotsc,\delta_{10})$
given on page~\pageref{page:taudeltatuple}.
The values of $\cB_{\infty}$ and $\cB_2$ are given
in \eqref{eqn:cB0bd}. The set $S$
consists of five primes
$\fp_1,\dotsc,\fp_5$
given by \eqref{eqn:primesS}.
By applying Proposition~\ref{prop:valbd} we
had
(page~\pageref{page:fpbounds})
obtained bounds
$237$, $292$, $354$, $518$, $821$ for $\ord_{\fp_j}(a_0 X- \theta Y)$
with $i=1,\dotsc,5$ respectively; these are the values
denoted $k_j-1$ in \eqref{eqn:kjminus1}.
Now $\ord_{\fp_j}(\tau)=0,0,1,0,0$ respectively for
$j=1,\dotsc,5$. Letting $\varepsilon$ be as in \eqref{eqn:varepsilondef},
we may take $(-k_j^\prime,k_j^{\prime\prime})$ in \eqref{eqn:valbds}
to be $(0,237)$, $(0,292)$, $(-1,353)$, $(0,518)$, $(0,821)$
respectively.
This allows us to compute the constant $c_{21}$ defined in Lemma~\ref{lem:c21}.
We find that $c_{21} \approx 2842.79$.
The field $K$ has signature $(u,v)=(1,5)$
and thus there is only one possibility for $\sigma \in \cE_K^{\R}$.
We therefore take $\sigma_1=\sigma$ to be the unique real embedding.
For illustration, we give the values of constants appearing
in Section~\ref{sec:LFRL}:
\begin{gather*}
c_{22}\approx 30.31, \quad
c_{23}=1, \quad
c_{24} \approx 2873.10, \quad
c_{25} \approx 5.91 \times 10^{1247}, \quad
c_{26} \approx 0.35, \\
c_{27} \approx 5.91 \times 10^{1247}, \quad
c_{28} \approx 1.40 \times 10^{1246}, \quad
c_{29}(2) \approx 1.25 \times 10^{1246}, \\
c_{29}(3) \approx 8.30 \times 10^{1245}, \quad
c_{29}(4) \approx 7.83 \times 10^{1245}, \quad
c_{29}(5) \approx 9.21 \times 10^{1245}, \\
c_{29}(6) \approx 1.40 \times 10^{1246}, \quad
c_{30} \approx 8290.02.
\end{gather*}
Lemma~\ref{lem:linformreal} gives $w=u+v-2=4$ approximate relations
and Lemma~\ref{lem:linformimag} gives another $v=5$ relations.
Therefore we have $d-2=9$ relations altogether,
and $n=\#S+d-2=15$. Therefore the matrix $M$ is $15 \times 15$
and the lattice $L$ belongs to $\Z^{15}$.
We find that
\begin{gather*}
\cB_1\approx 7.85 \times 10^{222},\quad
\cA_1 \approx 3.92 \times 10^{222}, \quad
\cA_2 \approx 7.85 \times 10^{222},\quad
\cB_3 \approx 2.59 \times 10^{2493},\\
\cB_4 \approx 7.57 \times 10^{1469},\quad \text{ and } \quad
\cB_5 \approx 1.93 \times 10^{223}.
\end{gather*}
In accordance with the above heuristic, our program chooses
\[
C=\left[\cB_5^{n/(d-2)} \right] \approx 1.39 \times 10^{372}.
\]
The matrix $M$ and the lattice $L$ are too huge to reproduce here,
but we point out that
\[
[\Z^{15} : L] \approx 2.66 \times 10^{3357}; %6.48 \times 10^{3360},
\qquad D(L,\ww) \approx 7.23 \times 10^{223}. % 7.763 \times 10^{225}.
\]
Hence the hypothesis $D(L,\ww)> \cB_5$ of Proposition~\ref{prop:boundImprove}
is satisfied. We also find (rather unsurprisingly) that $\ww \notin L$.
We may therefore apply Proposition~\ref{prop:boundImprove}
to obtain a new bound for $B$ given by \eqref{eqn:Bfinal}:
\[
B \le 9270.82. %9346.61.
\]
We now start again with $\cB_{\infty}=9270$ and repeat the previous
steps, first for obtaining bounds for $\ord_{\fp_j}(a_0 X- \theta Y)$
and then for writing down the lattice $L$ and applying
Proposition~\ref{prop:boundImprove}. The following table
illustrates the results.

\begin{table}[h]
{\renewcommand{\arraystretch}{1.1} %<- modify value to suit your needs
\begin{tabular}{|c||c||c|c|c|c|c|}
\hline
Iteration & $\cB_{\infty}$ &
\multicolumn{5}{c|}{bounds for $\ord_{\fp_j}(a_0 X- \theta Y)$}\\
& & \multicolumn{5}{c|}{with $1 \le j \le 5$}\\
\hline\hline
0 & $1.57 \times 10^{222}$ &
237 & 292 & 354 & 518 & 821\\
\hline
1 & 9270 & 4 & 5 & 8 & 10 & 15\\
\hline
2 & 251 & 3 & 3 & 5 & 6 & 10 \\
\hline
3 & 190 & 2 & 3 & 5 & 6 & 9 \\
\hline
4 & 180 & 2 & 3 & 5 & 6 & 9 \\
\hline
5 & 180 & 2 & 3 & 5 & 6 & 9 \\
\hline\hline
\end{tabular}}
\vspace{0.5em}
\caption{We successively reduce the bounds for
$B$ and for $\ord_{{\fp_j}}(a_0 X- \theta Y)$
where $j=1,\dotsc,5$.}\label{table:bounds}
\end{table}

Note that at the fifth iteration we fail to obtain any improvement
on the bounds, and so we stop there. Recall that $r=10$
and that $B=\max(\lvert b_1\rvert,\dotsc,\lvert b_{10}\rvert)$, where
$b_1,\dotsc,b_{10}$ are the exponents in \eqref{eqn:TMdelta}.
Our final bound is $B \le 180$. The set of possible
integer tuples $(b_1,\dotsc,b_{10})$ satisfying this bound
has size
\[
(2 \times 180+1)^{10} \; =\; 362^{10} \approx 3.86 \times 10^{25}.
\]
The huge size of this region does not allow
brute force enumeration of the solutions. Instead, one can reduce
the number of tuples to consider by using the bounds
we have obtained for $\ord_{\fp_j}(a_0 X-\theta Y)$.
We let $\kappa_j= 2$, $3$, $5$, $6$, $9$ for $j=1,\dotsc,5$,
respectively. We know that $0 \le \ord_{\fp_j}(a_0 X-\theta Y) \le \kappa_j$,
and so there are $\kappa_j+1$ possibilities for the
$\ord_{\fp_j}(a_0 X-\theta Y)$. Let $(k_1,\dotsc,k_5)$ be some tuple of integers
satisfying $0 \le k_j \le \kappa_j$. The condition
$\ord_{\fp_j}(a_0 X-\theta Y)=k_j$
simply defines a hyperplane of codimension $1$
in the space of possible $(b_1,\dotsc,b_{10})$.
Imposing all five conditions
$\ord_{\fp_j}(a_0 X-\theta Y)=k_j$
with $j=1,\dotsc,5$ cuts down the dimension from $10$ to $5$.
Thus we expect that the search region should (very roughly) have size
\[
(\kappa_1+1) \cdots (\kappa_{5}+1) \cdot 362^{5}
\approx 3.13 \times 10^{16}.
\]
This is still way beyond brute force enumeration
and motivates our next section.

\begin{comment}
\subsection*{Example 5 continued}
We continue giving details for
the tuple
$(\tau,\delta_1,\dotsc,\delta_{10})$
given on page~\pageref{page:taudeltatuple}.
The values of $\cB_{\infty}$ and $\cB_1$ are given
in \eqref{eqn:cB0bd}. The set $S$
consists of five primes
$\fp_1,\dotsc,\fp_5$
given \eqref{eqn:primesS}.
By applying Proposition~\ref{prop:valbd} we
had
(page~\pageref{page:fpbounds})
obtained bounds
$237$, $292$, $355$, $518$, $821$ for $\ord_{\fp_j}(a_0 X- \theta Y)$
with $i=1,\dotsc,5$ respectively; these are the values
denoted $k_j-1$ in \eqref{eqn:kjminus1}
Now $\ord_{\fp_j}(\tau)=0,0,1,0,0$ respectively for
$j=1,\dotsc,5$. Letting $\varepsilon$ be as in \eqref{eqn:varepsilondef},
we may take $(-k_j^\prime,k_j^{\prime\prime})$ in \eqref{eqn:valbds}
to be $(0,237)$, $(0,292)$, $(-1,354)$, $(0,518)$, $(0,821)$
respectively.
This allows us to compute the constant $c_{21}$ defined in Lemma~\ref{lem:c21}.
We find that $c_{21} \approx 2844.40$.
The field $K$ has signature $(u,v)=(1,5)$
and thus there is only one possibility for $\sigma \in \cE_K^{\R}$.
We therefore take $\sigma_1=\sigma$ to be the unique real embedding.
For illustration we give the values of constants appearing
in Section~\ref{sec:LFRL}:
\begin{gather*}
c_{22}\approx 30.31, \quad
c_{23}=1, \quad
c_{24} \approx 2874.71, \quad
c_{25} \approx 2.96 \times 10^{1248}, \quad
c_{26} \approx 0.35, \\
c_{27} \approx 5.68 \times 10^{-5}, \quad
c_{28} \approx 2340742.23, \quad
c_{29} \approx 1.22\times 10^{1259}, \quad
c_{30} \approx 8367.19.
\end{gather*}
Lemma~\ref{lem:linformreal} gives $w=u+v-2=4$ approximate relations
and Lemma~\ref{lem:linformimag} gives another $v=5$ relations.
Therefore we have $d-2=9$ relations altogether,
and $n=\#S+d-2=15$. Therefore the matrix $M$ is $15 \times 15$
and the lattice $L$ belongs to $\Z^{15}$.
We found that
\[
\cB_2\approx 7.85 \times 10^{222},\quad
\cB_3 \approx 1.57 \times 10^{223},\quad
\cB_4 \approx 6.73 \times 10^{222},\quad
\cB_5 \approx 3.86 \times 10^{223}.
\]
In accordance with the above heuristic, our program
chose
\[
C=\left[\cB_5^{n/(d-2)} \right] \approx 4.41 \times 10^{372}.
\]
The matrix $M$ and the lattice $L$ are too huge to reproduce here,
but we point out that
\[
[\Z^{15} : L] \approx 6.48 \times 10^{3360},
\qquad D(L,\ww) \approx 7.763 \times 10^{225}.
\]
Hence the hypothesis $D(L,\ww)> \cB_5$ of Proposition~\ref{prop:boundImprove}
is satisfied. We also find (rather unsurprisingly) that $\ww \notin L$.
We may therefore apply Proposition~\ref{prop:boundImprove}
to obtain a new bound for $B$ given by \eqref{eqn:Bfinal}:
\[
B \le 9346.61.
\]
We now start again with $\cB_{\infty}=9346$ and repeat the previous
steps, first for obtaining bounds for $\ord_{\fp_j}(a_0 X- \theta Y)$
and then for writing down the lattice $L$ and applying
Proposition~\ref{prop:boundImprove}. The following table
illustrates the results.

\begin{table}[h]
\begin{tabular}{|c||c||c|c|c|c|c||}
\hline\hline
Iteration & $\cB_{\infty}$ &
\multicolumn{5}{c||}{bounds for $\ord_{\fp_j}(a_0 X- \theta Y)$}\\
& & \multicolumn{5}{c||}{with $1 \le j \le 5$}\\
\hline\hline
0 & $1.57 \times 10^{222}$ &
237 & 292 & 355 & 518 & 821\\
\hline
1 & 9346 & 4 & 5 & 8 & 10 & 16\\
\hline
2 & 327 & 3 & 3 & 5 & 7 & 11 \\
\hline
3 & 265 & 3 & 3 & 5 & 7 & 10 \\
\hline
4 & 263 & 3 & 3 & 5 &  7 & 10\\
\hline
5 & 263 & 3 & 3 & 5 &  7 & 10\\
\hline
\end{tabular}
\caption{We successively reduce the bounds both for
$B$ and for $\ord_{{\fp_j}}(a_0 X- \theta Y)$
where $j=1,\dotsc,5$.}\label{table:bounds}
\end{table}

Note that at the fifth iteration we fail to obtain any improvement
in the bounds and so we stop here. Recall that $r=10$
and that $B=\max(\lvert b_1\rvert,\dotsc,\lvert b_{10}\rvert)$ where
$b_1,\dotsc,b_{10}$ are the exponents in \eqref{eqn:TMdelta}.
Our final bound is $B \le 263$. The set of possible
integer tuples $(b_1,\dotsc,b_{10})$ satisfying this bound
has size
\[
(2 \times 263+1)^{10} \; =\; 527^{10} \approx 1.65 \times 10^{27}.
\]
The huge size of the region does not allow
brute force enumeration of the solutions. One can reduce
the number of tuples to consider by using the bounds
we have obtained for $\ord_{\fp_j}(a_0 X-\theta Y)$.
We let $\kappa_j=3$, $3$, $5$, $7$, $10$ for $j=1,\dotsc,5$
respectively. We know that $0 \le \ord_{\fp_j}(a_0 X-\theta Y) \le \kappa_j$,
and so there are $\kappa_j+1$ possibilities for the
$\ord_{\fp_j}(a_0 X-\theta Y)$. Imposing
Let $(k_1,\dotsc,k_5)$ be some tuple of integers
satisfying $0 \le k_j \le \kappa_j$. The condition
$\ord_{\fp_j}(a_0 X-\theta Y)=k_j$
simply defines a hyperplane of codimension $1$
in the space of possible $(b_1,\dotsc,b_{10})$.
Imposing all five conditions
$\ord_{\fp_j}(a_0 X-\theta Y)=k_j$
with $j=1,\dotsc,5$ cuts down the dimension form $10$ to $5$.
Thus we expect that search region should (very roughly) have size
\[
(\kappa_1+1) \cdot \cdots \cdot (\kappa_{5}+1) \cdot 527^{5}
\approx 3.43 \times 10^{17}.
\]
This is still way beyond brute force enumeration
and motivates our next section.
\end{comment}

%-------------------------------------------------------------------------------------------%
%-------------------------------------------------------------------------------------------%

\section{Sieving}\label{sec:sieve}

In order to resolve the Thue--Mahler equation
\begin{equation*}
  F(X,Y)=a \cdot
  p_1^{z_1} \cdots p_v^{z_v}, \qquad
  X,~Y \in \Z, \;
  \gcd(X,Y)=\gcd(a_0,Y)=1,
\end{equation*}
we have first reduced the problem to that of resolving a number of equations of the form \eqref{eqn:TMdelta}, subject to the restrictions \eqref{eqn:restrictions}.
%  We have explained how to reduce our original
%Thue--Mahler equation \eqref{eqn:TM} to equations
%of the form \eqref{eqn:TMdelta}
%subject to the restrictions \eqref{eqn:restrictions}.
Recall that $B=\max(\lvert b_1 \rvert, \dotsc,\lvert b_r \rvert,1)$, while $\bb=(b_1,\dotsc,b_r) \in \Z^r$ denotes the vector of unknown exponents to solve for.
%$B:=\max(\lvert b_1 \rvert, \dotsc,\lvert b_r \rvert)$.
For each such equation \eqref{eqn:TMdelta}, we have used the theory of linear forms in logarithms %We have explained how to use the theory of linear
% forms in logarithms
to obtain a bound for $B$, and moreover, we have explained
how to repeatedly reduce this bound. % on $B$.
During each of these iterations, we have simultaneously reduced the bounds on the $L^{\infty}$-norm, the $L^1$-norm, and the $L^2$-norm of $\bb$.
Let us denote the final bound for the $L^{\infty}$-norm of $B$ by $\cB_f^{\prime}$ and write $\cB_f$ for the final bound on the $L^2$-norm of $\bb$.
%Write \edit{$\cB_{f,1}:=\sqrt{r} \cdot \cB_f^\prime$}.
Thus
\begin{equation}\label{eqn:cBf}
\lVert \bb \rVert_2 \le \cB_{f}.
\end{equation}
We have also explained how to obtain and reduce the bounds on
$\ord_\fp(a_0 X- \theta Y)$
for $\fp \in S$. Suppose that at the end of this process,
our bounds are
\begin{equation}\label{eqn:finalvalbd}
0 \le \; \ord_\fp(a_0 X- \theta Y) \; \le \kappa_\fp, \quad \text{for $\fp \in S$}.
\end{equation}
Unfortunately, in our high rank examples (i.e. when the
$S$-unit rank $r$ is large) the final bound $\cB_{f}^{\prime}$
is often
too large to allow for brute force enumeration of solutions. Instead, we shall sieve for solutions using both the primes $\fp$ in $S$,
and also rational primes $p$ whose support in $\OO_K$ is disjoint from $S$.
The objective of the sieve is to show that the solutions $\bb$
belong to a union of a certain (hopefully small) number of cosets $\ww+L$,
where the $L$ are sublattices of $\Z^r$. As the sieve progresses,
the determinants of the lattices $L$ will grow. The larger the
determinant, the fewer vectors we expect belonging to
$\ww+L$ and satisfying $\lVert \bb \rVert_2 \le \cB_{f}$,
and the easier it should be to find these vectors using
the algorithm of Finke and Pohst \cite{FinckePohst}.  The following lemma
is a helpful guide to when Finke and Pohst should be applied.
\begin{lem}\label{lem:lambdaL}
Let $L$ be a sublattice of $\Z^r$. Suppose $\lambda(L)>2 \cB_{f}$,
where $\lambda(L)$ denotes the length of the shortest
non-zero vector in $L$. Then there is at most one vector
$\bb$ in the coset $\ww+L$
satisfying $\lVert \bb \rVert_2 \le \cB_{f}$.
Moreover, any such $\bb$ is equal to $\ww+\cc(L,-\ww)$.
\end{lem}
\begin{proof}
Suppose there are vectors $\bb_1$, $\bb_2 \in \ww+L$
both satisfying $\lVert \bb_i \rVert_2 \le \cB_{f}$.
Then $\bb_1-\bb_2 \in L$ and $\lVert \bb_1-\bb_2 \rVert_2 \le 2 \cB_{f}$.
As $\lambda(L)> 2 \cB_{f}$ we see that $\bb_1=\bb_2$.
The second part follows from Lemma~\ref{lem:closest}.
\end{proof}
We continue
sieving until the lattices $L$ satisfy  $\lambda(L)> 2 \cB_{f}$.
We then apply the Fincke-Pohst algorithm to determine
$\cc(L,-\ww)$ and check whether the vector $\bb= \ww+\cc(L,-\ww)$
leads to a solution.

%-------------------------------------------------------------------------------------------%

\subsection{Sieving using the primes of $S$}
%We continue with the above notation. In particular,
To recap, we seek solutions $(X,Y,\bb)$ to
\[a_0 X- \theta Y=\tau \cdot \delta_1^{b_1} \cdots \delta_r^{b_r},\]
subject to the conditions
\[X,~Y \in \Z, \quad \gcd(X,Y)=1, \quad \gcd(a_0,Y)=1, \quad
b_i \in \Z,\]
and such that
\[\lVert \bb \rVert_2 \le \cB_{f}, \quad \text{ and } \quad  0 \le \; \ord_\fp(a_0 X- \theta Y) \; \le \kappa_\fp \quad \text{for every $\fp \in S$}.\]
%(where
%$\bb=(b_1,\dotsc,b_r)$) to \eqref{eqn:TMdelta}
%satisfying \eqref{eqn:restrictions}, \eqref{eqn:cBf}
%and also satisfying \eqref{eqn:finalvalbd} for every $\fp \in S$,
%where $\kappa_\fp$ is some fixed non-negative integer.
In particular, this last inequality \eqref{eqn:finalvalbd} asserts that
$\ord_\fp(a_0 X-\theta Y)$ belongs to a certain
set of values $0,1,\dotsc,\kappa_\fp$.
The following proposition %Proposition~\ref{prop:siftI}
reduces this list somewhat, and for any $k$
in this reduced list, yields a vector $\ww_k$
and a sublattice $L_k$ of $\Z^r$ such that $\bb \in \ww_k+L_k$ whenever
$\ord_{\fp}(a_0 X- \theta Y)=k$.% then $\bb \in \ww_k+L_k$.
\begin{prop}\label{prop:siftI}
Let $\fp \in S$.
Let $\theta_0 \in \Z$ satisfy $\theta_0 \equiv \theta \pmod{\fp^{\kappa_{\fp}}}$.
Let $\fa$ and $\cT_1$ be as in \eqref{eqn:facT1}.
Define
\[
\eta \; : \; \Z^r \rightarrow \Z, \qquad
\eta(n_1,\dotsc,n_r)=n_1 \ord_\fp(\delta_1)+\cdots+n_r \ord_\fp(\delta_r),
\qquad
L^{\prime\prime}=\Ker(\eta).
\]
Let
\[
\cK^{\prime\prime} \; := \; \left(\ord_\fp(\tau) + \Img(\eta) \right)
\; \cap \; \{ 0 \le k \le \kappa_\fp \; : \; \gcd(\fa^k,\theta-\theta_0) = \gcd(\fa^k,\cT_1) \}.
\]
For $k \in \cK^{\prime\prime}$,
let $\ww^{\prime\prime}_k$
be any vector in $\Z^r$ satisfying
$\eta(\ww^{\prime\prime}_k)=k-\ord_\fp(\tau)$.
If $k \in \cK^{\prime\prime}$ satisfies $k \ge 1$,
we will let $\phi$ and $\tau_0$ be as in Proposition~\ref{prop:valbd}
(these depend on $k$).
Let
\[
\cK^\prime \; := \begin{cases}
\{ k \in \cK^{\prime\prime} \; :\;
\overline{\tau_0} \in \Img(\phi)
\} & \text{if $0 \notin \cK^{\prime\prime}$}\\
\{0\} \cup \{ k \in \cK^{\prime\prime} \; :\; k \ge 1 \; \text{and} \;
\overline{\tau_0} \in \Img(\phi)
\} & \text{if $0 \in \cK^{\prime\prime}$}.\\
\end{cases}
\]
For $k \in \cK^\prime$ with $k \ge 1$,
we let $L^\prime_k=\Ker(\phi)$ and $\ww_k^\prime$ be
any vector in $\Z^r$ satisfying $\phi(\ww_k^\prime)=\overline{\tau_0}$.
Let $\ww_0^\prime=\mathbf{0}$, $L_0^\prime=\Z^r$, and
\[
\cK \; :=
\{ k \in \cK^{\prime} \; :\;
(\ww^{\prime\prime}_k+L^{\prime\prime}) \cap (\ww^\prime_k+L_k^\prime) \ne \emptyset
\}.
\]
For $k \in \cK$, write
\[
L_k \; := \; L^{\prime\prime} \cap L_k^\prime
\]
and choose any $\ww_k \in \Z^r$ such that
\[
\ww_k+L_k \; := \;
(\ww^{\prime\prime}_k+L^{\prime\prime}) \cap (\ww^\prime_k+L_k^\prime).
\]
Let $k=\ord_\fp(a_0 X-\theta Y)$. Then $k \in \cK$
and $\bb \in \ww_k+L_k$.
\end{prop}
\begin{proof}
By \eqref{eqn:finalvalbd}, the valuation $k:=\ord_\fp(a_0 X- \theta Y)$
satisfies
$0 \le k \le \kappa_\fp$. Moreover, by Proposition~\ref{prop:valbd}, part (i),
we have $\gcd(\fa^k,\theta-\theta_0)=\gcd(\fa^k,\cT_1)$. By \eqref{eqn:TMdelta}, we know $k \in \ord_\fp(\tau)+\eta(\bb)$ and thus $k \in \cK^{\prime\prime}$
and $\bb \in \ww_k^{\prime\prime}+L^{\prime\prime}$.
In particular, the proposition follows in the case $k=0$.
We therefore suppose $k \ge 1$. By Proposition~\ref{prop:valbd},
part (ii) and its proof, it follows that $k \in \cK^\prime$ and $\bb \in \ww_k^\prime+L_k^\prime$, completing the proof.
\end{proof}

%\medskip

\noindent \textbf{Remark.} For each prime $\fp \in S$, Proposition~\ref{prop:siftI}
yields a number of cosets $\ww_k+L_k$ and tells us that
$\bb$ belongs to one of them. Note that $L^{\prime\prime}$ is a subgroup of
$\Z^r$ of rank $r-1$. Moreover, the subgroup $L_k^\prime$ has
finite index in $\Z^r$. Therefore the $L_k:=L_k^\prime \cap L^{\prime\prime}$
has rank $r-1$.
From the remarks following Proposition~\ref{prop:valbd} (where
$L_k^\prime$ is called $L$) we expect $L_k^\prime$ to have
index $p^{(d-2)k}$ in $\Z^r$. In particular, the larger the
value of $k$, the larger the index of $L_k^\prime$.
Of course the number of cosets is bounded above by $\kappa_p+1$.

%-------------------------------------------------------------------------------------------%

\subsection{Sieving with other primes}
% Let $\OO_K$ be the ring of integers of $K=\Q(\theta)$.
Given a prime
ideal $\fq$ of $\OO_K$, write $\OO_\fq$ for the localization
of $\OO_K$ at $\fq$,
\[
\OO_\fq=\{ \alpha \in K \; : \; \ord_\fq(\alpha) \ge 0\}.
\]
Now let $q$ be a rational prime. Define
\[
\OO_q=\bigcap_{\fq \mid q} \OO_\fq=\{ \alpha \in K \; : \;
\text{$\ord_\fq(\alpha) \ge 0$ for all $\fq \mid q$}\}.
\]
The group of invertible elements $\OO_q^\times$
consists of all $\alpha \in K$
such that $\ord_\fq(\alpha)= 0$ for all
prime ideals $\fq \mid q$.

Let $\tau$, $\delta_1,\dotsc,\delta_r$ be as in \eqref{eqn:TMdelta}.
Let $q$ be a rational prime coprime to the supports
of $\tau$, $\delta_1,\dotsc,\delta_r$.
Thus $\tau$, $\delta_1,\dotsc,\delta_r$ all belong
to $\OO_q^\times$.
Let
\[
\fA_q:=(\OO_q /q\OO_q)^\times.
\]
This is canonically isomorphic to $(\OO_K/ q\OO_K)^\times$.
Let
\[
\mu : \F_q^\times \hookrightarrow \fA_q, \qquad \alpha+q\Z \mapsto \alpha+q\OO_q
\]
be the natural map, and let
\[
\fB_q:=\fA_q/\mu(\F_q^\times)
\]
be the cokernel of $\mu$.
We denote the induced homomorphism $\OO_q^\times \rightarrow \fB_q$ by
\[
\pi_q \; : \; \OO_q^\times \rightarrow \fB_q,
\qquad \beta \mapsto (\beta+q \OO_q) \cdot \mu(\F_q^\times).
\]

Define
\[
\phi_q \; : \; \Z^r  \rightarrow \fB_q,
\qquad
(m_1,\dotsc,m_r) \mapsto \pi_q(\delta_1)^{m_1} \cdots \pi_q(\delta_r)^{m_r}.
\]

\begin{prop}\label{prop:siftII}
%Let $L_q \subset \Z^r$ be the kernel of $\phi_q$.
Let
\[
R_q=\{a_0 u-\theta  : u \in \{0,1,\dotsc,q-1\}\} \cup \{ a_0\}
\]
and
\[
S_q=\{\pi_q(r)/\pi_q(\tau) \; : \; r \in R_q \cap \OO_q^\times\}
\subseteq \fB_q.
\]
Let
\[
T_q=S_q \cap \phi_q(\Z^r)
\]
and $L_q=\Ker(\phi_q)$. Finally, let $W_q \subset \Z^r$ be a set
of size $\# T_q$ such that for every $t \in T_q$
there is some $\ww \in W_q$ with $\phi_q(\ww)=t$.
Then $\bb \in W_q+L_q$.
%Then $\phi_q(\bb) \in T_q$.
%Let $\sS$ be the set of
% solutions $\bb=(b_1,\dotsc,b_r) \in \Z^r$ to \eqref{eqn:TMdelta}
%satisfying \eqref{eqn:restrictions}.
%Then $\phi_q(\sS) \subseteq T_q$.
\end{prop}
\begin{proof}
%Let $\bb \in \sS$ and let $(X,Y)$ be the corresponding
%rational integers such that \eqref{eqn:TMdelta},
%\eqref{eqn:restrictions} are satisfied.
Since $\tau$, $\delta_1,\dotsc,\delta_r \in \OO_q^\times$,
we have $a_0 X-\theta Y \in \OO_q^\times$.
We want to determine the possibilities for
the image of the algebraic integer $a_0 X- \theta Y$ in
$\fB_q$.
Since $X$ and $Y$ are coprime, $q$ divides at most one of $X$, $Y$.
If $q \nmid Y$ then
\[
a_0X- \theta Y \equiv v \cdot (a_0 u -\theta) \pmod{q \OO_q}
\]
for some $u \in \{0,1,\dotsc,q-1\}$ and some $v \in \F_q^\times$.
If $q \mid Y$ then $q \nmid X$ and
\[a_0 X-\theta Y \equiv a_0 v \pmod{q \OO_q}\]
for some $v \in \F_q^\times$. We conclude that
$a_0 X-\theta Y \equiv v \cdot r \pmod{q \OO_q}$
where $v \in \F_q^\times$ and $r \in R_q$. Moreover,
since $a_0X-\theta Y\in \OO_q^\times$ we see
that $r \in R_q \cap \OO_q^\times$. Now
\[
\pi_q(a_0 X - \theta Y)=\pi_q(r) \pi_q(v)=\pi_q(r).
\]
It follows that $\pi_q(a_0 X- \theta Y)/\pi_q(\tau) \in S_q$.
However
\[
\phi_q(\bb)=\pi_q(\delta_1)^{b_1} \cdot \cdots \cdot
\pi_q(\delta_r)^{b_r}=\pi_q(a_0 X-\theta Y)/\pi_q(\tau),
\]
where the first equality follows from the definition of $\phi_q$
and the second from \eqref{eqn:TMdelta}.
Thus $\phi_q(\bb)=t$ for some $t \in T_q$.
By definition of $W_q$, there is some $\ww \in W_q$
with $\phi_q(\ww)=t=\phi_q(\bb)$, thus $\bb-\ww \in L_q$.
\end{proof}

%\bigskip

\noindent \textbf{Heuristic.}
It is appropriate that we heuristically \lq measure\rq\ the quality of
information that Proposition~\ref{prop:siftII} gives us about the solutions.
A priori, $\phi_q(\bb)$ could be any element in $\phi_q(\Z^r) \subseteq \fB_q$.
However, the lemma tells us that $\phi_q(\bb)$ belongs to
$T_q$. We want to estimate the ratio
$\# T_q/\#\phi_q(\Z^r)$; the smaller this ratio is, the better
the information is. It is convenient to
suppose that $q$ is unramified in $\OO_K$. Thus
\[
\OO_q/q\OO_q \cong \OO_K/q \OO_K \cong \bigoplus_{\fq \mid q} \OO_K/\fq.
\]
Each summand $\OO_K/\fq$ is a finite field of cardinality $\Norm(\fq)$.
By definition
\[
\fA_q:=(\OO_q/q\OO_q)^\times \cong \prod_{\fq \mid q} (\OO_K/\fq)^\times.
\]
Thus
\[
\# \fA_q=\prod_{\fq \mid q} (\Norm(\fq)-1),
\qquad
\# \fB_q=\frac{1}{q-1}\cdot \prod_{\fq \mid q} (\Norm(\fq)-1).
\]
%It is important to note, for later reference, that $\#\fB_q$ can be a smooth number
%(i.e.\ divisible only by small primes)
%if $q$ is chosen appropriately.
Moreover
$\prod_{\fq \mid q} \Norm(\fq)=q^d$ where $d=[K:\Q]$
is the degree of the original Thue--Mahler equation.
Thus $\# \fB_q \approx q^{d-1}$. However
$S_q \subseteq \phi(\Z^r) \subseteq \fB_q$ has
at most $q+1$ elements,
and so $\# S_q/\#\fB_q \lessapprox 1/q^{d-2}$. Now
\[
\frac{\#T_q}{\#\phi_q(\Z^r)}=\frac{\# S_q \cap \phi_q(\Z^r)}{
\# \phi_q(\Z^r)}.
\]
It is reasonable to expect that the elements of $S_q$
are uniformly distributed among the elements of $\fB_q$ and so we expect $\#T_q/\#\phi_q(\Z^r) \lessapprox 1/q^{d-2}$.

\begin{comment}
We use Proposition~\ref{prop:valbd} to produce a bound
for $\ord_\fp(a_0 X- \theta Y)$ that is much sharper than
the one we obtain initially from Yu's bounds linear forms in
$p$-adic logarithms. We can improve on this by eliminating
so the possible values of $k$ using Proposition~\ref{prop:valneq}.
Namely to that $\ord_\fp(a_0 X-\theta Y) \ne k$
it is enough for any of
conditions (i), (ii), (iii), (iv) to fail.
Otherwise $(\ww+L) \cap (\vv+H)$ is some coset of $L \cap H$,
say $\zz+L\cap H$ for
some $\zz \in \Z^r$. Now we check whether $D(L\cap H,\zz) > \cB_1$.
If that holds, then we know (by \eqref{eqn:cB1}) that
$\ord_\fp(a_0 X- \theta Y) \ne k$.

The map $\eta$ has non-trivial image. One way of seeing this
is to note that $\fp^h=\alpha \cdot \OO_K$ for some $\alpha \in \OO_K$
where $h$ is the class number. Clearly $\alpha \in \OO_S^\times$.
As $\delta_1,\dotsc,\delta_r$ is a basis for $\OO_S^\times$
modulo the torsion subgroup, we can write
$\alpha=\zeta \cdot \delta_1^{n_1} \cdots \delta_r^{n_r}$
where $\zeta$ is a root of unity, and $n_i \in \Z$.
Thus $\eta(n_1,\dotsc,n_r)=h$ and so $h \Z \subseteq \Img(\eta)$.
This means that $H$ has rank $r-1$. It may be that
$D(L,\ww) \le \cB_1$ but $D(L\cap H,\zz)>\cB_1$.

We write $\bb=(b_1,\dotsc,b_r) \in \Z^r$. Linear forms in logarithms
plus LLL
give us a bound $\lVert \bb \rVert \le \cB$, but the sieve of
 to enumerate all the possible $\bb$
can be far too slow. Here we shall see a much faster sieve,
that is the Dirichlet group analogue of the Mordell--Weil
sieve explained in \cite{IntegralHyp}. Let $\sS$ be the
set of all possible $\bb \in \Z^r$ satisfying
\eqref{eqn:TMdelta} subject to \eqref{eqn:restrictions}.
The objective of this Dirichlet sieve
is compute a lattice $L \subseteq \Z^r$, which will have rank $r$
but hopefully huge index in $\Z^r$, and a finite
but hopefully small set $W \subseteq \Z^r$ of vectors such that
\begin{equation}\label{eqn:cMWL}
\sS \subseteq W+L.
\end{equation}
If the index of $L$ is huge then there will be very few
vectors in the set $W+L$ whose length is shorter than $\cB$
and it should be easy to enumerate them.

\begin{lem}\label{lem:2B}
Suppose \eqref{eqn:cMWL} is satisfied. Suppose $\lVert \bb \rVert \le \cB$
for all $\bb \in \sS$.
Let $\lambda_1(L)$ be the first minima of $L$, and suppose
$\lambda_1(L)\ge 2\cB$.
Then
\[
\sS \subseteq \{\ww+\cc(L,-\ww) \; : \; \ww \in W \quad
\text{and} \quad \lVert \ww+\cc(L,-\ww) \rVert \le \cB\}.
\]
\end{lem}
\begin{proof}
Let $\mm \in \cM$. By \eqref{eqn:cMWL}, there is some $\ww \in W$
such that $\mm \in \ww+L$. Let $\uu=\ww+\cc(L,-\ww)$.
As $\cc(L,-\ww) \in L$, we have $\uu+L=\ww+L$.
By Lemma~\ref{lem:closest}, $\uu$ is the shortest
vector belonging to the coset $\ww+L$. But $\mm$
belongs to the same coset and satisfies $\lVert \mm \rVert<B$.
Thus $\lVert \uu \rVert<B$.  Moreover, $\mm=\uu+\bfl$
for some $\bfl \in L$. However,
\[
\lVert \bfl \rVert=\lVert \mm-\uu \rVert \le \lVert \mm \rVert+
\lVert \uu\rVert <2B.
\]
As $\lambda_1(L)>2B$ we see that $\bfl=0$ and so
$\mm=\uu$. This completes the proof.
\end{proof}
Thus to determine the set of solutions $\cM$
all we have to do is to find a suitable $W$
and $L$ so that $\lambda_1(L)>2B$.
Heuristically we expect $\lambda_1(L)$ to be roughly
$[\Z^r : L]^{1/r}$, so we want the index
$[\Z^r : L]$ to be large compared to $(2B)^r$.
\end{comment}

%-------------------------------------------------------------------------------------------%

\subsection{The sieve}
We will sieve with the primes $\fp \in S$ as in Proposition~\ref{prop:siftI}
and also with additional rational primes $q$ as
in Proposition~\ref{prop:siftII}. We would like to choose
a suitable set $\sS$ of such primes $q$.
%We choose $S^\prime$ a list of primes $q$ whose support in $K$
%is disjoint from that of $\tau$ and $\delta_1,\dotsc,\delta_r$.
The most expensive computation we will need to do for $q \in \sS$
is to
compute, for each $t \in T_q$, some $\ww \in \Z^r$
such that $\phi_q(\ww)=t$. This involves
a discrete logarithm computation in the group
$\mathfrak{B}_q$, and to do this quickly
we need $\mathfrak{B}_q$ to be a product
of cyclic factors that have relatively small order.
We therefore like to avoid those $q$ where there are $\fq \mid q$
that have large norm.  In all our examples we found it enough to
take $\sS$ to be the set of primes $q \le 500$, where
each $\fq \mid p$ satisfies $\norm(\fq) \le 10^{10}$ and where
the support of $q$ is disjoint from the supports of
$\tau$, $\delta_1,\dotsc,\delta_r$.

\begin{proc}\label{proc}
$\texttt{Solutions}(L_c,\ww_c,S_c,\sS_c)$.\\[2ex]
\textbf{Input:} $L_c$ sublattice of $\Z^r$, $\ww_c \in \Z^r$, $S_c \subseteq S$,
$\sS_c\subseteq \sS$.\\[2ex]
\textbf{Output:} Set of solutions $(X,Y,\bb)$ to \eqref{eqn:TMdelta},
\eqref{eqn:restrictions} satisfying $\bb \in \ww_c+L_c$
and $\lVert \bb \rVert_2 \le \cB_{f}$.\\[2ex]
\begin{tabbing}
1. \textbf{IF} \= $\lambda(L_c)>2\cB_{f}$ or ($S_c=\emptyset$ and $\sS_c=\emptyset$) \textbf{THEN}\\
2. \> Apply Fincke--Pohst to find all vectors in $\bb \in \ww_c+L$
satisfying $\lVert \bb \rVert_2 \le \cB_{f}$. \\
3. \> Keep only those $\bb$ that lead to
solutions $(X,Y)$ on \eqref{eqn:TMdelta}, \eqref{eqn:restrictions}.\\
4. \> \textbf{RETURN:} Set  of $(X,Y,\bb)$.\\
5. \> \textbf{END}.\\
6. \textbf{ELSE}\\
7. \> \textbf{IF} \= $S_c \ne \emptyset$ \textbf{THEN}\\
8. \>\> Choose $\fp \in S_c$. Let $S_c^\prime=S_c \setminus \{\fp\}$.\\
9. \>\> Compute $\cK$ be as in Proposition~\ref{prop:siftI}.\\
10. \>\> For each $k \in \cK$ compute $\ww_k$, $L_k$ as in Proposition~\ref{prop:siftI}.\\
11. \>\>Let $\cK^*$ be the subset of $k\in \cK$ such that $(\ww_k+L_k)\cap (\ww_c+L_c) \ne \emptyset$.\\
12. \>\>For each $k \in \cK^*$ let $L_{c,k}=L_c \cap L_k$.\\
13. \>\> For each $k \in \cK^*$ choose
$\ww_{c,k}\in \Z^r$ so that $\ww_{c,k}+L_{c,k}=(\ww_k+L_k)\cap (\ww_c+L_c)$.\\
14. \>\> \textbf{RETURN:} $\displaystyle \bigcup_{k \in \cK^*} \mathtt{Solutions}(L_{c,k},\ww_{c,k},S_c^\prime,\sS_c)$.\\
15. \>\> \textbf{END}.\\
16. \>\textbf{ELSE}\\
17. \>\> Choose $q \in \sS_c$. Let $\sS_c^\prime=\sS_c \setminus \{q\}$.\\
18. \>\> Compute $W_q$, $L_q$ as in Proposition~\ref{prop:siftII}.\\
19. \>\> Let $L_c^\prime=L_c \cap L_q$.\\
20. \>\> Let $W_q^*=\{\ww_1,\dotsc,\ww_m\}$ be the subset of $\ww \in W_q$ such that
$(\ww+L_q) \cap (\ww_c+L_c) \ne \emptyset$. \\
21. \>\> For $i=1,\dotsc,m$ choose $\ww_{c,i}$ such that
$\ww_{c,i}+L_c^\prime=(\ww+L_q) \cap (\ww_c+L_c)$.\\
22. \>\> \textbf{RETURN:} $\displaystyle \bigcup_{i=1}^m \mathtt{Solutions}(L_{c}^\prime,\ww_{c,i},\emptyset,\sS_c^\prime)$.\\
23. \>\> \textbf{END}.\\
24. \>\textbf{ENDIF}\\
25. \textbf{ENDIF}
\end{tabbing}
\end{proc}
Let us explain how Procedure~\ref{proc} works.
The procedure starts with a coset $\ww_c+L_c$
and sets $S_c \subseteq S$ and $\sS_c \subseteq \sS$
(the subscript $c$ stands for \lq cumulative\rq).
The objective is to return all solutions $(X,Y,\bb)$ to
\eqref{eqn:TMdelta}, \eqref{eqn:restrictions}
with $\bb \in \ww_c+L_c$ and
satisfying $\lVert \bb\rVert_2 \le \cB_f$. The primes in $S_c$ and $\sS_c$
are used, via Propositions~\ref{prop:siftI} and~\ref{prop:siftII},
to replace $\ww_c+L_c$ by a union of cosets of sublattices of $L_c$.

We now explain lines 1--5 of the procedure.
If $\lambda(L)>2 \cB_f$, then by Lemma~\ref{lem:lambdaL}, the coset
$\ww_c+L_c$ has at most one vector $\bb$ that satisfies
$\lVert \bb \rVert_2 \le \cB_f$, and this maybe found by
the algorithm of Fincke and Pohst. If $S_c=\emptyset$ and $\sS_c=\emptyset$,
then we have run out of sieving primes and we simply apply
the Fincke-Pohst algorithm to determine all $\bb \in \ww_c+L_c$
such that $\lVert \bb \rVert_2 \le \cB_f$.
We test
all resulting $\bb$ to see if they lead to solutions
$(X,Y,\bb)$ and return the set of solutions. We end here.
In both these cases,
no further branching of the procedure occurs.

If we have reached line 6, then either $S_c$ is non-empty
or $\sS_c$ is non-empty. We first treat the case where
$S_c$ is non-empty (lines 8--14). We choose for $\fp \in S_c \subseteq S$
to sieve with and let $S_c^\prime=S_c \setminus \{\fp\}$.
Here we apply Proposition~\ref{prop:siftI}.
This gives a finite set $\cK$ of values $k$ and lattice
cosets $\ww_k+L_k$ such that $\bb \in \ww_k+L_k$ for some $k \in \cK$.
However, the $\bb$ we are interested in belong to $\ww_c+L_c$.
We let $\cK^*$ be those values $k \in \cK$ such that
$(\ww_c+L_c) \cap (\ww_k+L_k) \ne \emptyset$. It is now clear
that every $\bb$ we seek belongs to
$(\ww_c+L_c) \cap (\ww_k+L_k)$ for some $k \in \cK^*$.
However $(\ww_c+L_c) \cap (\ww_k+L_k)=\ww_{c,k}+L_{c,k}$
where $L_{c,k}=L_c \cap L_k$, for a suitable coset
representative $\ww_{c,k}$. We apply the procedure
to the set $(L_{c,k},\ww_{c,k},S_c^\prime,\sS_c)$
for each $k \in \cK^*$ to compute those $\bb$ belonging
to $\ww_{c,k}+L_{c,k}$ and return the union.

If however $S_c=\emptyset$, then (lines 17--22) we
choose a prime $q \in \sS_c \subseteq \sS$ to sieve with,
and we let $\sS_c^\prime=\sS_c \setminus \{q\}$.
Now we apply Proposition~\ref{prop:siftII}.
This gives a lattice $L_q$ and a finite set $W_q$
such that $\bb \in W_q+L_q$. Therefore there is some
$\ww \in W_q$ such that $\bb \in (\ww+L_q) \cap (\ww_c+L_c)$.
We let $W_q^*$ be the subset of those $\ww \in W_q$
such that $(\ww+L_q) \cap (\ww_c+L_c) \ne \emptyset$,
and write $W_q^*=\{\ww_1,\dotsc,\ww_m\}$.
Now $\bb \in (\ww_i+L_q) \cap (\ww_c+L_c)$ for some
$i=1,\dots,m$. Write $L_{c}^\prime=L_c \cap L_q$.
Then $(\ww_i+L_q) \cap (\ww_c+L_c)$ is a coset of $L_c^\prime$
for $i=1,\dotsc,m$, and we choose $\ww_{c,i}$
so that $\ww_{c,i}+L_c^\prime=(\ww_i+L_q) \cap (\ww_c+L_c)$.
It is therefore enough to find the $\bb$
belonging to each one of these $\ww_{c,i}+L_c^\prime$.
Thus we apply the procedure to $(L_c^\prime,\ww_{c,i},\emptyset,\sS_q^\prime)$
for $i=1,\dotsc,m$, collect the solutions and return their union (line 22).

\medskip

\noindent \textbf{Remarks.}
\begin{itemize}
\item To compute the solutions to \eqref{eqn:TMdelta}
satisfying \eqref{eqn:restrictions}, it is clearly enough
to apply the above procedure to $(\Z^r,\textbf{0},S,\sS)$.
\item Recall that $\delta_1,\dots,\delta_r$ is a basis
for the $S$-units (modulo torsion); in particular this allows us to identify the $S$-units (modulo torsion) with $\Z^r$.
Let $\fp \in S$ and $\eta$ be as in
Proposition~\ref{prop:siftI}. Note that $L_k$ is a subgroup
of finite index in $\Ker(\eta)$. Now $\Ker(\eta)$
itself corresponds to the $(S\setminus\{\fp\})$-units, and therefore
has rank $r-1$. Therefore $L_k$ has rank $r-1$.
That is, if we apply the procedure to
$(\Z^r,\textbf{0},S,\sS)$, then at depth $\#S+1$ (when the set $S$
has been entirely depleted),
the lattice $L_c$ will have rank $r-\#S$ which is the unit rank.
Beyond this depth, the rank remains constant but the determinant
of the lattice grows.
\item The reader will note that we have not specified how to choose
the next prime $\fp \in S$ or $q \in \sS$. In our implementation
we order the primes in $\fp \in S$ by the size of their norms; from
largest to smallest. The reason is that the primes $\fp \in S$
of large norm lead to lattices of large determinants and we
therefore expect few short vectors. Once $S$ is exhausted,
the choices we make for the next $q \in \sS$  actually depend
on the cumulative lattice $L_c$. We choose the prime $q \in \sS_c$
that minimizes $\# W_q / [L_c : L_c \cap L_q]$. Our justification
for this is that we are replacing one coset of $L_c$ with a union
of cosets of $L_c \cap L_q$. The number of such cosets is bounded
by $\#W_q$. The function $q \mapsto \# W_q / [L_c : L_c \cap L_q]$
estimates the \lq relative change in density\rq\ between the old
lattice and the new union for that particular choice of $q$.
\end{itemize}

%-------------------------------------------------------------------------------------------%

\subsection*{Example 5 continued}
Recall that $\cB_f^\prime=180$. Following the remark in Section~\ref{sec:LFRL}, we find that $\cB_f \approx 402.67$. %approx 831.679.
Consider the information given by Proposition~\ref{prop:siftI}.
Recall there are five possibilities for $\fp \in S$, ordered as $\fp_1,\dotsc,\fp_{5}$,
in order of decreasing norm. Table~\ref{table:bounds}
yields $2$, $3$, $5$, $6$, $9$ for $\kappa_{\fp_j}$ with $j = 1, \dots, 5$, respectively.

\begin{table}[h]
{\renewcommand{\arraystretch}{1.1} %<- modify value to suit your needs
\begin{tabular}{|c|l|l|}
\hline
$\fp$ & $\cK$ & $\det(L_k)$ with $k \in \cK$ \\
\hline\hline
$\fp_1$ & $\{0,1\}$ &
$1$, $6616761038619033600$ \\
\hline
$\fp_2$ & $\{0,1,2,3\}$ &
$1$, $2114272224838656$, $3442909640611645594437761516544$,\\
& & $5606480875148980721912830543593855583743968256$\\
\hline
$\fp_3$ & $\{0,1,2,3,4,5\}$ &
$1$, $1$, $3800066789376$, $14496104390625000000000000$,\\
& & $55298249781131744384765625000000000000$,\\
& &  $210946082233931520022451877593994140625000000000000$\\
\hline
$\fp_4$ & $\{0, 1, 2, 3, 6\}$ &
$1$, $504631296$, $21722722606780416$, \\
& &  $935091979414469275815936$, \\
& & $54375352676603537816702220559499682956095667933184$
\\
\hline
$\fp_5$ & $\{0, 1, 5\}$ &
$1$, $57600$, $1062532458645670173081600$
\\
\hline \hline
\end{tabular}}
\vspace{0.5em}
\caption{This table gives the sets $\cK$ and the
determinants of the sublattices $L_k \subset \Z^{10}$ with $k \in \cK$
as in Proposition~\ref{prop:siftI}. Observe that the
sublattices $L_k$ all have rank $r-1=9$.}
\end{table}

We take $\sS$ to be the set of rational primes $q<200$ coprime to the prime ideals in $S$ and such that every prime ideal factor of $q\OO_K$ has norm $\le 10^{10}$. This is done in order to keep our computations fast, as previously explained. However, of this set, our program only needs to use the primes $23$ and $71$, selected in that order using the heuristic detailed in the above remarks. For $q = 23$ and $q = 71$, Proposition~\ref{prop:siftII} gives a lattice $L_{q} \subset \Z^{10}$ (now
of rank $10$) and
a set $W_{q}$ such that $\bb \in W_{q}+L_{q}$. We find that
\[
[\Z^{10}: L_{71}]=3253933989048960000 \approx 3.26 \times 10^{18}
\quad \text{ with } \quad
\# W_{71}=71,
\]
and
% \[
% [\Z^{10}:L_{1753}]=273574387411035393424034142093312 \approx 2.74 \times 10^{32},
% \qquad
% \# W_{1753}=1750,
% \]
% and
\[
[\Z^{10}: L_{23}]=41191874887680 \approx 4.12 \times 10^{13}
\quad \text{ with } \quad
\# W_{23}=23.
\]
Observe that in Procedure~\ref{proc} branching occurs
at lines 14, 20. Thus we obtain \lq paths\rq\ through the
algorithm depending on the choice of $k \in \cK^*$
(line 14) or the choice of $\ww_i \in W_q^*$
(line 20). A path \lq dies\rq\ if the criterion of
line 1 is satisfied, or if $\cK^*$ (defined in line 11)
is empty, or if $W_q^*$ (defined in line 20) is
empty. Our program needs to check a total of $98$ paths.
Five of these terminate at line 1 with the condition
$\lambda(L_c)>2 \cB_f$ being satisfied, and the remaining $93$ paths terminate at line 11 with $\cK^*=\emptyset$.
%and the remaining 97 paths terminated at line 20
%with $W_q^*=\emptyset$.
Of the $5$ paths that terminate
at line 1, three of these yield a vector $\bb \in W_c+L_c$
satisfying $\lVert \bb \rVert_2 \le \cB_f$. These three vectors
are
\begin{gather*}
(-1, -1, -2, 0, 2, 0, 3, 0, 1, 1), \quad (0, 0, -1, 1, 1, 1, 1, 1, 0, 0),\\
\text{ and } \quad (-1, -1, -2, 3, 2, 5, 0, 0, 0, 0).
\end{gather*}
These vectors respectively lead to the solutions
\[
F(1,2)=3^3 \cdot 7 \cdot 11,\qquad
F(1,-1)=2 \cdot 3 \cdot 5, \qquad
F(1,1)=2^5.
\]

\begin{comment}
\begin{lem}\label{lem:sieveonestep}
Let $L$ is a lattice of finite index in $\Z^r$
and $W$ is a finite subset of $\Z^r$ such that
$\sS \subseteq W+L$. Let $q$ be a rational
prime that is coprime to the supports
of $\tau$, $\delta_1,\dotsc,\delta_r$.
Let $L^\prime$ be the kernel of the restriction
$\phi_q \vert_L$ of $\phi_q : \Z^r \rightarrow \fB_q$
to $L$. Let $\bfl_1,\dotsc,\bfl_k$ be a system
of coset representatives for $L/L^\prime$.
Let
\[
W^\prime=\{\ww+\bfl \; : \; \ww \in W, \quad \bfl \in \{\bfl_1,\dotsc,\bfl_k\},
\quad \text{such that} \quad \phi_q(\ww+\bfl) \in T_q\}.
\]
Then
\[
\sS \subseteq W^\prime+L^\prime.
\]
\end{lem}
\begin{proof}
Note that $\phi_q \vert_L \; : \; L \rightarrow \fB_q$
is a homomorphism into a finite group $\fB_q$.
Thus the kernel $L^\prime$ has finite index in $L$.
Let $\bb \in \sS$. We want to show that
$\bb \in W^\prime+L^\prime$. By hypothesis,
$\bb \in W+L$. Thus there is some $\ww \in W$
such that $\bb \in \ww +L$.
As $\bfl_1,\dotsc,\bfl_k$ are coset representatives
for $L/L^\prime$, there is some $\bfl \in \{\bfl_1,\dotsc,\bfl_k\}$
such that $\bb \in \ww+\bfl+L^\prime$. Now $L^\prime$ is
contained in the kernel of $\phi_q$. Thus
$\phi_q(\ww+\bfl)=\phi_q(\bb)$.
By Lemma~\ref{lem:Lq},
we know that $\phi_q(\bb) \in T_q$,
and so $\phi_q(\ww+\bfl) \in T_q$.
Hence $\ww+\bfl \in W^\prime$. Thus
$\bb \in W^\prime+L^\prime$.
\end{proof}

To perform the sieve we start with a set of rational primes
$\fQ=\{q_1,q_2,q_3,\dotsc,q_n\}$. We let
$L_0=\Z^r$ and $W_0=\{0\}$.
Certainly $\sS \subseteq W_0+L_0$.
We now apply Lemma~\ref{lem:sieveonestep}
repeatedly. At the first step we take $q=q_1$,
$W=W_0$, $L=L_0$ and then let $W_1=W^\prime$, $L_1=L^\prime$.
Applying repeatedly we obtain a decreasing sequence
\[
\Z^r=L_0 \supseteq L_1 \supseteq L_2 \supseteq L_3 \supseteq \cdots
\]
of sublattices of $\Z^r$ of full rank, and finite sets
$W_0, W_1, W_2,\dotsc$ such that $\sS=W_i+L_i$.
If any of the $W_i=\emptyset$ then
we have proved that \eqref{eqn:TMdelta}
has no solutions satisfying \eqref{eqn:restrictions},
and we can stop. If there are solutions then
of course the $W_i$ will never be empty. But if $W_i$ is small and the index of $L_i$ is large
then it does tell us a lot about the solutions.

\bigskip

\noindent \textbf{Heuristics and Implementation.}
The key
to successfully applying the sieve is to choose
and order the set of primes $\fQ$ so
as to avoid a computationally expensive
explosion in the sizes of the $W_i$.
In my implementation I took $\fQ$
to be the set of rational primes $q<1500$
(with support disjoint $\tau$, $\delta_j$) such that
$\#\fB_{q}$ is divisible only by primes $<40$.
I ordered $\fQ$ so that $P(\#\fB_{q_i})$
is increasing (where $P(n)$ is the largest prime dividing $n$).
One should think of the sieve as a multi-dimensional
Chinese Remainder Theorem for the solutions.
In the Chinese Remainder Theorem, if the moduli
are coprime then we can always lift, but if the moduli
have lots of common prime factors then most
of the time we expect not to be able to lift.
In this setting the moduli are $\#\fB_{q_i}$. Choosing
these to be smooth ensures that most congruence classes
do not lift and keeps the sets $W_i$ under control.
\end{comment}

\begin{comment}
Recall our previous heuristic that we expect $\# T_{q}/\#\phi_q(\Z^r)$ to be roughly at most $1/q^{n-2}$.
Another way of seeing the above is that at each step we're trying to keep $\# (L/L^\prime)$ small. Most
of the time we want $\#(L/L^\prime) \ll q^{n-2}$. If this is satisfied then the number combinations
$\ww+\bfl$ with $\ww \in W$ and $\bfl$ a coset representative for $L/K^\prime$ is
\[
\#W \times \#(L/L^\prime) \ll \#W \times q^{n-2}.
\]
Now $\ww+\bfl$ is added to $W^\prime$ if and only if $\phi_q(\ww+\bfl) \in T_q$.
So we expect
\[
\# W^\prime \ll \#W \times q^{n-2} \times \frac{1}{q^{n-2}}=\# W.
\]
Thus we can keep the $W_i$ under control provided the $[L_i:L_{i-1}]$
stay smallish. This another way of seeing the utility of the smoothness of the moduli.
\end{comment}

\begin{comment}
The cosets $W_i+L_i$ encode
congruence information for the solutions $\bb$
modulo $\# \fB_{q_i}$.
The correct approach from long experience
with sieving in other contexts seems to be
to choose the $q_i$ so that the orders
$\# \fB_{q_i}$ are smooth. Going from $W_{i-1}+L_{i-1}$
to $W_i+L_i$ is in effect Chinese remaindering
the congruence information obtained
modulo $\# \fB_{q_i}$ with the information
modulo $\# \fB_{q_{j}}$ for $j<i$.
In the Chinese Remainder Theorem, we are always
guaranteed to be able to lift congruences if the
moduli are coprime, but expect
\end{comment}

\begin{comment}
\section{An Example}

Adela sent me this example.
\begin{equation}%\label{eqn:TMBad}
F(X,Y):=3X^3+ 2X^2 Y +7X Y^2 +2Y^3=2^{z_1} \cdot 3^{z_2} \cdot  7^{z_3}\cdot 41^{z_4}.
\end{equation}
With the Fincke and Pohst
this maxed the memory after two weeks.

The Thue--Mahler equation reduces to
$54$ equations of the form \eqref{eqn:TMdelta}.
Here is the last one of them:
\begin{equation}\label{eqn:last}
3 X-Y \theta= \tau \cdot \delta_1^{m_1} \delta_2^{m_2}
\delta_3^{m_3} \delta_4^{m_4}
\end{equation}
where
\[
\tau=-16\theta^2 + 39\theta + 48,
\quad
\delta_1=(-6274\theta^2 - 45794\theta - 36117)/3,
\quad
\delta_2=-896\theta^2 - 986\theta - 17929,
\]
\[
\delta_3=(-1294\theta^2 - 1424\theta - 25893)/3,
\quad
\delta_4=-10\theta^2 - 11\theta - 200.
\]
The sieve gives
\begin{gather*}
W=\{
    (149602080797769600,\; 1944827050371004799,\; 17353841372541273599,\;
        8947850054595397545604),\\
    (-1122015605983272000,\; -6806894676298516801,\; 4039256181539779202,\;
        -6093367551933554692801),\\
    (-224403121196654401,\; 12641375827411531200,\; 220962273338305699201,\;
        40500200512531787227204),\\
    (-74801040398884800,\; 26853573503199643199,\; 432649217667149683202,\;
        25726247023348050379199),\\
    (448806242393308801,\; 36951713957049091199,\; 546047594911859039999,\;
        38369193672607958160000),\\
    (-598408323191078399,\; 23337924604452057599,\; 424570705304070124799,\;
        7774520934898490572799),\\
    (-74801040398884800,\; 30144819280750574399,\; 485309150107964582399,\;
        54198814244941156190404)
\},
\end{gather*}
and a lattice $L$ which has $\Z$-basis
\begin{gather*}
(1346418727179926400,\; -1944827050371004800,\; 2543235373562083200,\;
    1047214565584387200)\\
(523607282792193600,\; -2917240575556507200,\; -5385674908719705600,\;
    3216444737152046400)\\
(8153313403478443200,\; 2917240575556507200,\; -3291245777550931200,\; 74801040398884800)\\
(3141643696753161600,\; 7779308201484019200,\; 2692837454359852800,\;
    5684879070315244800)
\end{gather*}
and index
\[
[\Z^4:L]=2^{28} \cdot 3^{13} \cdot 5^9 \cdot 7^8 \cdot 11^6 \cdot 13^7 \cdot 17^4 \cdot 19^4 \cdot 23^4 \cdot 29^4
\cdot 31^4 \cdot 37^4 \approx 1.997 \times 10^{75}.
\]
The first minima of $L$ is $\lambda_1(L) \approx 3.62 \times 10^{18}$.
I haven't implemented the linear forms in logarithms or the LLL
step, but let's be crazy and suppose we get after LLL
we have $B<1.5 \times 10^{18}$ (where $B$ is the bound
for $\lVert (m_1,\dotsc,m_4)\rVert$).
Lemma~\ref{lem:2B} then gives
\[
\sS \subseteq
\{
   ( 0, -1,  2, -1),\;
    (-1,  0,  1,  4),\;
    ( 1, -1, -1,  0),\;
    ( 1, -1, -1, -1),\;
    ( 0, -1, -1,  4)
\}.
\]
In fact each element of the set on the right does give
a solution to \eqref{eqn:last}.
If $B$ is bigger then we can simply use more primes in the sieve.
But I expect after LLL that $B$ should be in the region of $10^4$,
so the sieve could have been stopped much earlier.

I ran the Dirichlet sieve on all $54$ equations \eqref{eqn:TMdelta}
that we obtain from \eqref{eqn:TMBad}. It took
a total of seven minutes and 32Mb memory
to do all of them.
For $25$ of these equations the sieve quickly
finds $W_i=\emptyset$ and eliminates that possibility.
For the other $29$ equations, the sieve produces
a lattice $L$ of huge index and a set $W$
such that the solutions are contained in $W+L$.
I assumed $B<10^{15}$ in all cases, and obtained the following list of
solutions for \eqref{eqn:TMBad} (given as $[X,Y,z_1,z_2,z_3,z_4]$):

This list of $20$ soluntions agrees with the list I found by searching for solutions $\lvert X\rvert$, $\lvert Y \rvert \le 1000$
(after I remembered to put in the restrictions $\gcd(X,Y)=\gcd(a_0,Y)=1$!). So it seems that I've programmed
the sieve correctly as it is zooming in on the solutions.
\end{comment}

\bibliographystyle{abbrv}
\bibliography{samir}

\end{document}

\begin{thebibliography}{}

\bibitem{BennettDahmen}
M.\ Bennett, S.\ R.\ Dahmen,
\emph{Klein forms and the generalized superelliptic equation},
Ann.\ of Math.\ {\bf 177} (2013), no.\ 1, 171--239.

\bibitem{BeGhKr}
M.\ Bennett, A.\ Gherga, and D. Kreso,
\emph{An old and new approach to Goormaghtighs equation},
Trans. Amer. Math. Soc. {\bf 373} (2020), 5707--5745.

\bibitem{BGPS}
M.\ Bennett, A.\ Gherga, V.\ Patel and S.\ Siksek,
\emph{Odd values of the Ramanujan tau function},
Math.\ Ann.\ {\bf 382} (2022), 203--238.
  %https://doi.org/10.1007/s00208-021-02241-3

\bibitem{BeGhRe}
M.\ Bennett, A.\ Gherga and A.\ Rechnitzer,
\emph{Computing elliptic curves over $\Q$},
Math.\ Comp. {\bf 88} (2019), no. 317, 1341--1390.

\bibitem{BeSiNew}
M.\ Bennett, S.\ Siksek,
\emph{Differences between perfect powers: prime power gaps},
arXiv:2110.05553v1. \edit{fix hyperlink here}

\bibitem{BeSiLN}
M.\ Bennett, S.\ Siksek,
\emph{Differences between perfect powers: the Lebesgue--Nagell equation},
arXiv:2109.09128v1. \edit{fix hyperlink here} 5,7,11

\bibitem{Magma}
W.\ Bosma, J.\ Cannon and C.\ Playoust,
\emph{The Magma Algebra System I: The User Language},
J.\ Symb.\ Comp.\ {\bf 24} (1997), 235--265.
%(See also \url{http://magma.maths.usyd.edu.au/magma/})

\bibitem{BG}
Y.\ Bugeaud and K.\ Gy\H{o}ry,
\emph{Bounds for the solutions of $S$-units},
Acta Arithmetica \textbf{LXXIV.1} (1996), 67--80.

\bibitem{BMS1}
Y.\ Bugeaud, M.\ Mignotte and S.\ Siksek,
\emph{Classical and modular approaches to exponential Diophantine equations. I.
Fibonacci and Lucas perfect powers},
Ann.\ of Math.\ (2) \textbf{163} (2006), no.\ 3,
969--1018.

\bibitem{IntegralHyp}
Y.\ Bugeaud, M.\ Mignotte, S.\ Siksek, M.\ Stoll and S.\ Tengely,
\emph{Integral points on hyperelliptic curves},
Algebra \& Number Theory \textbf{2} (2008), no.\ 8, 859--885.

\bibitem{Cangul}
I.\ N.\ Cangul, M.\ Demirci, G.\ Soydan and N.\ Tzanakis,
\emph{On the Diophantine equation $x^2 + 5^a11^b = y^n$},
Funct. Approx. {\bf 43} (2010), no.\ 2, 209--225.

\bibitem{CohenAdvanced}
H.\ Cohen,
\emph{Advanced topics in computational number theory},
GTM \textbf{138}, Springer Verlag, 2000.

\bibitem{FinckePohst}
U.\ Fincke and M.\ Pohst,
\emph{Improved methods for calculating vectors of short length in a lattice, including a complexity analysis},
Math.\ Comp. {\bf 44} (1985), no.\ 170, 463--471.

\bibitem{Homero}
H.\ R.\ Gallegos-Ruiz,
\emph{$S$-integral points on hyperelliptic curves},
Int.\ J.\ Number Theory \textbf{7} (2011), no.\ 3, 803--824.

\bibitem{Hambrook}
K.\ D.\ Hambrook,
\emph{Implementation of a Thue--Mahler equation solver},
M.Sc. Thesis, The University of British Columbia, Vancouver, 2011.

\bibitem{KimTM}
D.\ Kim,
\emph{A modular approach to cubic Thue--Mahler equations},
Math.\ Comp. \textbf{86} (2017), 1435--1471.

\bibitem{LLL}
A.\ K.\ Lenstra, H.\ W.\ Lenstra Jr. and L.\ Lovasz,
\emph{Factoring polynomials with rational coefficients},
Math.\ Ann.\ {\bf 261} (1982), 515--534.

\bibitem{Matveev}
E.\ M.\ Matveev,
\emph{An explicit lower bound for a homogeneous rational linear form in
logarithms of algebraic numbers. II},
%Izv.\ Ross.\ Akad.\ Nauk Ser.\ Mat.\ \textbf{64} (2000),
%no. 6, 125180 (in Russian); English transl.:
Izv.\ Math.\ \textbf{64} (2000), 1217--1269.

%\bibitem{Meyer}
%C.\ D.\ Meyer,
%\emph{Matrix Analysis and Applied Linear Algebra},
%Society for Industrial \& Applied Mathematics, June 2000.

\bibitem{Smart}
N.\ P.\ Smart,
\emph{The algorithmic resolution of Diophantine equations},
Cambridge University Press, 1998.

\bibitem{SoTz}
G.\ Soydan and N.\ Tzanakis,
\emph{Complete solution of the Diophantine equation
$x^2+5^a \cdot 11^b=y^n$},
Bull.\ Hellenic Math.\ Soc.\ \textbf{60} (2016), 125--151.

\bibitem{TW}
N.\ Tzanakis and B.\ M.\ M.\ de Weger,
\emph{How to explicitly solve a Thue--Mahler equation},
Compos. Math. \textbf{84} (1992), no.\ 3, 223--288.

\bibitem{Yu}
K.\ Yu,
\emph{$p$-adic logarithmic forms and group varieties. III},
Forum Math.\ \textbf{19} (2007), no.\ 2, 187--280.
\end{thebibliography}

\end{document}

\tau = -\theta,&\\
\delta_1 =
    \frac{1}{5^9} & (-22112808 \theta^{10} + 63051897 \theta^9 - 304754480\theta^8 -
        1114311375\theta^7
	 - 4082337375\theta^6
	+ 7019758750\theta^5\\
	& -
        380189340625\theta^4 + 1238365765625\theta^3
	- 8209134375000\theta^2 - 1532807421875\theta + 31061798828125),\\
\delta_2 =    \frac{1}{5^8} & (304507\theta^{10} + 1286200\theta^9 + 8286278\theta^8 +
        14744530\theta^7
	+ 120138150\theta^6 - 295735000\theta^5\\
	&-
        31769375\theta^4 - 19645671875\theta^3
	 + 1856078125\theta^2 -
        159741562500\theta + 1543269140625),\\
\delta_3 =    \frac{1}{5^8} &(15295801\theta^{10} + 96912458\theta^9 + 378787767\theta^8 -
        74723970\theta^7
	+ 1948410750\theta^6 + 29035851375\theta^5\\
	& +
        378264747500\theta^4 + 1223132203125\theta^3
	 + 3312468093750\theta^2 -
        9986249218750\theta - 9047298828125),\\
\delta_4 =    \frac{1}{5^9} &(-5876486\theta^{10} + 6204569\theta^9 - 51287665\theta^8 -
        692037425\theta^7
	+ 2371815125\theta^6 - 37673953750\theta^5\\
	& +
        144243500000\theta^4 - 1059502640625\theta^3
	+ 2955415234375\theta^2 -
        17167209375000\theta + 29184548828125),\\
\delta_5 =    \frac{1}{5^9} &(375938718\theta^{10} + 1113068513\theta^9 + 9701253830\theta^8 +
        28420450900\theta^7
	 + 337680104250\theta^6 + 897075371250\theta^5\\
	& +
        8807817215625\theta^4 + 17270145140625\theta^3
	 + 210084124843750\theta^2
        + 411927193359375\theta + 3744720025390625),\\
\delta_6 =    \frac{1}{5^9} &(3783\theta^{10} - 10047\theta^9 - 20595\theta^8 + 94800\theta^7
	 +
        2714750\theta^6 - 9815000\theta^5\\
	& + 11365625\theta^4 + 6562500\theta^3
	 +
        1218125000\theta^2 - 6610156250\theta + 7017578125),\\
\delta_7 =    \frac{1}{5^9} &(21\theta^{10} - 169\theta^9 + 680\theta^8 - 325\theta^7
	 -
        2500\theta^6 - 11875\theta^5\\
	& + 459375\theta^4 - 3640625\theta^3
	+
        20156250\theta^2 - 65625000\theta + 72265625),\\
\delta_8 =    \frac{1}{5^9} & (-2386\theta^10 - 126366\theta^9 - 363925\theta^8 +
        2473650\theta^7 - 14427125\theta^6 - 87118750\theta^5\\
	& - 55203125\theta^4
        + 281968750\theta^3 - 4114296875\theta^2 - 68742968750\theta +
        152501953125),\\
\delta_9 =    \frac{1}{5^9} & (-173\theta^{10} - 1528\theta^9 - 4840\theta^8 + 6800\theta^7+
        54125\theta^6 - 298750\theta^5\\
	& - 4609375\theta^4 - 19546875\theta^3
	-
        11953125\theta^2 + 270703125\theta + 1181640625).\\
